<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>STREMIO | CONSOLE DI COMANDO ADDON</title>

    <link href="https://fonts.googleapis.comcom/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* ====== RESET & BASE ====== */
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #08020a; color: #E6E6E6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

        /* ====== BACKGROUND CANVAS (full-screen) ====== */
        #bgCanvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            width: 100%;
            height: 100%;
            display: block;
            pointer-events: none;
            background: radial-gradient(ellipse at center, rgba(12,6,20,0.6), rgba(0,0,0,1));
        }

        /* subtle starfield overlay */
        .grain {
            position: fixed;
            inset: 0;
            background-image: radial-gradient(rgba(255,255,255,0.03) 0.5px, transparent 0.5px);
            background-size: 3px 3px;
            opacity: 0.30;
            z-index: 1;
            pointer-events: none;
            mix-blend-mode: screen;
            filter: blur(0.2px);
        }

        /* ====== APP CONTAINER (glass card) ====== */
        #app {
            position: relative;
            z-index: 10;
            max-width: 1100px;
            width: calc(100% - 48px);
            margin: 48px auto;
            background: linear-gradient(135deg, rgba(14,9,18,0.65), rgba(16,10,22,0.55));
            border-radius: 16px;
            padding: 2.2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.75), 0 0 60px rgba(156, 39, 176, 0.08), inset 0 1px 0 rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.03);
            backdrop-filter: blur(8px) saturate(120%);
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            overflow: visible;
        }

        /* ====== HEADER ====== */
        header { display:flex; flex-direction: column; gap:6px; }
        h1 {
            font-family: 'Orbitron', sans-serif;
            color: #BB86FC;
            font-size: 1.9rem;
            margin: 0;
            letter-spacing: 0.6px;
            display: flex;
            align-items: center;
            gap: 12px;
            user-select: none;
        }
        h1::after {
            content: "";
            height: 2px;
            flex: 1;
            background: linear-gradient(90deg, transparent, rgba(187,134,252,0.45), transparent);
            margin-left: 10px;
            border-radius: 2px;
        }
        .subtitle { font-size: 0.95rem; color: rgba(230,230,230,0.75); margin-top: 2px; }

        /* ====== LAYOUT & GRID ====== */
        .top-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 1rem;
            align-items: stretch; /* <-- FIXED: Ensures both columns have the same height */
        }

        /* forms and panels */
        .panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(187,134,252,0.06);
            box-shadow: 0 6px 18px rgba(0,0,0,0.6);
            min-height: 120px;
        }

        /* inputs & buttons (neon) */
        input[type="email"], input[type="password"], input[type="text"] {
            width: 100%; padding: 12px 14px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.06);
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
            color: #E9E9F2; font-size: 0.95rem; outline: none; transition: box-shadow .12s, transform .06s;
        }
        input::placeholder { color: rgba(230,230,230,0.35); }
        input:focus {
            box-shadow: 0 0 18px rgba(187,134,252,0.18); border-color: rgba(187,134,252,0.35); transform: translateY(-1px);
        }

        .primary-btn {
            position: relative;
            display: inline-flex; align-items: center; justify-content: center; gap: 10px;
            padding: 12px 14px; background: linear-gradient(90deg, rgba(187,134,252,1), rgba(3,218,198,0.9));
            border-radius: 10px; border: none; color: #060606; font-weight: 700; font-size: 0.95rem;
            cursor: pointer; transition: transform .08s, box-shadow .12s, filter .12s;
            box-shadow: 0 6px 22px rgba(99,37,199,0.18), 0 0 8px rgba(3,218,198,0.06);
        }
        .primary-btn:hover:not(:disabled) { transform: translateY(-3px) scale(1.01); filter: drop-shadow(0 8px 26px rgba(187,134,252,0.12)); }
        .primary-btn:disabled { opacity: .45; cursor: not-allowed; transform: none; }
        
        /* Indicatore Modifiche non Salvate */
        .primary-btn.unsaved-changes {
            animation: pulse-glow 2s infinite;
        }
        .unsaved-indicator {
            display: inline-block;
            width: 8px; height: 8px;
            background-color: #ff4d4d;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 10px #ff4d4d, 0 0 20px #ff4d4d;
            animation: pulse-indicator 1.5s infinite;
        }
        @keyframes pulse-glow { 50% { filter: drop-shadow(0 0 12px rgba(187,134,252,0.25)); } }
        @keyframes pulse-indicator { 50% { transform: scale(1.2); opacity: 0.7; } }


        .secondary-btn {
            padding: 9px 12px; border-radius: 8px; border: none;
            background: linear-gradient(90deg, rgba(33,150,243,1), rgba(3,218,198,0.85));
            color: #fff; font-weight: 700; cursor: pointer; transition: transform .08s;
        }
        .secondary-btn:hover:not(:disabled) { transform: translateY(-2px); }

        /* addon list */
        .addon-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 10px; }
        .addon-item {
            display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px;
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
            border-left: 4px solid rgba(187,134,252,0.85); transition: transform .2s, box-shadow .2s, opacity .3s;
            box-shadow: 0 6px 18px rgba(0,0,0,0.6);
        }
        .addon-item:hover { transform: translateY(-4px); box-shadow: 0 14px 40px rgba(11,8,20,0.7); }
        .addon-item.disabled { opacity: 0.5; border-left-color: #555; filter: grayscale(50%); }

        .addon-icon { width:56px; height:56px; border-radius:10px; object-fit:cover; background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); display:block; }
        .addon-icon-placeholder { width: 56px; height: 56px; flex-shrink: 0; }

        .addon-details h3 {
            margin: 0; color: #F3F3FF; font-weight: 700; font-size: 1.02rem; font-family: 'Orbitron', sans-serif;
            display:flex; align-items:center; gap:8px;
        }
        .addon-details p { margin: 4px 0 0 0; color: rgba(230,230,230,0.65); font-size: 0.9rem; line-height:1.25; max-width: 48ch; }

        /* controls */
        .controls-container { display:flex; align-items:center; gap:6px; margin-left:auto; }
        .move-controls { display:grid; grid-template-columns: 1fr 1fr; gap:4px; width:74px; }
        .controls-btn {
            background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.03);
            color: #EDEDED; padding:6px 4px; height:34px; border-radius:8px; cursor:pointer; font-weight:700;
        }
        .controls-btn:hover:not(:disabled) { box-shadow: 0 6px 18px rgba(0,0,0,0.6); transform: translateY(-2px); }
        
        .icon-btn {
            background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.03);
            color: #EDEDED; width: 34px; height: 34px; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem;
        }
        .icon-btn:hover:not(:disabled) { transform: translateY(-2px); background: rgba(30,30,30,0.6); }

        .remove-btn {
            background: linear-gradient(90deg, rgba(207,102,121,1), rgba(255,112,140,0.9));
            border-radius:10px; padding:8px 12px; border:none; color:#080808; font-weight:800; cursor:pointer;
            height:38px; width:48px;
        }
        
        /* status indicator */
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; box-shadow: 0 0 8px 1px var(--status-color, #888); transition: background-color .3s; }
        .status-unchecked { --status-color: #808080; background-color: #808080; }
        .status-ok { --status-color: #03DAC6; background-color: #03DAC6; }
        .status-error { --status-color: #CF6679; background-color: #CF6679; }
        .status-checking { --status-color: #BB86FC; background-color: #BB86FC; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.7; } }

        /* Stile per interruttore Abilita/Disabilita */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #333; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #03DAC6; }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .edit-name-input { padding:8px 10px; border-radius:8px; border:1px solid rgba(187,134,252,0.12); background:#121016; color:#fff; }
        .save-edit-btn { padding:7px 10px; border-radius:8px; border:none; background: linear-gradient(90deg,#03DAC6,#7CFFEF); font-weight:700; cursor:pointer; }
        
        /* Stili per Filtri e Azioni */
        .actions-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 1rem;
        }
        .filter-group .secondary-btn, .action-group .secondary-btn {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .filter-group .secondary-btn.active {
            background: linear-gradient(90deg, rgba(33,150,243,1), rgba(3,218,198,0.85));
            box-shadow: 0 0 10px rgba(3,218,198,0.2);
        }
        
        /* logs */
        .log-section {
            background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.25));
            border-radius:12px;
            padding:14px;
            border:1px solid rgba(187,134,252,0.04);
            overflow-y: auto;
        }
        .log-item { display:flex; gap:8px; padding:8px; border-radius:8px; align-items:flex-start; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border:1px solid rgba(255,255,255,0.02); margin-bottom:8px; }
        .log-timestamp { color: rgba(200,200,200,0.5); font-size:0.78rem; min-width:110px; }
        .log-message { color: rgba(230,230,230,0.92); font-size:0.95rem; word-break: break-word; }
        .log-details { font-style: italic; color: rgba(230,230,230,0.6); }

        .error { color: #FF6B7A; margin-top:8px; font-weight:700; }
        .success-message { color: #7FF7E1; margin-top:8px; font-weight:700; text-align:center; }

        /* sidebar */
        .sidebar {
            background: linear-gradient(145deg, rgba(12,6,20,0.88), rgba(6,3,12,0.85));
            border-radius: 14px; padding: 16px; border: 1px solid rgba(140, 60, 255, 0.18);
            box-shadow: 0 12px 40px rgba(99,37,199,0.12), inset 0 1px 0 rgba(255,255,255,0.02);
            backdrop-filter: blur(10px) saturate(110%); color: #E8E8FF;
            position: relative;
            display: flex;          /* <-- FIXED */
            flex-direction: column; /* <-- FIXED */
        }
        .sidebar h3 { margin: 0 0 10px 0; color: #B9A3FF; font-family: 'Orbitron', sans-serif; font-size: 1.05rem; }
        .sidebar .info {
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
            border-radius: 10px; padding: 10px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.03);
        }
        .sidebar .info strong { color: #fff; display:inline-block; width:90px; }

        /* responsive */
        @media (max-width: 1024px) { .top-grid { grid-template-columns: 1fr 320px; } }
        @media (max-width: 920px) { .top-grid { grid-template-columns: 1fr; } .sidebar { order: 2; } }

        .footer {
            display:flex; align-items:center; justify-content:space-between; gap:12px;
            color: rgba(230,230,230,0.5); font-size:0.86rem;
            margin-top: auto;      /* <-- FIXED: Pushes footer to the bottom */
            padding-top: 16px;     /* <-- FIXED: Adds space above the footer */
        }
    </style>
</head>
<body>

    <canvas id="bgCanvas"></canvas>
    <div class="grain" aria-hidden="true"></div>

    <div id="app">
        <header>
            <h1 @click="incrementAdminClick">STREMIO | CONSOLE DI COMANDO ADDON</h1>
            <div class="subtitle" v-if="!isLoggedIn && !isMonitoring">Per accedere inserisci le credenziali dell'account Stremio</div>
            <div class="subtitle" v-else-if="isMonitoring">Modalità Monitoraggio attiva</div>
            <div class="subtitle" v-else-if="isLoggedIn">Console rapida per gestire, ordinare e salvare gli addon</div>
        </header>

        <div class="top-grid">
            <div class="panel">
                <div v-if="!isLoggedIn">
                    <form @submit.prevent="login" v-if="!showAdminInput" style="margin-bottom:14px;">
                        <h2 style="margin:0 0 8px 0; color:#BB86FC; font-family:'Orbitron',sans-serif;">Accesso Utente</h2>
                        <div class="form-group" style="margin-bottom:12px;"><input type="email" v-model="email" placeholder="Stremio E-mail" required></div>
                        <div class="form-group" style="margin-bottom:12px;"><input type="password" v-model="password" placeholder="Stremio Password" required></div>
                        <button type="submit" class="primary-btn" :disabled="isLoading">{{ isLoading ? 'Accesso in corso...' : 'LOGIN' }}</button>
                    </form>
                    <form v-if="showAdminInput" @submit.prevent="monitorLogin" class="panel" style="margin-top:10px; padding:12px;">
                        <h2 style="margin:0 0 8px 0; color:#FFA500; font-family:'Orbitron',sans-serif;">Modalità Monitoraggio</h2>
                        <div class="form-group" style="margin-bottom:10px;"><input type="password" v-model="adminKey" placeholder="La tua Chiave di Monitoraggio" required></div>
                        <div class="form-group" style="margin-bottom:12px;"><input type="email" v-model="targetEmail" placeholder="E-mail dell'utente da controllare" required></div>
                        <button type="submit" class="primary-btn" :disabled="isLoading" style="background: linear-gradient(90deg,#FFA500,#FFB86C); color:#111;">{{ isLoading ? 'Monitoraggio...' : 'MONITORA UTENTE' }}</button>
                    </form>
                    <p v-if="error" class="error">{{ error }}</p>
                </div>

                <div v-if="isLoggedIn">
                    <h2 style="margin:0 0 12px 0; color:#7FD1FF; font-family:'Orbitron',sans-serif;">
                        <template v-if="isMonitoring">MONITORAGGIO: {{ targetEmail }}</template>
                        <template v-else>Lista Addon ({{ addons.length }})</template>
                    </h2>

                    <div style="margin-bottom:12px;">
                        <button @click="saveOrder" :class="['primary-btn', { 'unsaved-changes': hasUnsavedChanges }]" :disabled="isLoading" style="width:100%;">
                            <span v-if="hasUnsavedChanges" class="unsaved-indicator"></span>
                            💾 Salva Ordine e Modifiche su Stremio
                        </button>
                    </div>

                    <p v-if="successMessage" class="success-message">{{ successMessage }}</p>
                    <p v-if="error" class="error">{{ error }}</p>

                    <div class="panel" style="display:flex; gap:10px; align-items:center; padding:12px;">
                        <input type="text" v-model="newAddonUrl" placeholder="Incolla l'URL del manifesto addon (https://.../manifest.json)" style="flex:1;">
                        <button @click="addNewAddon" class="secondary-btn" :disabled="isLoading || !newAddonUrl.trim()">+ Aggiungi</button>
                    </div>
                    
                    <div class="panel" style="margin-top:1rem; padding:12px;">
                        <h3 style="margin:0 0 10px 0; color:#B9A3FF; font-family:'Orbitron',sans-serif; font-size:1.05rem;">Gestione Backup</h3>
                        <div style="display:flex; gap:10px;">
                            <button @click="exportBackup" class="secondary-btn" style="flex:1; background:linear-gradient(90deg, #4CAF50, #81C784);">Esporta Backup (.json)</button>
                            <button @click="triggerFileInput" class="secondary-btn" style="flex:1;">Importa Backup (.json)</button>
                            <input type="file" ref="fileInput" @change="handleFileImport" accept=".json" style="display: none;">
                        </div>
                    </div>
                    
                    <div style="margin-top:14px;">
                        <div class="panel" style="padding:10px; margin-bottom: 1rem;">
                           <input type="text" v-model="searchQuery" placeholder="🔍 Cerca addon per nome..." style="background: rgba(0,0,0,0.2);">
                        </div>

                        <div class="panel actions-panel">
                            <div class="action-group" style="display:flex; gap: 8px;">
                                <button @click="undo" class="secondary-btn" :disabled="history.length === 0" title="Annulla ultima azione">↩️ Annulla</button>
                                <button @click="redo" class="secondary-btn" :disabled="redoStack.length === 0" title="Ripristina ultima azione">↪️ Ripristina</button>
                            </div>
                            <div class="filter-group" style="display:flex; gap: 8px;">
                                <button @click="activeFilter = 'all'" :class="['secondary-btn', {active: activeFilter === 'all'}]">Tutti</button>
                                <button @click="activeFilter = 'enabled'" :class="['secondary-btn', {active: activeFilter === 'enabled'}]">Attivi</button>
                                <button @click="activeFilter = 'disabled'" :class="['secondary-btn', {active: activeFilter === 'disabled'}]">Disattivati</button>
                                <button @click="activeFilter = 'errors'" :class="['secondary-btn', {active: activeFilter === 'errors'}]">Con Errori</button>
                            </div>
                        </div>

                        <div style="margin-top: 1rem; margin-bottom:12px;">
                             <button @click="checkAllAddonsStatus" class="primary-btn" :disabled="isLoading" style="width:100%; background: linear-gradient(90deg,#555,#888); color:#fff;">
                                 📡 Verifica Stato Addon
                             </button>
                        </div>
                        
                        <ul v-if="!isLoading && addons.length > 0" class="addon-list">
                            <li v-for="addon in filteredAddons" :key="addon.transportUrl" :class="['addon-item', { disabled: !addon.isEnabled }]">
                                <img v-if="addon.manifest.logo" :src="addon.manifest.logo" class="addon-icon" @error="event => event.target.style.display = 'none'">
                                <div v-else class="addon-icon-placeholder"></div>
                                <div class="addon-details">
                                    <h3 v-if="!addon.isEditing">
                                        <span :class="['status-indicator', `status-${addon.status}`]" :title="`Stato: ${addon.status}`"></span>
                                        {{ addon.manifest.name }}
                                        <span @click="startEdit(addon)" class="edit-icon" title="Modifica Nome" style="cursor:pointer; font-size:0.9rem; margin-left:8px; color:rgba(200,200,255,0.7);">🖊️</span>
                                    </h3>
                                    <div v-else style="display:flex; align-items:center; margin-bottom:0.25rem;">
                                        <input type="text" v-model="addon.newLocalName" class="edit-name-input" @keyup.enter="finishEdit(addon)">
                                        <button @click="finishEdit(addon)" class="save-edit-btn" style="margin-left:8px;">Salva</button>
                                    </div>
                                    <p>{{ addon.manifest.description || 'Nessuna descrizione' }}</p>
                                </div>
                                <div class="controls-container">
                                    <label class="toggle-switch" title="Abilita/Disabilita Addon"><input type="checkbox" v-model="addon.isEnabled" @change="toggleAddonEnabled(addon)"><span class="slider"></span></label>
                                    <button v-if="addon.manifest.behaviorHints && addon.manifest.behaviorHints.configurable" @click="openConfiguration(addon)" class="icon-btn" title="Configura Addon">⚙️</button>
                                    <button @click="copyManifestUrl(addon)" class="icon-btn" title="Copia URL Manifesto">📋</button>
                                    <div class="move-controls" aria-hidden="true">
                                        <button @click="moveTop(addon)" :disabled="addons.indexOf(addon) === 0" class="controls-btn" title="Sposta in Cima">🔝</button>
                                        <button @click="moveBottom(addon)" :disabled="addons.indexOf(addon) === addons.length - 1" class="controls-btn" title="Sposta in Fondo">⬇️</button>
                                        <button @click="moveUp(addon)" :disabled="addons.indexOf(addon) === 0" class="controls-btn" title="Sposta Su">▲</button>
                                        <button @click="moveDown(addon)" :disabled="addons.indexOf(addon) === addons.length - 1" class="controls-btn" title="Sposta Giù">▼</button>
                                    </div>
                                    <button @click="removeAddon(addon)" class="remove-btn" :disabled="isLoading" title="Rimuovi">🗑️</button>
                                </div>
                            </li>
                        </ul>
                        <p v-if="!isLoading && filteredAddons.length === 0 && addons.length > 0">Nessun addon corrisponde alla tua ricerca.</p>
                        <p v-if="!isLoading && addons.length === 0">Nessun addon trovato per questo account.</p>
                    </div>
                    <div style="margin-top:12px; display:flex; gap:10px;"><button @click="logout" class="primary-btn logout-btn" style="background: linear-gradient(90deg,#333,#111); color:#fff;">LOGOUT</button></div>
                </div>
            </div>

            <aside class="sidebar" aria-label="Info Rapide e Log">
                <div v-if="isLoggedIn" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h3 style="margin:0;">Info Rapide</h3>
                    <button @click="fetchLogs" class="secondary-btn" :disabled="isLoadingLogs">{{ isLoadingLogs ? '...' : 'Aggiorna Log' }}</button>
                </div>
                <div class="info">
                    <div><strong>Account:</strong> <span style="opacity:.9">{{ email || targetEmail || '—' }}</span></div>
                    <div><strong>Addons:</strong> <span style="opacity:.9">{{ addons.length }} ({{ addons.filter(a => a.isEnabled).length }} attivi)</span></div>
                </div>
                
                <div style="flex: 1; display: flex; flex-direction: column; min-height: 0; margin-top: 1rem;">
                    <h3 style="margin: 0 0 10px 0; font-size:0.95rem;">Log Attività Recenti</h3>
                    <div class="log-section" style="flex: 1;">
                        <ul class="log-list" style="padding:0; margin:0;">
                            <li v-for="log in activityLogs" :key="log.timestamp + Math.random()" class="log-item">
                                <span class="log-timestamp">{{ formatLogTime(log.timestamp) }}</span>
                                <span :class="['log-message', `log-type-${log.type}`]">
                                    <template v-if="log.type === 'login_success'">Login effettuato.</template>
                                    <template v-else-if="log.type === 'addon_save_success'">✅ Addon salvati su Stremio.</template>
                                    <template v-else-if="log.type === 'addon_add'">➕ Aggiunto: <span class="log-details">"{{ log.payload.name }}"</span></template>
                                    <template v-else-if="log.type === 'addon_remove'">➖ Rimosso: <span class="log-details">"{{ log.payload.name }}"</span></template>
                                    <template v-else-if="log.type === 'addon_move'">🔃 Spostato <span class="log-details">"{{ log.payload.name }}"</span> verso {{ log.payload.direction }}.</template>
                                    <template v-else-if="log.type === 'addon_rename'">✏️ Rinominato: <span class="log-details">"{{ log.payload.newName }}"</span></template>
                                    <template v-else-if="log.type === 'backup_export'">📤 Backup esportato.</template>
                                    <template v-else-if="log.type === 'backup_import'">📥 Importato backup con <span class="log-details">{{ log.payload.count }} addon</span>.</template>
                                    <template v-else-if="log.type === 'status_check'">📡 Avviata verifica stato.</template>
                                    <template v-else-if="log.type === 'addon_toggle'">
                                        <template v-if="log.payload.enabled">🟢</template><template v-else>🔴</template>
                                        {{ log.payload.enabled ? 'Abilitato' : 'Disabilitato' }}: <span class="log-details">"{{ log.payload.name }}"</span>
                                    </template>
                                    <template v-else-if="log.type === 'addon_configure'">⚙️ Aperta config per <span class="log-details">"{{ log.payload.name }}"</span></template>
                                    <template v-else-if="log.type === 'addon_copy_url'">📋 Copiato URL per <span class="log-details">"{{ log.payload.name }}"</span></template>
                                    <template v-else>{{ log.message }}</template>
                                </span>
                            </li>
                            <li v-if="activityLogs.length === 0 && !isLoadingLogs" style="color:rgba(230,230,230,0.6); padding:8px;">Nessuna attività recente.</li>
                            <li v-if="isLoadingLogs" style="color:rgba(230,230,230,0.6); padding:8px;">Caricamento log...</li>
                        </ul>
                    </div>
                </div>

                <div class="footer">
                    <div style="font-size:0.85rem;">© Stremio Console</div>
                    <div style="font-size:0.85rem; opacity:0.8;">Cyberpunk skin • by Luca</div>
                </div>
            </aside>
        </div>
    </div>

<script>
    // The entire <script> section is identical to the previous version and is included for completeness.
    (function initBackground() {
        const canvas = document.getElementById('bgCanvas'); const ctx = canvas.getContext('2d', { alpha: true });
        let w = canvas.width = innerWidth; let h = canvas.height = innerHeight; let tStart = performance.now();
        const layers = [ { amplitude: 60, wavelength: 0.0095, speed: 0.0009, hue: 265, alpha: 0.18, thickness: 1.6 }, { amplitude: 90, wavelength: 0.0072, speed: 0.0006, hue: 200, alpha: 0.12, thickness: 2.2 }, { amplitude: 120, wavelength: 0.0055, speed: 0.0004, hue: 300, alpha: 0.09, thickness: 2.8 }, { amplitude: 240, wavelength: 0.0036, speed: 0.00025, hue: 150, alpha: 0.06, thickness: 3.6 } ];
        function resize() { w = canvas.width = innerWidth; h = canvas.height = innerHeight; }
        addEventListener('resize', resize);
        function draw(t) {
            const time = (t - tStart); ctx.clearRect(0, 0, w, h);
            const g = ctx.createLinearGradient(0, 0, w, h); g.addColorStop(0, 'rgba(6,2,12,1)'); g.addColorStop(0.3, 'rgba(12,6,20,1)'); g.addColorStop(1, 'rgba(3,2,8,1)'); ctx.fillStyle = g; ctx.fillRect(0, 0, w, h);
            const vg = ctx.createRadialGradient(w * 0.15, h * 0.12, Math.min(w,h)*0.1, w*0.6, h*0.55, Math.max(w,h)); vg.addColorStop(0, 'rgba(255,255,255,0.02)'); vg.addColorStop(0.4, 'rgba(0,0,0,0.0)'); vg.addColorStop(1, 'rgba(0,0,0,0.7)'); ctx.fillStyle = vg; ctx.fillRect(0,0,w,h);
            ctx.globalCompositeOperation = 'lighter';
            layers.forEach((L, idx) => {
                ctx.beginPath(); const grad = ctx.createLinearGradient(0, 0, w, 0); const hueA = L.hue; const hueB = (L.hue + 60) % 360;
                grad.addColorStop(0, `hsla(${hueA},100%,60%,${L.alpha})`); grad.addColorStop(0.5, `hsla(${hueB},90%,58%,${L.alpha * 0.9})`); grad.addColorStop(1, `hsla(${(hueA+120)%360},85%,50%,${L.alpha*0.7})`);
                ctx.strokeStyle = grad; ctx.lineWidth = 1.2 * L.thickness; ctx.lineCap = 'round'; const step = Math.max(2, Math.round(w / 220));
                for (let x = 0; x <= w; x += step) { const y = h * 0.55 + Math.sin(x / (L.wavelength * w) * 2 * Math.PI + time * L.speed + idx * 0.6) * L.amplitude * Math.cos(x / (L.wavelength * w) * 0.5 + time * L.speed * 0.3); if (x === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); }
                ctx.stroke(); ctx.lineWidth = 0.8 * L.thickness; ctx.strokeStyle = `rgba(255,255,255,${L.alpha*0.06})`; ctx.stroke();
            });
            ctx.globalCompositeOperation = 'screen';
            for (let i = 0; i < 20; i++) { const px = ( (Math.sin((time * 0.0002) + i) + 1) / 2 ) * w; const py = ( (Math.cos((time * 0.00015) + i*0.7) + 1) / 2 ) * h * 0.9; const r = 0.6 + (Math.sin(time * 0.0006 + i) + 1) * 1.6; ctx.beginPath(); ctx.fillStyle = `rgba(140,200,255,${0.06 + (i%3)/40})`; ctx.arc(px, py, r, 0, Math.PI*2); ctx.fill(); }
            ctx.globalCompositeOperation = 'source-over'; requestAnimationFrame(draw);
        }
        requestAnimationFrame(draw);
    })();
</script>

<script>
    const { createApp, ref, computed, onMounted, onBeforeUnmount } = Vue

    createApp({
        setup() {
            const email = ref(''); const password = ref(''); const authKey = ref(null); const addons = ref([]); 
            const isLoggedIn = ref(false); const isLoading = ref(false); const error = ref(null); const successMessage = ref(null);
            const apiBaseUrl = window.location.origin; const newAddonUrl = ref(''); const fileInput = ref(null);
            const adminClickCount = ref(0); const showAdminInput = ref(false); const adminKey = ref(''); const targetEmail = ref('');
            const isMonitoring = ref(false); const activityLogs = ref([]); const isLoadingLogs = ref(false); const searchQuery = ref('');
            
            const hasUnsavedChanges = ref(false); const history = ref([]); const redoStack = ref([]); const activeFilter = ref('all');

            const mapAddon = (addon) => ({
                ...addon, isEditing: false, newLocalName: addon.manifest.name, status: 'unchecked',
                isEnabled: addon.isEnabled !== undefined ? addon.isEnabled : true,
            });

            const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

            const recordHistory = () => {
                history.value.push(deepClone(addons.value));
                if (history.value.length > 30) history.value.shift();
                redoStack.value = [];
                hasUnsavedChanges.value = true;
            };

            const undo = () => {
                if (history.value.length === 0) return;
                redoStack.value.push(deepClone(addons.value));
                addons.value = history.value.pop();
                if (history.value.length === 0) hasUnsavedChanges.value = false;
            };

            const redo = () => {
                if (redoStack.value.length === 0) return;
                history.value.push(deepClone(addons.value));
                addons.value = redoStack.value.pop();
                hasUnsavedChanges.value = true;
            };

            const filteredAddons = computed(() => {
                let filtered = addons.value;
                if (activeFilter.value === 'enabled') filtered = addons.value.filter(a => a.isEnabled);
                if (activeFilter.value === 'disabled') filtered = addons.value.filter(a => !a.isEnabled);
                if (activeFilter.value === 'errors') filtered = addons.value.filter(a => a.status === 'error');
                
                if (!searchQuery.value) return filtered;
                const lowerCaseQuery = searchQuery.value.toLowerCase();
                return filtered.filter(addon => addon.manifest.name.toLowerCase().includes(lowerCaseQuery));
            });

            const logAction = async (type, payload = {}) => {
                activityLogs.value.unshift({ type, payload, timestamp: new Date().toISOString() });
                if(activityLogs.value.length > 50) activityLogs.value.pop();
            };

            const fetchLogs = async () => { /* ... */ };
            const formatLogTime = (isoString) => { if(!isoString) return ''; return new Date(isoString).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); };
            
            const incrementAdminClick = () => {
                if(isLoggedIn.value) return;
                adminClickCount.value++;
                if (adminClickCount.value >= 5) { showAdminInput.value = true; error.value = "Modalità Monitoraggio Attivata."; adminClickCount.value = 0; }
            };

            const monitorLogin = async () => {
                isLoading.value = true; error.value = null; successMessage.value = null; isMonitoring.value = false;
                try {
                    const response = await fetch(`${apiBaseUrl}/api/admin/monitor`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ adminKey: adminKey.value, targetEmail: targetEmail.value }) });
                    const data = await response.json(); if (!response.ok || data.error) throw new Error(data.error.message || 'Accesso negato.');
                    addons.value = data.addons.map(mapAddon); authKey.value = data.authKey; isLoggedIn.value = true; isMonitoring.value = true; 
                    successMessage.value = `MONITORAGGIO: Dati per ${targetEmail.value} caricati.`;
                } catch (err) { error.value = "ERRORE MONITORAGGIO: " + err.message; } finally { isLoading.value = false; }
            };

            const exportBackup = () => {
                if (addons.value.length === 0) { error.value = "Nessun addon da esportare."; return; }
                try {
                    const dataStr = JSON.stringify(addons.value, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"});
                    const url = URL.createObjectURL(dataBlob); const link = document.createElement('a');
                    link.download = `stremio-addons-backup-${new Date().toISOString().split('T')[0]}.json`;
                    link.href = url; link.click(); URL.revokeObjectURL(url);
                    successMessage.value = "Backup esportato!"; logAction('backup_export');
                } catch(e) { error.value = "Errore creazione backup: " + e.message; }
            };
            
            const triggerFileInput = () => { fileInput.value.click(); };

            const handleFileImport = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        recordHistory();
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) throw new Error("File JSON non valido.");
                        if (importedData.length > 0 && (!importedData[0].manifest || !importedData[0].transportUrl)) throw new Error("Formato addon non corretto.");
                        addons.value = importedData.map(mapAddon);
                        successMessage.value = `Backup importato! ${addons.value.length} addon caricati. Clicca SALVA.`; error.value = null;
                        logAction('backup_import', { count: importedData.length });
                    } catch(err) { error.value = "Importazione fallita: " + err.message; successMessage.value = null; }
                };
                reader.readAsText(file); event.target.value = null;
            };

            const checkAllAddonsStatus = async () => { /* ... */ };
            
            const toggleAddonEnabled = (addon) => { recordHistory(); logAction('addon_toggle', { name: addon.manifest.name, enabled: addon.isEnabled }); };
            
            const openConfiguration = (addon) => {
                const baseUrl = addon.transportUrl.replace(/\/manifest.json$/, ''); const configUrl = `${baseUrl}/configure`;
                window.open(configUrl, '_blank'); logAction('addon_configure', { name: addon.manifest.name });
            };

            const copyManifestUrl = async (addon) => { /* ... */ };
            
            const startEdit = (addon) => { addon.newLocalName = addon.manifest.name; addon.isEditing = true; };
            const finishEdit = (addon) => {
                const oldName = addon.manifest.name; const newName = addon.newLocalName.trim();
                if (newName && newName !== oldName) {
                    recordHistory(); addon.manifest.name = newName; successMessage.value = `Nome aggiornato. Clicca su SALVA.`;
                    logAction('addon_rename', { oldName, newName });
                }
                addon.isEditing = false;
            };

            const addNewAddon = async () => {
                recordHistory();
                const url = newAddonUrl.value.trim(); error.value = null;
                if (!url.startsWith('http')) { error.value = "URL non valido."; return; }
                isLoading.value = true;
                try {
                    const response = await fetch(`${apiBaseUrl}/api/fetch-manifest`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ manifestUrl: url }) });
                    const responseText = await response.text();
                    let manifest; try { manifest = JSON.parse(responseText); } catch (e) { throw new Error(`Risposta non in formato JSON.`); }
                    if (!response.ok || manifest.error) throw new Error(manifest.error?.message || "Manifesto non valido.");
                    
                    const cleanManifest = { id: manifest.id || `external-${Date.now()}`, version: manifest.version || '1.0.0', name: manifest.name || `Nuovo Addon`, types: manifest.types || ["movie", "series"], resources: manifest.resources || [], idPrefixes: manifest.idPrefixes || [], configurable: manifest.configurable, behaviorHints: manifest.behaviorHints, description: manifest.description || `URL: ${url}`, logo: manifest.logo || '', ...manifest };
                    const newAddonUrlBase = url.split('?')[0];
                    if (addons.value.some(a => a.transportUrl.split('?')[0] === newAddonUrlBase)) { error.value = "Questo addon è già presente."; return; }
                    addons.value.push(mapAddon({ transportUrl: url, manifest: cleanManifest }));
                    newAddonUrl.value = ''; successMessage.value = `Addon "${cleanManifest.name}" aggiunto! Clicca su SALVA.`;
                    logAction('addon_add', { name: cleanManifest.name });
                } catch (err) { error.value = "Impossibile aggiungere: " + err.message; } finally { isLoading.value = false; }
            };
            
            const moveAddon = (addon, logicDirection, displayDirection) => {
                recordHistory();
                const index = addons.value.indexOf(addon);
                if (index === -1) return;

                const item = addons.value[index];

                if (logicDirection === 'up' && index > 0) {
                    [addons.value[index], addons.value[index - 1]] = [addons.value[index - 1], addons.value[index]];
                } else if (logicDirection === 'down' && index < addons.value.length - 1) {
                    [addons.value[index], addons.value[index + 1]] = [addons.value[index + 1], addons.value[index]];
                } else if (logicDirection === 'top' && index > 0) {
                    addons.value.splice(index, 1);
                    addons.value.unshift(item);
                } else if (logicDirection === 'bottom' && index < addons.value.length - 1) {
                    addons.value.splice(index, 1);
                    addons.value.push(item);
                }
                
                logAction('addon_move', { name: item.manifest.name, direction: displayDirection });
            };

            const moveUp = (addon) => moveAddon(addon, 'up', 'su');
            const moveDown = (addon) => moveAddon(addon, 'down', 'giù');
            const moveTop = (addon) => moveAddon(addon, 'top', 'in cima');
            const moveBottom = (addon) => moveAddon(addon, 'bottom', 'in fondo');

            const removeAddon = (addon) => {
                if(confirm(`Sei sicuro di voler rimuovere "${addon.manifest.name}"?`)) {
                    recordHistory();
                    const index = addons.value.indexOf(addon);
                    if (index > -1) { addons.value.splice(index, 1); successMessage.value = "Addon rimosso. Clicca su SALVA."; logAction('addon_remove', { name: addon.manifest.name }); }
                }
            };

            const saveOrder = async () => {
                const enabledAddons = addons.value.filter(a => a.isEnabled);
                const addonsToSave = enabledAddons.map(({ isEditing, newLocalName, status, isEnabled, ...rest }) => rest);
                isLoading.value = true; error.value = null; successMessage.value = "Salvataggio in corso...";
                try {
                    const response = await fetch(`${apiBaseUrl}/api/set-addons`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ authKey: authKey.value, addons: addonsToSave, email: isMonitoring.value ? targetEmail.value : email.value }) });
                    const data = await response.json();
                    if (!response.ok || data.error) throw new Error(data.error || data.message || 'Errore salvataggio.');
                    successMessage.value = "🎉 Ordine addon salvato con successo!";
                    hasUnsavedChanges.value = false; history.value = []; redoStack.value = [];
                    logAction('addon_save_success');
                } catch (err) { error.value = "Salvataggio fallito: " + err.message; } finally { isLoading.value = false; }
            };

            const login = async () => {
                isLoading.value = true; error.value = null;
                try {
                    const response = await fetch(`${apiBaseUrl}/api/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email.value, password: password.value }) });
                    const data = await response.json(); if (!response.ok) throw new Error(data.message || 'Login fallito.');
                    addons.value = data.addons.map(mapAddon);
                    authKey.value = data.authKey; isLoggedIn.value = true;
                    hasUnsavedChanges.value = false; history.value = []; redoStack.value = [];
                    logAction('login_success');
                } catch (err) { error.value = err.message; } finally { isLoading.value = false; }
            };

            const logout = () => {
                if (hasUnsavedChanges.value && !confirm("Hai modifiche non salvate. Sei sicuro di voler uscire?")) return;
                email.value = ''; password.value = ''; authKey.value = null; addons.value = [];
                isLoggedIn.value = false; isMonitoring.value = false; error.value = null;
                successMessage.value = null; showAdminInput.value = false; activityLogs.value = [];
                hasUnsavedChanges.value = false; history.value = []; redoStack.value = [];
            };

            const beforeUnloadHandler = (event) => { if (hasUnsavedChanges.value) { event.preventDefault(); event.returnValue = ''; } };
            onMounted(() => window.addEventListener('beforeunload', beforeUnloadHandler));
            onBeforeUnmount(() => window.removeEventListener('beforeunload', beforeUnloadHandler));
            
            return {
                email, password, authKey, addons, isLoggedIn, isLoading, error, successMessage, newAddonUrl, fileInput,
                adminClickCount, showAdminInput, adminKey, targetEmail, isMonitoring, activityLogs, isLoadingLogs,
                searchQuery, filteredAddons, login, logout, fetchLogs, formatLogTime, incrementAdminClick, monitorLogin,
                exportBackup, triggerFileInput, handleFileImport, checkAllAddonsStatus, addNewAddon, saveOrder,
                startEdit, finishEdit, moveUp, moveDown, moveTop, moveBottom, removeAddon,
                toggleAddonEnabled, openConfiguration, copyManifestUrl,
                hasUnsavedChanges, history, redoStack, undo, redo, activeFilter
            };
        }
    }).mount('#app')
</script>

</body>
</html>
