<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <!-- VIEWPORT META TAG (ESSENZIALE PER IL MOBILE) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- Il titolo ora è dinamico in base alla lingua -->
    <title>{{ t('meta.title') }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/vuedraggable@next/dist/vuedraggable.umd.js"></script>
    <!-- Libreria per comprimere/decomprimere stringhe per URL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    
    <!-- Libreria Tour Guidato (Intro.js) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.min.js"></script>

    <style>
        /* ====== RESET & BASE ====== */
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #08020a; color: #E6E6E6; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
         /* ====== BACKGROUND CANVAS (full-screen) ====== */
         #bgCanvas { position: fixed; inset: 0; z-index: 0; width: 100%; height: 100%; display: block; pointer-events: none; background: radial-gradient(ellipse at center, rgba(12,6,20,0.6), rgba(0,0,0,1)); }
         /* subtle starfield overlay */
         .grain { position: fixed; inset: 0; background-image: radial-gradient(rgba(255,255,255,0.03) 0.5px, transparent 0.5px); background-size: 3px 3px; opacity: 0.30; z-index: 1; pointer-events: none; mix-blend-mode: screen; filter: blur(0.2px); }
         /* ====== APP CONTAINER (glass card) ====== */
         #app {
             position: relative;
             z-index: 10;
             max-width: 1100px;
             width: calc(100% - 48px);
             margin: 48px auto;
             background: linear-gradient(135deg, rgba(14,9,18,0.65), rgba(16,10,22,0.55));
             border-radius: 16px;
             padding: 2.2rem;
             box-shadow: 0 10px 40px rgba(0,0,0,0.75), 0 0 60px rgba(156, 39, 176, 0.08), inset 0 1px 0 rgba(255,255,255,0.02);
             border: 1px solid rgba(255,255,255,0.03);
             backdrop-filter: blur(8px) saturate(120%);
             display: grid;
             grid-template-columns: 1fr; /* Colonna singola di base */
             gap: 1.5rem;
             overflow: hidden; /* Modificato: Nasconde overflow orizzontale */
         }
         /* Layout a due colonne per schermi più grandi */
         @media (min-width: 960px) { /* Aumentato leggermente il breakpoint */
              #app {
                   grid-template-columns: minmax(0, 1fr) 300px; /* Colonna principale + Colonna Statistiche */
                   grid-template-rows: auto 1fr; /* Riga per header, riga per contenuto */
                   gap: 1.5rem 2rem; /* Gap riga, gap colonna */
                   overflow: visible; /* Ripristina overflow */
              }
              header {
                   grid-column: 1 / 2; /* Header nella colonna principale, prima riga */
                   grid-row: 1 / 2;
              }
              .main-content {
                   grid-column: 1 / 2; /* Contenuto principale sotto l'header */
                   grid-row: 2 / 3;
                   min-height: 0; /* Necessario per flex/grid figli */
                   overflow-y: auto; /* Permette scroll verticale se necessario */
                   padding-right: 10px; /* Spazio per scrollbar */
              }
              .stats-panel-container {
                   grid-column: 2 / 3; /* Colonna destra */
                   grid-row: 1 / span 2; /* Occupa entrambe le righe */
                   position: sticky; /* Rende il pannello sticky */
                   top: 48px; /* Offset dall'alto pari al margine di #app */
                   height: calc(100vh - 96px); /* Altezza massima per sticky */
                   overflow-y: auto; /* Scroll interno se necessario */
              }
         }
         /* ====== HEADER ====== */
         header { display:flex; flex-direction: column; gap:6px; position: relative; }
         h1 { font-family: 'Orbitron', sans-serif; color: #BB86FC; font-size: 1.9rem; margin: 0; letter-spacing: 0.6px; display: flex; align-items: center; gap: 12px; user-select: none; }
         h1::after { content: ""; height: 2px; flex: 1; background: linear-gradient(90deg, transparent, rgba(187,134,252,0.45), transparent); margin-left: 10px; border-radius: 2px; }
         .subtitle { font-size: 0.95rem; color: rgba(230,230,230,0.75); margin-top: 2px; }
         .instructions-btn { position: absolute; top: 0px; right: 0px; background: rgba(187,134,252,0.1); border: 1px solid rgba(187,134,252,0.2); color: #BB86FC; width: 36px; height: 36px; border-radius: 50%; font-size: 1.3rem; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 0 10px rgba(187,134,252,0.1); }
         .instructions-btn:hover { background: rgba(187,134,252,0.2); box-shadow: 0 0 15px rgba(187,134,252,0.3); transform: scale(1.05); }
         /* forms and panels */
         .panel { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); border-radius: 12px; padding: 16px; border: 1px solid rgba(187,134,252,0.06); box-shadow: 0 6px 18px rgba(0,0,0,0.6); min-height: auto; /* Modificato: altezza automatica */}
         /* inputs & buttons (neon) */
         input[type="email"], input[type="password"], input[type="text"] { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.06); background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); color: #E9E9F2; font-size: 0.95rem; outline: none; transition: box-shadow .12s, transform .06s; }
         input::placeholder { color: rgba(230,230,230,0.35); }
         input:focus { box-shadow: 0 0 18px rgba(187,134,252,0.18); border-color: rgba(187,134,252,0.35); transform: translateY(-1px); }
         .primary-btn { position: relative; display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 14px; background: linear-gradient(90deg, rgba(187,134,252,1), rgba(3,218,198,0.9)); border-radius: 10px; border: none; color: #060606; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: transform .08s, box-shadow .12s, filter .12s; box-shadow: 0 6px 22px rgba(99,37,199,0.18), 0 0 8px rgba(3,218,198,0.06); }
         .primary-btn:hover:not(:disabled) { transform: translateY(-3px) scale(1.01); filter: drop-shadow(0 8px 26px rgba(187,134,252,0.12)); }
         .primary-btn:disabled { opacity: .45; cursor: not-allowed; transform: none; }
         .primary-btn.unsaved-changes { animation: pulse-glow 2s infinite; }
         .unsaved-indicator { display: inline-block; width: 8px; height: 8px; background-color: #ff4d4d; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 10px #ff4d4d, 0 0 20px #ff4d4d; animation: pulse-indicator 1.5s infinite; }
         @keyframes pulse-glow { 50% { filter: drop-shadow(0 0 12px rgba(187,134,252,0.25)); } }
         @keyframes pulse-indicator { 50% { transform: scale(1.2); opacity: 0.7; } }
         .secondary-btn { padding: 9px 12px; border-radius: 8px; border: none; background: linear-gradient(90deg, rgba(33,150,243,1), rgba(3,218,198,0.85)); color: #fff; font-weight: 700; cursor: pointer; transition: transform .08s; }
         .secondary-btn:hover:not(:disabled) { transform: translateY(-2px); }
         .danger-btn { background: linear-gradient(90deg, rgba(207,102,121,1), rgba(255,112,140,0.9)); color: #080808; font-weight: 800; }
         .danger-btn:hover:not(:disabled) { filter: brightness(1.1); }
         /* addon list */
         .addon-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 10px; padding-right: 5px; /* Spazio a destra */ }
         .addon-list:grabbing { cursor: grabbing; }
         .addon-item {
             display: flex;
             flex-wrap: wrap; /* AGGIUNTO: Permette ai dettagli di andare a capo */
             align-items: center;
             gap: 12px;
             padding: 12px;
             border-radius: 12px;
             background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
             border-left: 4px solid rgba(187,134,252,0.85);
             transition: transform .2s, box-shadow .2s, opacity .3s;
             box-shadow: 0 6px 18px rgba(0,0,0,0.6);
         }
         .addon-item:hover { transform: translateY(-4px); box-shadow: 0 14px 40px rgba(11,8,20,0.7); }
         .addon-item.disabled { opacity: 0.5; border-left-color: #555; filter: grayscale(50%); }
         .addon-item.ghost-class { opacity: 0.5; background: rgba(187,134,252,0.08); border: 1px dashed rgba(187,134,252,0.4); box-shadow: none; }
         .addon-item.sortable-chosen { cursor: grabbing; transform: translateY(-4px) scale(1.02); box-shadow: 0 16px 45px rgba(11,8,20,0.8); }
         .addon-icon { width:56px; height:56px; border-radius:10px; object-fit:cover; background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); display:block; flex-shrink: 0; }
         .addon-icon-placeholder { width: 56px; height: 56px; flex-shrink: 0; background: rgba(255,255,255,0.01); border-radius: 10px; }
         .drag-handle { flex: 1; display: flex; align-items: center; gap: 12px; min-width: 0; cursor: grab; padding: 5px; }
         @media (max-width: 768px) { .drag-handle { cursor: default; } }
         .sortable-chosen .drag-handle { cursor: grabbing; }
         .addon-details { flex: 1; min-width: 0; }
         .addon-details h3 { margin: 0; color: #F3F3FF; font-weight: 700; font-size: 1.02rem; font-family: 'Orbitron', sans-serif; display:flex; align-items:center; gap:8px; word-break: break-word; } /* Aggiunto word-break */
         .addon-details p { margin: 4px 0 0 0; color: rgba(230,230,230,0.65); font-size: 0.9rem; line-height:1.25; max-width: 100%; word-break: break-word;} /* Tolto max-width fisso */
         /* controls */
         .controls-container { display:flex; align-items:center; gap:8px; margin-left:auto; flex-shrink: 0; /* Impedisce ai controlli di restringersi troppo */}
         .move-controls { display:grid; grid-template-columns: 1fr 1fr; gap:4px; width:74px; }
         .controls-btn { background: linear-gradient(180deg, rgba(60,60,70,0.6), rgba(30,30,40,0.7)); border: 1px solid rgba(255,255,255,0.05); color: #C0B0FF; padding: 6px 4px; height: 34px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s ease-out; box-shadow: 0 2px 5px rgba(0,0,0,0.4); }
         .controls-btn:hover:not(:disabled) { background: linear-gradient(180deg, rgba(80,80,90,0.7), rgba(50,50,60,0.8)); box-shadow: 0 4px 10px rgba(187,134,252,0.15), inset 0 0 5px rgba(255,255,255,0.03); transform: translateY(-2px); color: #E0D8FF; }
         .controls-btn:disabled { opacity: 0.4; cursor: not-allowed; background: rgba(40,40,40,0.5); box-shadow: none; transform: none; color: #777; }
         .controls-btn[title*="Cima"], .controls-btn[title*="Top"] { color: #7FFFD4; }
         .controls-btn[title*="Fondo"], .controls-btn[title*="Bottom"] { color: #FFB347; }
         .controls-btn[title*="Cima"]:hover:not(:disabled), .controls-btn[title*="Top"]:hover:not(:disabled) { box-shadow: 0 4px 10px rgba(127, 255, 212, 0.2), inset 0 0 5px rgba(255,255,255,0.03); color: #AFFFFF; }
         .controls-btn[title*="Fondo"]:hover:not(:disabled), .controls-btn[title*="Bottom"]:hover:not(:disabled) { box-shadow: 0 4px 10px rgba(255, 179, 71, 0.2), inset 0 0 5px rgba(255,255,255,0.03); color: #FFCA7A; }
         .icon-btn { background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.03); color: #EDEDED; width: 34px; height: 34px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: all 0.15s ease-out; }
         .icon-btn:hover:not(:disabled) { transform: translateY(-2px); background: rgba(30,30,30,0.6); box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
         .remove-btn { background: linear-gradient(90deg, rgba(207,102,121,1), rgba(255,112,140,0.9)); border-radius:10px; padding:8px 12px; border:none; color:#080808; font-weight:800; cursor:pointer; height:38px; width:48px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: all 0.15s ease-out; }
         .remove-btn:hover:not(:disabled) { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 15px rgba(255,112,140,0.2); }
         /* status indicator */
         .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; box-shadow: 0 0 8px 1px var(--status-color, #888); transition: background-color .3s; flex-shrink: 0; /* Impedisce che si restringa */}
         .status-unchecked { --status-color: #808080; background-color: #808080; }
         .status-ok { --status-color: #03DAC6; background-color: #03DAC6; }
         .status-error { --status-color: #CF6679; background-color: #CF6679; }
         .status-checking { --status-color: #BB86FC; background-color: #BB86FC; animation: pulse 1.5s infinite; }
         @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.7; } }
         .error-details-icon { font-size: 0.9rem; margin-left: 5px; color: rgba(255,255,255,0.7); cursor: help; flex-shrink: 0; }
         /* Toggle Switch */
         .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
         .toggle-switch input { opacity: 0; width: 0; height: 0; }
         .slider { position: absolute; cursor: pointer; inset: 0; background-color: #333; transition: .4s; border-radius: 24px; }
         .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
         input:checked + .slider { background-color: #03DAC6; }
         input:checked + .slider:before { transform: translateX(20px); }
         .edit-name-input { padding:8px 10px; border-radius:8px; border:1px solid rgba(187,134,252,0.12); background:#121016; color:#fff; }
         .save-edit-btn { padding:7px 10px; border-radius:8px; border:none; background: linear-gradient(90deg,#03DAC6,#7CFFEF); font-weight:700; cursor:pointer; }
         /* Filtri & Azioni */
         .actions-panel { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; padding: 10px; margin-bottom: 1rem; }
         .filter-group .secondary-btn, .action-group .secondary-btn { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
         .filter-group .secondary-btn.active { background: linear-gradient(90deg, rgba(33,150,243,1), rgba(3,218,198,0.85)); box-shadow: 0 0 10px rgba(3,218,198,0.2); }
         /* Pannello Statistiche */
         .stats-panel { background: linear-gradient(145deg, rgba(12,6,20,0.88), rgba(6,3,12,0.85)); border-radius: 14px; padding: 20px; border: 1px solid rgba(140, 60, 255, 0.18); box-shadow: 0 12px 40px rgba(99,37,199,0.12), inset 0 1px 0 rgba(255,255,255,0.02); backdrop-filter: blur(10px) saturate(110%); color: #E8E8FF; height: fit-content; /* Adatta altezza al contenuto */ }
         .stats-panel h3 { margin: 0 0 15px 0; color: #B9A3FF; font-family: 'Orbitron', sans-serif; font-size: 1.1rem; border-bottom: 1px solid rgba(187,134,252,0.15); padding-bottom: 8px; }
         .stat-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.95rem; gap: 10px; /* Aggiunto gap */}
         .stat-item strong { color: #fff; font-weight: 600; white-space: nowrap; /* Evita che l'etichetta vada a capo */ }
         .stat-value { font-weight: 700; font-size: 1.1rem; text-align: right; /* Allinea il valore a destra */}
         .stat-value.enabled { color: #03DAC6; } .stat-value.disabled { color: #aaa; } .stat-value.errors { color: #CF6679; }
         .stat-bar-container { width: 100%; height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden; margin-top: 15px; }
         .stat-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease-out; }
         .stat-bar.enabled { background: #03DAC6; } .stat-bar.errors { background: #CF6679; } .stat-bar.disabled { background: #666; }
         /* Footer (ex sidebar) */
         .footer { display:flex; align-items:center; justify-content:space-between; gap:12px; color: rgba(230,230,230,0.5); font-size:0.86rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(187,134,252,0.1); flex-wrap: wrap; }
         /* Bulk Actions */
         .bulk-actions-panel { background: linear-gradient(180deg, rgba(33,150,243,0.1), rgba(3,218,198,0.05)); border: 1px solid rgba(3,218,198,0.15); border-radius: 10px; padding: 10px 14px; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
         .bulk-actions-panel strong { color: #7FF7E1; font-size: 0.95rem; }
         .bulk-actions-panel .secondary-btn { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); padding: 6px 10px; font-size: 0.9rem; }
         .bulk-actions-panel .remove-selected-btn { background: linear-gradient(90deg, rgba(207,102,121,0.8), rgba(255,112,140,0.7)); }
         .addon-checkbox { margin-right: 8px; transform: scale(1.2); accent-color: #BB86FC; cursor: pointer; user-select: none; touch-action: manipulation; flex-shrink: 0; }
         /* Search Toggle */
         .list-controls-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 10px; /* Aumentato leggermente il margine */}
         .search-container { position: relative; display: flex; align-items: center; }
         .search-icon-btn { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); color: #BB86FC; width: 40px; height: 40px; border-radius: 10px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; z-index: 21; position: relative; order: 2; flex-shrink: 0; }
         .search-icon-btn:hover { background: rgba(0,0,0,0.4); box-shadow: 0 0 10px rgba(187,134,252,0.15); }
         .search-input-container { position: relative; width: 0; opacity: 0; visibility: hidden; transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out, visibility 0.3s; order: 1; overflow: hidden; }
         .search-input-container.visible { width: 250px; opacity: 1; visibility: visible; }
         .search-input-container input { background: linear-gradient(180deg, rgba(14,9,18,0.85), rgba(16,10,22,0.75)); border: 1px solid rgba(187,134,252,0.2); box-shadow: 0 0 15px rgba(187,134,252,0.1); height: 40px; width: 100%; padding-left: 10px; }
         /* Pulsante Verifica Stato - Aggiunto stile per spaziatura */
         .check-status-button-container {
             margin-top: 1rem; /* Aggiunto margine sopra */
             margin-bottom: 1.5rem; /* Aumentato margine sotto */
         }
         /* Modal (Istruzioni e Conferma) */
         .modal-overlay { position: fixed; inset: 0; background: rgba(8, 2, 10, 0.85); backdrop-filter: blur(5px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
         .modal-overlay.visible { opacity: 1; visibility: visible; }
         .modal-content { background: linear-gradient(135deg, rgba(18, 12, 24, 0.9), rgba(24, 16, 30, 0.85)); border-radius: 14px; border: 1px solid rgba(187,134,252,0.1); padding: 2rem; max-width: 800px; width: calc(100% - 40px); max-height: 80vh; overflow-y: auto; box-shadow: 0 15px 50px rgba(0,0,0,0.8); position: relative; transform: scale(0.95); transition: transform 0.3s; }
         .modal-overlay.visible .modal-content { transform: scale(1); }
         .modal-close-btn { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #ccc; width: 30px; height: 30px; border-radius: 50%; font-size: 1.2rem; line-height: 1; cursor: pointer; transition: all 0.2s; }
         .modal-close-btn:hover { background: rgba(207,102,121,0.8); color: #fff; transform: rotate(90deg); }
         .modal-content h2 { font-family: 'Orbitron', sans-serif; color: #BB86FC; margin: 0 0 1.5rem 0; border-bottom: 1px solid rgba(187,134,252,0.2); padding-bottom: 0.5rem; }
         .modal-content h3 { color: #7FF7E1; margin: 1.5rem 0 0.5rem 0; font-family: 'Orbitron', sans-serif; font-size: 1.1rem; }
         .modal-content p, .modal-content ul { color: rgba(230,230,230,0.85); line-height: 1.6; font-size: 0.95rem; }
         .modal-content ul { padding-left: 20px; } .modal-content li { margin-bottom: 0.5rem; }
         .modal-content code { background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 4px; font-size: 0.9em; color: #FFA500; }
         .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 1.5rem; border-top: 1px solid rgba(187,134,252,0.1); padding-top: 1rem; }
         .modal-actions .secondary-btn { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); }
         /* Loader Globale */
         .global-loader { position: fixed; inset: 0; background: rgba(8, 2, 10, 0.75); backdrop-filter: blur(4px); z-index: 9998; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
         .global-loader.visible { opacity: 1; visibility: visible; }
         .loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(187, 134, 252, 0.3); border-top-color: #BB86FC; border-radius: 50%; animation: spin 1s linear infinite; }
         @keyframes spin { to { transform: rotate(360deg); } }
        /* ====== ▼▼▼ Stili Toast MODIFICATI (FIXED) ▼▼▼ ====== */
        #toast-container {
            position: fixed; /* MODIFICATO: Riportato a fixed per visibilità globale */
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 300px;
            pointer-events: none; /* Permette di cliccare "attraverso" il container */
        }
        .toast {
            background: linear-gradient(135deg, rgba(30, 30, 40, 0.9), rgba(20, 20, 30, 0.85));
            color: #E6E6E6; padding: 12px 16px; border-radius: 8px; border-left: 4px solid;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); backdrop-filter: blur(5px); font-size: 0.9rem;
            animation: slideInDown 0.3s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
            opacity: 1;
            pointer-events: auto; /* Ripristina i click per i toast stessi */
            width: 100%; /* Occupa la larghezza del container */
        }
        .toast:hover {
         animation: none; /* Pausa animazioni su hover */
         opacity: 1;
     }
        .toast.success { border-left-color: #03DAC6; } .toast.error { border-left-color: #CF6679; color: #FFBABA; } .toast.info { border-left-color: #BB86FC; }
        @keyframes slideInDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; height: 0; padding-top: 0; padding-bottom: 0; margin-top: -10px; border: 0;}
        }
        .toast-leave-active { transition: all 0.5s ease-in; }
        .toast-leave-to { opacity: 0; transform: translateY(-100%); }
        /* ====== ▲▲▲ Stili Toast MODIFICATI (FIXED) ▲▲▲ ====== */
        /* ====== ▼▼▼ STILI DETTAGLI ESPANDIBILI ▼▼▼ ====== */
        .details-toggle-btn {
            font-size: 0.8rem; /* Rimpicciolisce la freccia */
            transition: all 0.2s ease-out;
        }
        .details-toggle-btn.expanded {
            transform: translateY(-2px) rotate(90deg); /* Ruota la freccia */
            background: rgba(187, 134, 252, 0.2); /* Evidenzia quando aperto */
            box-shadow: 0 4px 10px rgba(187,134,252,0.15);
        }
        .addon-extra-details {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-in, margin-top 0.4s ease-out, padding 0.4s ease-out;
            visibility: hidden;
            flex-basis: 100%;
            width: 100%;
            margin-top: 0;
            padding: 0 16px;
            border-top: 1px solid rgba(187, 134, 252, 0.0);
            background: rgba(0,0,0,0.15);
            border-radius: 0 0 12px 12px;
        }
        .addon-extra-details.visible {
            max-height: 500px;
            opacity: 1;
            visibility: visible;
            margin-top: 12px;
            padding: 12px 16px 16px 16px;
            border-top-color: rgba(187, 134, 252, 0.1);
        }
        .addon-extra-details h4 {
            font-family: 'Orbitron', sans-serif;
            color: #7FF7E1;
            margin: 0 0 10px 0;
            font-size: 1rem;
            border-bottom: 1px solid rgba(127, 247, 225, 0.15);
            padding-bottom: 5px;
        }
        .addon-extra-details ul {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.88rem;
            color: rgba(230,230,230,0.8);
        }
        .addon-extra-details li {
            margin-bottom: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            word-break: break-all;
        }
        .addon-extra-details li strong {
            color: #B9A3FF;
            flex-shrink: 0;
        }
        @media (max-width: 768px) {
             .addon-extra-details {
                 padding-left: 10px;
                 padding-right: 10px;
             }
             .addon-extra-details.visible {
                 padding: 12px 10px 16px 10px;
             }
        }
        /* ====== ▲▲▲ FINE STILI DETTAGLI ESPANDIBILI ▲▲▲ ====== */
        /* ====== ▼▼▼ NUOVO: Auto-Update Panel ▼▼▼ ====== */
        .auto-update-panel {
            margin-top: 1rem;
            padding: 12px;
            border-color: rgba(3, 218, 198, 0.15);
            min-height: auto;
        }
        .auto-update-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .auto-update-header h3 {
            margin: 0;
            color: #7FF7E1;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.05rem;
        }
        .auto-update-panel p {
            font-size: 0.88rem;
            color: rgba(230, 230, 230, 0.7);
            margin: 0 0 12px 0;
            line-height: 1.4;
        }
        .auto-update-panel .secondary-btn {
             width: 100%;
             background: linear-gradient(90deg, #424242, #616161);
             border: 1px solid rgba(255,255,255,0.05);
        }
        .auto-update-panel .secondary-btn:hover:not(:disabled) {
             background: linear-gradient(90deg, #616161, #757575);
        }
        .auto-update-panel .secondary-btn:disabled {
            background: rgba(40,40,40,0.5);
        }
        .auto-update-panel .last-check-time {
            font-size: 0.8rem;
            color: rgba(230, 230, 230, 0.5);
            margin-top: 10px;
            text-align: center;
        }
        /* ====== ▲▲▲ FINE Auto-Update Panel ▲▲▲ ====== */
        /* ====== ▼▼▼ NUOVO: Welcome Screen Panel ▼▼▼ ====== */
        .welcome-panel {
            text-align: center;
            padding: 2rem 1.5rem;
        }
        .welcome-panel h2 {
            font-family: 'Orbitron', sans-serif;
            color: #BB86FC;
            margin-bottom: 1.5rem;
        }
        .welcome-panel p {
            color: rgba(230,230,230,0.8);
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .welcome-option {
            background: rgba(0,0,0,0.15);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(187,134,252,0.1);
        }
        .welcome-option h4 {
            color: #7FF7E1;
            font-family: 'Orbitron', sans-serif;
            margin: 0 0 0.5rem 0;
        }
        .welcome-option p {
            font-size: 0.9rem;
            margin-bottom: 1rem;
            color: rgba(230,230,230,0.7);
        }
        .large-toggle { /* Style for the toggle in welcome screen */
            transform: scale(1.3);
            margin-right: 15px;
            vertical-align: middle;
        }
        .welcome-option span { /* Text next to toggle */
            vertical-align: middle;
            font-size: 0.95rem;
            color: #ccc;
        }
        .welcome-option .primary-btn {
            font-size: 1rem;
            padding: 10px 20px;
        }
        /* ====== ▲▲▲ FINE Welcome Screen Panel ▲▲▲ ====== */
        /* ====== Pulsante Salva Flottante (AGGIUNTO) ====== */
        .floating-save-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            padding: 10px 12px; /* Leggermente più piccolo */
            border-radius: 50%; /* Cerchio */
            width: 56px;
            height: 56px;
            font-size: 1.5rem; /* Icona più grande */
            display: flex; /* Centra icona */
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #03DAC6, #7FFFD4); /* Diverso gradiente */
            color: #111;
            box-shadow: 0 8px 25px rgba(3, 218, 198, 0.3), 0 0 10px rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.9);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .floating-save-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        .floating-save-btn:hover:not(:disabled) {
            transform: scale(1.05); /* Effetto hover più evidente */
            filter: brightness(1.1);
        }
        .floating-save-btn .unsaved-indicator { /* Posiziona l'indicatore sul pulsante */
            position: absolute;
            top: 8px;
            right: 8px;
            width: 10px;
            height: 10px;
            margin: 0;
        }
        /* ====== RESPONSIVE ====== */
        @media (max-width: 960px) { /* Modificato breakpoint */
             #app { grid-template-columns: 1fr; grid-template-rows: auto auto; /* Torna a righe automatiche */}
             .stats-panel-container { grid-column: 1 / -1; order: 1; position: static; height: auto; /* Rimuovi sticky */}
             .main-content {
                 grid-column: 1 / -1;
                 order: 2;
                 overflow-y: visible; /* Rimuovi scroll e padding */
                 padding-right: 0;
             }
        }
        @media (max-width: 768px) {
            #app { width: calc(100% - 24px); margin: 12px auto; padding: 1.2rem; }
            header { gap: 4px; }
            h1 { font-size: 1.4rem; gap: 8px; }
            h1::after { display: none; }
            .subtitle { font-size: 0.85rem; }
            .add-addon-panel, .backup-actions { flex-direction: column; align-items: stretch; }
            .backup-actions .secondary-btn { width: 100%; }
            .actions-panel { flex-direction: column; align-items: stretch; gap: 16px; }
            .filter-group, .action-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
            .actions-panel .secondary-btn { flex-grow: 1; }
            .footer { flex-direction: column; align-items: center; text-align: center; gap: 6px; }
            .bulk-actions-panel { flex-direction: column; align-items: stretch; }
            .bulk-actions-panel strong { text-align: center; margin-bottom: 5px; }
            .list-controls-header { flex-direction: row; gap: 10px; align-items: center; /* Modificato: row e align */ }
            .search-container { flex-grow: 1; /* Fa espandere la ricerca */}
            .search-icon-btn { margin-left: auto; /* Spinge a destra */}
            .search-input-container.visible { width: calc(100% - 50px); max-width: none; }
            /* Rimosse regole complesse per search-input-container su mobile */
            .modal-content { padding: 1.5rem; }
            .modal-content h2 { font-size: 1.4rem; }
            .modal-content h3 { font-size: 1rem; }
            .modal-content p, .modal-content ul { font-size: 0.9rem; }
            .modal-close-btn { top: 10px; right: 10px; }
            .addon-item { flex-direction: column; align-items: flex-start; gap: 14px; position: relative; padding-left: 40px; }
            .addon-checkbox { position: absolute; left: 12px; top: 16px; }
            .drag-handle { width: 100%; gap: 10px; }
            .addon-details { width: 100%; }
            .controls-container { margin-left: 0; margin-top: 10px; width: 100%; flex-wrap: wrap; justify-content: flex-start; gap: 8px; }
            .move-controls { display: grid; order: 1; }
            .instructions-btn { top: -5px; right: -5px; width: 32px; height: 32px; font-size: 1.1rem; }
            /* MODIFICATO: Stile Toast per mobile */
            #toast-container {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
                top: 20px; /* MODIFICATO: Spostato in alto */
                bottom: auto; /* Rimosso bottom */
            }
            /* AGGIUNTO: Adatta pulsante flottante per mobile */
            .floating-save-btn { bottom: 20px; right: 20px; width: 50px; height: 50px; font-size: 1.3rem; }
            .welcome-panel { padding: 1.5rem 1rem; } /* Adjust padding for welcome screen on mobile */
            .welcome-option { padding: 1rem; }
        }
        /* MODIFICATO: Spostato il selettore lingua nell'header */
        .lang-switcher { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
        .lang-switcher .secondary-btn { padding: 4px 8px; font-size: 0.8rem; background: none; border: 1px solid rgba(255,255,255,0.1); }
        .lang-switcher .secondary-btn.active { background: linear-gradient(90deg, rgba(33,150,243,1), rgba(3,218,198,0.85)); border-color: transparent; color: #fff; }
        @media (max-width: 768px) { .lang-switcher { margin-left: 0; margin-top: 10px; } }
        /* Miglioramenti: Aggiunta transizione per elementi interattivi */
        button, input { transition: all 0.2s ease; }
        /* Miglioramenti: Migliorato contrasto per accessibilità */
        .subtitle, .stat-item strong { color: #F0F0F0; }
        /* Miglioramenti: Aggiunta ombra focus per accessibilità */
        button:focus, input:focus { outline: none; box-shadow: 0 0 0 3px rgba(187,134,252,0.5); }
        
        /* ====== TEMA CYBERPUNK PER INTRO.JS ====== */
        .introjs-tooltip {
            background: linear-gradient(135deg, rgba(18, 12, 24, 0.95), rgba(24, 16, 30, 0.9));
            border: 1px solid rgba(187, 134, 252, 0.2);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            color: #E6E6E6;
            font-family: 'Inter', sans-serif;
            max-width: 350px;
        }
        .introjs-tooltiptext {
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .introjs-arrow.top { border-bottom-color: rgba(18, 12, 24, 0.95); }
        .introjs-arrow.top-middle { border-bottom-color: rgba(18, 12, 24, 0.95); }
        .introjs-arrow.top-right { border-bottom-color: rgba(18, 12, 24, 0.95); }
        .introjs-arrow.bottom { border-top-color: rgba(18, 12, 24, 0.95); }
        .introjs-arrow.bottom-middle { border-top-color: rgba(18, 12, 24, 0.95); }
        .introjs-arrow.bottom-right { border-top-color: rgba(18, 12, 24, 0.95); }
        .introjs-arrow.left { border-right-color: rgba(18, 12, 24, 0.95); }
        .introjs-arrow.right { border-left-color: rgba(18, 12, 24, 0.95); }

        .introjs-button {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            text-decoration: none;
            color: #fff;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px 12px;
            transition: all 0.2s ease;
            box-shadow: none;
            text-shadow: none;
        }
        .introjs-button:hover:not(:disabled) {
            background: rgba(255,255,255,0.1);
            color: #fff;
            transform: translateY(-1px);
        }
        .introjs-nextbutton {
            background: linear-gradient(90deg, rgba(187,134,252,1), rgba(3,218,198,0.9));
            color: #060606;
            border: none;
        }
        .introjs-nextbutton:hover:not(:disabled) {
             background: linear-gradient(90deg, rgba(187,134,252,1), rgba(3,218,198,0.9));
             filter: brightness(1.2);
             color: #060606;
        }
        .introjs-prevbutton:hover:not(:disabled) {
            background: rgba(255,255,255,0.1);
        }
        .introjs-skipbutton {
            color: #CF6679;
        }
        .introjs-skipbutton:hover:not(:disabled) {
            background: rgba(207,102,121,0.1);
            color: #CF6679;
        }
        .introjs-bullets ul li a {
            background: rgba(255,255,255,0.2);
        }
        .introjs-bullets ul li a.active {
            background: #BB86FC;
        }
        .introjs-helperLayer { /* Overlay che evidenzia */
            background: rgba(8, 2, 10, 0.6);
            box-shadow: 0 0 1px 2px rgba(187, 134, 252, 0.5), 0 0 50px rgba(187, 134, 252, 0.2) inset;
            border: 1px solid rgba(187, 134, 252, 0.8);
            border-radius: 8px;
        }
        /* ====== ▲▲▲ TEMA CYBERPUNK PER INTRO.JS ▲▲▲ ====== */

    </style>
</head>
<body>
    <canvas id="bgCanvas"></canvas>
    <div class="grain" aria-hidden="true"></div>
    <!-- Aggiunto :lang="lang" per accessibilità -->
    <div id="app" :lang="lang">
        <!-- Loader Globale -->
        <div :class="['global-loader', { visible: isLoading }]">
            <div class="loader-spinner"></div>
        </div>
        
        <teleport to="body">
            <div id="toast-container">
                <transition-group name="toast" tag="div">
                    <div v-for="toast in toasts" :key="toast.id" :class="['toast', toast.type]">
                        {{ toast.message }}
                    </div>
                </transition-group>
            </div>
        </teleport>

        <header>
            <h1 @click="incrementAdminClick" data-tour="step-1">{{ t('h1') }}</h1>
            <div class="subtitle" v-if="!isLoggedIn && !isMonitoring">{{ t('subtitle.login') }}</div>
            <div class="subtitle" v-else-if="isMonitoring">{{ t('subtitle.monitoring') }}</div>
            <div class="subtitle" v-else-if="isLoggedIn && (showWelcomeScreen || showWelcomeTourModal)">{{ t('welcome.title') }}</div> <!-- Subtitle per Welcome -->
            <div class="subtitle" v-else-if="isLoggedIn">{{ t('subtitle.loggedIn') }}</div>
            
            <div class="lang-switcher">
                <span style="font-size: 0.85rem; opacity: 0.8;">{{ t('footer.language') }}:</span>
                <button @click="lang = 'it'" :class="['secondary-btn', {active: lang === 'it'}]">IT</button>
                <button @click="lang = 'en'" :class="['secondary-btn', {active: lang === 'en'}]">EN</button>
            </div>
            
            <button @click="showInstructions = true" class="instructions-btn" :title="t('instructions.buttonTitle')">?</button>
        </header>

        <!-- Container per Pannello Statistiche (ora posizionato via Grid) -->
        <div v-if="isLoggedIn && !showWelcomeScreen && !showWelcomeTourModal" class="stats-panel-container" data-tour="step-2">
             <div class="stats-panel">
                <h3>{{ t('stats.title') }}</h3>
                <div class="stat-item">
                    <strong>{{ t('stats.total') }}:</strong>
                    <span class="stat-value">{{ addons.length }}</span>
                </div>
                <div class="stat-item">
                    <strong>{{ t('stats.enabled') }}:</strong>
                    <span class="stat-value enabled">{{ enabledCount }}</span>
                </div>
                <div class="stat-item">
                    <strong>{{ t('stats.disabled') }}:</strong>
                    <span class="stat-value disabled">{{ disabledCount }}</span>
                </div>
                 <div class="stat-item">
                    <strong>{{ t('stats.errors') }}:</strong>
                    <span class="stat-value errors">{{ errorCount }}</span>
                </div>
                <!-- Barre visuali -->
                <div class="stat-bar-container" :title="`${((enabledCount / addons.length || 0) * 100).toFixed(0)}% ${t('stats.enabled')}`">
                     <div class="stat-bar enabled" :style="{ width: (enabledCount / addons.length || 0) * 100 + '%' }"></div>
                </div>
                 <div class="stat-bar-container" style="margin-top: 5px;" :title="`${((errorCount / addons.length || 0) * 100).toFixed(0)}% ${t('stats.errors')}`">
                     <div class="stat-bar errors" :style="{ width: (errorCount / addons.length || 0) * 100 + '%' }"></div>
                </div>
                <!-- Footer -->
                <div class="footer">
                    <div>
                        <div style="font-size:0.85rem;">{{ t('footer.copyright') }}</div>
                        <div style="font-size:0.85rem; opacity:0.8;">{{ t('footer.skin') }}</div>
                    </div>
                </div>
             </div>
        </div>

        <!-- Contenuto principale (ora posizionato via Grid) -->
        <div class="main-content">
            <div class="panel" v-if="!isLoggedIn">
                <!-- Login/Monitor Forms -->
                <form @submit.prevent="login" v-if="!showAdminInput" style="margin-bottom:14px;">
                    <h2 style="margin:0 0 8px 0; color:#BB86FC; font-family:'Orbitron',sans-serif;">{{ t('login.title') }}</h2>
                    <div class="form-group" style="margin-bottom:12px;"><input type="email" v-model="email" :placeholder="t('login.emailPlaceholder')" required></div>
                    <div class="form-group" style="margin-bottom:12px;"><input type="password" v-model="password" :placeholder="t('login.passwordPlaceholder')" required></div>
                    <button type="submit" class="primary-btn" :disabled="isLoading">{{ isLoading ? t('login.loading') : t('login.button') }}</button>
                </form>
                <form v-if="showAdminInput" @submit.prevent="monitorLogin" class="panel" style="margin-top:10px; padding:12px;">
                    <h2 style="margin:0 0 8px 0; color:#FFA500; font-family:'Orbitron',sans-serif;">{{ t('monitor.title') }}</h2>
                    <div class="form-group" style="margin-bottom:10px;"><input type="password" v-model="adminKey" :placeholder="t('monitor.keyPlaceholder')" required></div>
                    <div class="form-group" style="margin-bottom:12px;"><input type="email" v-model="targetEmail" :placeholder="t('monitor.emailPlaceholder')" required></div>
                    <button type="submit" class="primary-btn" :disabled="isLoading" style="background: linear-gradient(90deg,#FFA500,#FFB86C); color:#111;">{{ isLoading ? t('monitor.loading') : t('monitor.button') }}</button>
                </form>
            </div>

            <!-- Welcome Screen (Panel) -->
            <div v-if="isLoggedIn && showWelcomeScreen" class="panel welcome-panel">
                <h2>{{ t('welcome.title') }}</h2>
                <p>{{ t('welcome.p1') }}</p>
                <!-- Auto Update Option -->
                <div class="welcome-option">
                    <h4>{{ t('welcome.autoUpdateTitle') }}</h4>
                    <p>{{ t('welcome.autoUpdateDesc') }}</p>
                    <label class="toggle-switch large-toggle" style="display: inline-block;">
                        <input type="checkbox" v-model="isAutoUpdateEnabled" :disabled="isMonitoring">
                        <span class="slider"></span>
                    </label>
                    <span>{{ isAutoUpdateEnabled ? t('welcome.autoUpdateEnabled') : t('welcome.autoUpdateDisabled') }}</span>
                </div>
                <!-- Proceed Option -->
                <div class="welcome-option">
                    <h4>{{ t('welcome.manageTitle') }}</h4>
                    <p>{{ t('welcome.manageDesc') }}</p>
                    <button @click="dismissWelcomeScreen" class="primary-btn">
                        {{ t('welcome.proceedButton') }} →
                    </button>
                </div>
            </div>
            
            <!-- Main Addon Management Area (Conditional wrapper) -->
            <div v-if="isLoggedIn && !showWelcomeScreen && !showWelcomeTourModal">
                <!-- Save Button -->
                <div style="margin-bottom:12px;">
                    <button @click="saveOrder" :class="['primary-btn', { 'unsaved-changes': hasUnsavedChanges }]" :disabled="isLoading || isMonitoring" style="width:100%;" data-tour="step-7">
                        <span v-if="hasUnsavedChanges" class="unsaved-indicator"></span>
                        💾 {{ t('list.saveButton') }} <span v-if="isMonitoring">(Disabled in Monitor Mode)</span>
                    </button>
                    <button @click="refreshAddonList" class="secondary-btn" :disabled="isLoading || isMonitoring" style="width:100%; margin-top: 10px; background: linear-gradient(90deg, #2196F3, #03A9F4);">
                        🔄 {{ t('list.refreshButton') }}
                    </button>
                </div>
                <!-- Add Addon Panel -->
                <div class="panel add-addon-panel" style="display:flex; gap:10px; align-items:center; padding:12px; min-height: auto;">
                    <input type="text" v-model="newAddonUrl" :placeholder="t('list.addPlaceholder')" style="flex:1;" :disabled="isMonitoring" data-tour="step-3">
                    <button @click="addNewAddon" class="secondary-btn" :disabled="isLoading || !newAddonUrl.trim() || isMonitoring">+ {{ t('list.addButton') }}</button>
                </div>
                <!-- Backup Panel -->
                <div class="panel" style="margin-top:1rem; padding:12px; min-height: auto;">
                    <h3 style="margin:0 0 10px 0; color:#B9A3FF; font-family:'Orbitron',sans-serif; font-size:1.05rem;">{{ t('backup.title') }}</h3>
                    <div style="display:flex; gap:10px;" class="backup-actions">
                        <button @click="exportBackup" class="secondary-btn" style="flex:1; background:linear-gradient(90deg, #4CAF50, #81C784);">{{ t('backup.exportButton') }}</button>
                        <button @click="triggerFileInput" class="secondary-btn" style="flex:1;" :disabled="isMonitoring">{{ t('backup.importButton') }}</button>
                        <button @click="generateShareLink" class="secondary-btn" style="flex:1; background:linear-gradient(90deg, #673AB7, #9575CD);">{{ t('backup.shareButton') }}</button>
                        <button @click="exportTxt" class="secondary-btn" style="flex:1; background:linear-gradient(90deg, #607D8B, #90A4AE);">{{ t('backup.exportTxtButton') }}</button>
                    </div>
                    <input type="file" ref="fileInput" @change="handleFileImport" accept=".json" style="display: none;">
                </div>
                <!-- Share Link Panel -->
                <div v-if="shareUrl" class="panel" style="margin-top:1rem; padding:12px; border-color: rgba(3,218,198,0.25); min-height: auto;">
                    <h3 style="margin:0 0 10px 0; color:#7FF7E1; font-family:'Orbitron',sans-serif; font-size:1.05rem;">{{ t('share.title') }}</h3>
                    <div style="display:flex; gap:10px;" class="add-addon-panel">
                        <input type="text" :value="shareUrl" ref="shareInput" readonly style="background:rgba(0,0,0,0.2);">
                        <button @click="copyShareLink" class="secondary-btn">{{ t('share.copyButton') }}</button>
                    </div>
                </div>
                <!-- Auto-Update Panel -->
                <div class="panel auto-update-panel">
                    <div class="auto-update-header">
                        <h3>{{ t('autoUpdate.title') }}</h3>
                        <label class="toggle-switch" :title="t('autoUpdate.toggleTitle')">
                            <input type="checkbox" v-model="isAutoUpdateEnabled" :disabled="isMonitoring">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p>{{ t('autoUpdate.description') }}</p>
                    <button @click="runAutoUpdate(true)" class="secondary-btn" :disabled="isLoading || isMonitoring">
                        ⚙️ {{ isLoading && isUpdating ? t('autoUpdate.running') : t('autoUpdate.forceButton') }}
                    </button>
                    <div v-if="lastUpdateCheck" class="last-check-time">
                        {{ t('autoUpdate.lastCheck') }}: {{ new Date(lastUpdateCheck).toLocaleString(lang) }}
                    </div>
                </div>
                <!-- Filters, Actions, Status Check -->
                <div style="margin-top:14px;">
                    <div class="panel actions-panel" style="justify-content: center; min-height: auto;">
                        <div class="filter-group" style="display:flex; gap: 8px;">
                            <button @click="activeFilter = 'all'" :class="['secondary-btn', {active: activeFilter === 'all'}]">{{ t('filters.all') }}</button>
                            <button @click="activeFilter = 'enabled'" :class="['secondary-btn', {active: activeFilter === 'enabled'}]">{{ t('filters.enabled') }}</button>
                            <button @click="activeFilter = 'disabled'" :class="['secondary-btn', {active: activeFilter === 'disabled'}]">{{ t('filters.disabled') }}</button>
                            <button @click="activeFilter = 'errors'" :class="['secondary-btn', {active: activeFilter === 'errors'}]">{{ t('filters.errors') }}</button>
                        </div>
                    </div>
                    <div class="panel" style="display:flex; justify-content:center; gap: 10px; padding:10px; margin-top:1rem; min-height: auto;">
                        <button @click="undo" class="secondary-btn" :disabled="history.length === 0 || isMonitoring" :title="t('actions.undo')">↩️ {{ t('actions.undoLabel') }}</button>
                        <button @click="redo" class="secondary-btn" :disabled="redoStack.length === 0 || isMonitoring" :title="t('actions.redo')">↪️ {{ t('actions.redoLabel') }}</button>
                    </div>
                    <div class="check-status-button-container">
                        <button @click="checkAllAddonsStatus" class="primary-btn" :disabled="isLoading" style="width:100%; background: linear-gradient(90deg,#555,#888); color:#fff;">
                            📡 {{ t('list.checkStatusButton') }}
                        </button>
                    </div>
                    <!-- Bulk Actions Panel -->
                    <div v-if="selectedAddons.length > 0" class="bulk-actions-panel">
                        <strong>{{ t('bulkActions.selected', { count: selectedAddons.length }) }}</strong>
                        <button @click="enableSelected" class="secondary-btn" :disabled="isMonitoring">{{ t('bulkActions.enable') }}</button>
                        <button @click="disableSelected" class="secondary-btn" :disabled="isMonitoring">{{ t('bulkActions.disable') }}</button>
                        <button @click="removeSelected" class="secondary-btn remove-selected-btn" :disabled="isMonitoring">{{ t('bulkActions.remove') }}</button>
                    </div>
                    <!-- Search/Select All Header -->
                    <div class="list-controls-header">
                        <div class="search-container">
                            <button @click="toggleSearch" class="search-icon-btn" :title="t('search.toggleTitle')">🔍</button>
                            <div :class="['search-input-container', { visible: showSearchInput }]">
                                <input type="text" v-model="searchQuery" ref="searchInputRef" :placeholder="t('search.placeholder')" @blur="hideSearchOnBlur">
                            </div>
                        </div>
                        <div v-if="addons.length > 0">
                            <button @click="toggleSelectAll" class="secondary-btn" style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05);">
                                {{ allSelected ? t('bulkActions.deselectAll') : t('bulkActions.selectAll') }}
                            </button>
                            <span v-if="filteredAddons.length !== addons.length" style="font-size: 0.9rem; color: rgba(230,230,230,0.75); margin-left: 10px;">
                                {{ t('search.resultsCount', { shown: filteredAddons.length, total: addons.length }) }}
                            </span>
                        </div>
                    </div>
                    <!-- Addon List -->
                    <draggable
                        v-if="filteredAddons.length > 0"
                        v-model="draggableList"
                        @end="onDragEnd"
                        item-key="transportUrl"
                        class="addon-list"
                        v-bind="dragOptions"
                        data-tour="step-4"
                    >
                        <template #item="{ element: addon }">
                            <li :class="['addon-item', { disabled: !addon.isEnabled }]">
                                <input type="checkbox" v-model="addon.selected" class="addon-checkbox" @change.stop :disabled="isMonitoring">
                                <div class="drag-handle" data-tour="step-5">
                                    <img v-if="addon.manifest.logo" :src="addon.manifest.logo" class="addon-icon" @error="event => event.target.style.display = 'none'">
                                    <div v-else class="addon-icon-placeholder"></div>
                                    <div class="addon-details">
                                        <h3 v-if="!addon.isEditing">
                                            <span :class="['status-indicator', `status-${addon.status}`]" :title="t('addon.statusTitle', { status: addon.status })"></span>
                                            <span v-if="addon.status === 'error' && addon.errorDetails" class="error-details-icon" :title="addon.errorDetails">ℹ️</span>
                                            {{ addon.manifest.name }}
                                            <span v-if="!isMonitoring" @click.stop="startEdit(addon)" class="edit-icon" :title="t('addon.editTitle')" style="cursor:pointer; font-size:0.9rem; margin-left:8px; color:rgba(200,200,255,0.7);">🖊️</span>
                                        </h3>
                                        <div v-else style="display:flex; align-items:center; margin-bottom:0.25rem;">
                                            <input type="text" v-model="addon.newLocalName" class="edit-name-input" @keyup.enter="finishEdit(addon)" @blur="finishEdit(addon)">
                                            <button @click.stop="finishEdit(addon)" class="save-edit-btn" style="margin-left:8px;">{{ t('addon.saveButton') }}</button>
                                        </div>
                                        <p>{{ addon.manifest.description || t('addon.noDescription') }}</p>
                                    </div>
                                </div>
                                <div class="controls-container">
                                    <div class="move-controls" aria-hidden="false">
                                        <button @click.stop="moveTop(addon)" :disabled="addons.indexOf(addon) === 0 || isMonitoring" class="controls-btn" :title="t('addon.moveTopTitle')" aria-label="Move to top">🔝</button>
                                        <button @click.stop="moveBottom(addon)" :disabled="addons.indexOf(addon) === addons.length - 1 || isMonitoring" class="controls-btn" :title="t('addon.moveBottomTitle')" aria-label="Move to bottom">⬇️</button>
                                        <button @click.stop="moveUp(addon)" :disabled="addons.indexOf(addon) === 0 || isMonitoring" class="controls-btn" :title="t('addon.moveUpTitle')" aria-label="Move up">▲</button>
                                        <button @click.stop="moveDown(addon)" :disabled="addons.indexOf(addon) === addons.length - 1 || isMonitoring" class="controls-btn" :title="t('addon.moveDownTitle')" aria-label="Move down">▼</button>
                                    </div>
                                    <label class="toggle-switch" :title="t('addon.toggleTitle')" data-tour="step-6">
                                        <input type="checkbox" v-model="addon.isEnabled" @change.stop="toggleAddonEnabled(addon)" :disabled="isMonitoring"><span class="slider"></span>
                                    </label>
                                    <button @click.stop="testAddonSpeed(addon)" class="icon-btn" :title="t('addon.speedTestTitle')">⏱️</button>
                                     <button @click.stop="toggleAddonDetails(addon)" :class="['icon-btn', 'details-toggle-btn', { 'expanded': addon.isExpanded }]" :title="t('addon.detailsTitle')">►</button>
                                    <button v-if="addon.manifest.behaviorHints && addon.manifest.behaviorHints.configurable" @click.stop="openConfiguration(addon)" class="icon-btn" :title="t('addon.configureTitle')">⚙️</button>
                                    <button @click.stop="copyManifestUrl(addon)" class="icon-btn" :title="t('addon.copyTitle')">📋</button>
                                    <button @click.stop="removeAddon(addon)" class="remove-btn" :disabled="isLoading || isMonitoring" :title="t('addon.removeTitle')">🗑️</button>
                                </div>
                                 <div :class="['addon-extra-details', { 'visible': addon.isExpanded }]">
                                    <h4>{{ t('addon.details.title') }}</h4>
                                    <ul>
                                        <li><strong>{{ t('addon.details.version') }}:</strong> {{ addon.manifest.version || 'N/A' }}</li>
                                        <li><strong>{{ t('addon.details.id') }}:</strong> {{ addon.manifest.id || 'N/A' }}</li>
                                        <li><strong>{{ t('addon.details.types') }}:</strong> {{ addon.manifest.types ? addon.manifest.types.join(', ') : 'N/A' }}</li>
                                        <li><strong>{{ t('addon.details.resources') }}:</strong> {{ getResourceNames(addon.manifest.resources) }}</li>
                                        <li><strong>{{ t('addon.details.url') }}:</strong> {{ addon.transportUrl }}</li>
                                    </ul>
                                </div>
                            </li>
                        </template>
                    </draggable>
                    <p v-if="!isLoading && filteredAddons.length === 0 && addons.length > 0" style="text-align: center; margin-top: 2rem; color: #aaa;">{{ t('list.noResults') }}</p>
                    <p v-if="!isLoading && addons.length === 0" style="text-align: center; margin-top: 2rem; color: #aaa;">{{ t('list.noAddons') }}</p>
                </div>
                <!-- Logout Button -->
                <div style="margin-top:1.5rem; display:flex; gap:10px;">
                    <button @click="logout" class="primary-btn logout-btn" style="background: linear-gradient(90deg,#333,#111); color:#fff; width: 100%;">{{ t('list.logoutButton') }}</button>
                </div>
            </div> <!-- Fine Blocco v-if="isLoggedIn && !showWelcomeScreen" -->
        </div> <!-- Fine .main-content -->
        
        <!-- Pulsante Salva Flottante -->
        <button
            v-if="isLoggedIn && !isMonitoring && !showWelcomeScreen && !showWelcomeTourModal"
            @click="saveOrder"
            :class="['floating-save-btn', { visible: hasUnsavedChanges }]"
            :disabled="isLoading || !hasUnsavedChanges"
            data-tour="step-8"
        >
            <span v-if="hasUnsavedChanges" class="unsaved-indicator"></span>
            💾
        </button>

        <!-- Modal Istruzioni -->
        <div :class="['modal-overlay', { visible: showInstructions }]" @click.self="showInstructions = false">
            <div class="modal-content">
                 <button @click="showInstructions = false" class="modal-close-btn">&times;</button>
                 <h2>{{ t('instructions.title') }}</h2>
                 <h3>{{ t('instructions.login.title') }}</h3>
                 <p>{{ t('instructions.login.p1') }}</p>
                 <p>{{ t('instructions.login.p2') }}</p>
                 <h3>{{ t('instructions.list.title') }}</h3>
                 <p>{{ t('instructions.list.p1') }}</p>
                 <ul><li>{{ t('instructions.list.li1') }}</li><li>{{ t('instructions.list.li2') }}</li><li>{{ t('instructions.list.li3') }}</li><li>{{ t('instructions.list.li4') }}</li><li>{{ t('instructions.list.li5') }}</li><li>{{ t('instructions.list.li6') }}</li><li>{{ t('instructions.list.li7') }}</li></ul>
                 <h3>{{ t('instructions.bulk.title') }}</h3><p>{{ t('instructions.bulk.p1') }}</p>
                 <h3>{{ t('instructions.status.title') }}</h3><p>{{ t('instructions.status.p1') }}</p>
                 <h3>{{ t('instructions.backup.title') }}</h3><p>{{ t('instructions.backup.p1') }}</p><p>{{ t('instructions.backup.p2') }}</p><p>{{ t('instructions.backup.p3') }}</p>
                 <h3>{{ t('instructions.share.title') }}</h3><p>{{ t('instructions.share.p1') }}</p>
                 <!-- Istruzioni Auto-Update -->
                 <h3>{{ t('instructions.autoUpdate.title') }}</h3>
                 <p>{{ t('instructions.autoUpdate.p1') }}</p>
                 <p>{{ t('instructions.autoUpdate.p2') }}</p>
                 <h3>{{ t('instructions.other.title') }}</h3><p>{{ t('instructions.other.p1') }}</p><p>{{ t('instructions.other.p2') }}</p><p>{{ t('instructions.other.p3') }}</p><p>{{ t('instructions.other.p4') }}</p><p>{{ t('instructions.other.p5') }}</p>
             </div>
        </div>

        <!-- Modal Conferma Importazione -->
        <div :class="['modal-overlay', { visible: showImportConfirm }]" @click.self="closeImportConfirm">
             <div class="modal-content" style="max-width: 500px;">
                 <button @click="closeImportConfirm" class="modal-close-btn">&times;</button>
                 <h2>{{ t('importConfirm.title') }}</h2>
                 <p>{{ t('importConfirm.p1') }}</p>
                 <p v-if="importSource === 'file'" style="color: #FFA500; font-weight: bold;">{{ t('importConfirm.p2_file') }}</p>
                 <p v-if="importSource === 'url'" style="color: #FFA500; font-weight: bold;">{{ t('importConfirm.p2_url') }}</p>
                 <div class="modal-actions">
                      <button @click="closeImportConfirm" class="secondary-btn">{{ t('importConfirm.cancelButton') }}</button>
                      <button @click="confirmImport" class="secondary-btn danger-btn">{{ t('importConfirm.confirmButton') }}</button>
                 </div>
             </div>
        </div>

        <!-- Modal Benvenuto & Tour -->
        <div :class="['modal-overlay', { visible: showWelcomeTourModal }]" style="z-index: 2000;">
            <div class="modal-content" style="max-width: 500px;">
                <h2>{{ t('tour.welcome.title') }}</h2>
                <p>{{ t('tour.welcome.p1') }}</p>
                <p>{{ t('tour.welcome.p2') }}</p>
                
                <div style="margin-top: 1.5rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <label style="cursor: pointer; color: #ccc; font-size: 0.9rem;">
                        <input type="checkbox" v-model="dontShowWelcomeAgain" style="margin-right: 8px; vertical-align: middle; accent-color: #BB86FC;">
                        {{ t('tour.welcome.dontShowAgain') }}
                    </label>
                </div>

                <div class="modal-actions" style="margin-top: 1rem;">
                    <button @click="skipTour" class="secondary-btn">{{ t('tour.welcome.skipButton') }}</button>
                    <button @click="beginTour" class="primary-btn">{{ t('tour.welcome.startButton') }}</button>
                </div>
            </div>
        </div>

    </div> <!-- Fine #app -->
<script>
    // Background animation script (identico)
    (function initBackground() {
        const canvas = document.getElementById('bgCanvas'); const ctx = canvas.getContext('2d', { alpha: true }); let w = canvas.width = innerWidth; let h = canvas.height = innerHeight; let tStart = performance.now(); const layers = [ { amplitude: 60, wavelength: 0.0095, speed: 0.0009, hue: 265, alpha: 0.18, thickness: 1.6 }, { amplitude: 90, wavelength: 0.0072, speed: 0.0006, hue: 200, alpha: 0.12, thickness: 2.2 }, { amplitude: 120, wavelength: 0.0055, speed: 0.0004, hue: 300, alpha: 0.09, thickness: 2.8 }, { amplitude: 240, wavelength: 0.0036, speed: 0.00025, hue: 150, alpha: 0.06, thickness: 3.6 } ]; function resize() { w = canvas.width = innerWidth; h = canvas.height = innerHeight; } addEventListener('resize', resize); function draw(t) { const time = (t - tStart); ctx.clearRect(0, 0, w, h); const g = ctx.createLinearGradient(0, 0, w, h); g.addColorStop(0, 'rgba(6,2,12,1)'); g.addColorStop(0.3, 'rgba(12,6,20,1)'); g.addColorStop(1, 'rgba(3,2,8,1)'); ctx.fillStyle = g; ctx.fillRect(0, 0, w, h); const vg = ctx.createRadialGradient(w * 0.15, h * 0.12, Math.min(w,h)*0.1, w*0.6, h*0.55, Math.max(w,h)); vg.addColorStop(0, 'rgba(255,255,255,0.02)'); vg.addColorStop(0.4, 'rgba(0,0,0,0.0)'); vg.addColorStop(1, 'rgba(0,0,0,0.7)'); ctx.fillStyle = vg; ctx.fillRect(0,0,w,h); ctx.globalCompositeOperation = 'lighter'; layers.forEach((L, idx) => { ctx.beginPath(); const grad = ctx.createLinearGradient(0, 0, w, 0); const hueA = L.hue; const hueB = (L.hue + 60) % 360; grad.addColorStop(0, `hsla(${hueA},100%,60%,${L.alpha})`); grad.addColorStop(0.5, `hsla(${hueB},90%,58%,${L.alpha * 0.9})`); grad.addColorStop(1, `hsla(${(hueA+120)%360},85%,50%,${L.alpha*0.7})`); ctx.strokeStyle = grad; ctx.lineWidth = 1.2 * L.thickness; ctx.lineCap = 'round'; const step = Math.max(2, Math.round(w / 220)); for (let x = 0; x <= w; x += step) { const y = h * 0.55 + Math.sin(x / (L.wavelength * w) * 2 * Math.PI + time * L.speed + idx * 0.6) * L.amplitude * Math.cos(x / (L.wavelength * w) * 0.5 + time * L.speed * 0.3); if (x === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); } ctx.stroke(); ctx.lineWidth = 0.8 * L.thickness; ctx.strokeStyle = `rgba(255,255,255,${L.alpha*0.06})`; ctx.stroke(); }); ctx.globalCompositeOperation = 'screen'; for (let i = 0; i < 20; i++) { const px = ( (Math.sin((time * 0.0002) + i) + 1) / 2 ) * w; const py = ( (Math.cos((time * 0.00015) + i*0.7) + 1) / 2 ) * h * 0.9; const r = 0.6 + (Math.sin(time * 0.0006 + i) + 1) * 1.6; ctx.beginPath(); ctx.fillStyle = `rgba(140,200,255,${0.06 + (i%3)/40})`; ctx.arc(px, py, r, 0, Math.PI*2); ctx.fill(); } ctx.globalCompositeOperation = 'source-over'; requestAnimationFrame(draw); } requestAnimationFrame(draw);
    })();
</script>
<script>
    const { createApp, ref, computed, onMounted, onBeforeUnmount, watch, nextTick } = Vue
    const app = createApp({
        setup() {
            // --- Refs ---
            const email = ref(''); const password = ref(''); const authKey = ref(null); const addons = ref([]);
            const isLoggedIn = ref(false); const isLoading = ref(false);
            const apiBaseUrl = window.location.origin; const newAddonUrl = ref(''); const fileInput = ref(null);
            const adminClickCount = ref(0); const showAdminInput = ref(false); const adminKey = ref(''); const targetEmail = ref('');
            const isMonitoring = ref(false);
            const searchQuery = ref(''); const hasUnsavedChanges = ref(false); const history = ref([]); const redoStack = ref([]); const activeFilter = ref('all');
            const lang = ref('it'); const toasts = ref([]); let toastIdCounter = 0;
            const importedConfigFromUrl = ref(null); const shareInput = ref(null); const shareUrl = ref(null);
            const showSearchInput = ref(false); const searchInputRef = ref(null); const showInstructions = ref(false);
            const showImportConfirm = ref(false); const pendingImportData = ref(null); const importSource = ref('');
            const isMobile = ref(window.innerWidth <= 960);
            const isAutoUpdateEnabled = ref(false);
            const lastUpdateCheck = ref(null);
            const isUpdating = ref(false);
            const showWelcomeScreen = ref(false);
            
            // --- Refs per Tour ---
            const showWelcomeTourModal = ref(false);
            const dontShowWelcomeAgain = ref(false);

            // --- Translations ---
            const translations = {
                it: {
                    meta: { title: "STREMIO | CONSOLE DI COMANDO ADDON" }, h1: "STREMIO | CONSOLE DI COMANDO ADDON", subtitle: { login: "Per accedere inserisci le credenziali dell'account Stremio", monitoring: "Modalità Monitoraggio attiva", loggedIn: "Console rapida per gestire, ordinare e salvare gli addon" },
                    welcome: { 
                        title: "Benvenuto nella Console Addon!",
                        p1: "Configura rapidamente le opzioni principali o vai direttamente alla gestione della tua lista.",
                        autoUpdateTitle: "Aggiornamenti Automatici Notturni",
                        autoUpdateDesc: "Vuoi che la console controlli e installi automaticamente gli aggiornamenti degli addon ogni notte alle 3:00?",
                        autoUpdateEnabled: "Attivi",
                        autoUpdateDisabled: "Disattivati",
                        manageTitle: "Gestisci i Tuoi Addon",
                        manageDesc: "Vai alla lista completa per aggiungere, rimuovere, riordinare e configurare i tuoi addon.",
                        proceedButton: "Gestisci Addon"
                    },
                    tour: {
                        welcome: {
                            title: "Benvenuto!",
                            p1: "Questa è la tua console di comando personale per Stremio.",
                            p2: "Possiamo farti un rapido tour delle funzionalità principali?",
                            dontShowAgain: "Non mostrare più",
                            skipButton: "Salta",
                            startButton: "Inizia Tour"
                        },
                        steps: {
                            s1: "Questo è il titolo. Cliccalo 5 volte (da sloggato) per la modalità monitoraggio segreta.",
                            s2: "Qui vedi le statistiche rapide dei tuoi addon: totali, attivi, e con errori.",
                            s3: "Incolla qui un URL.../manifest.json per aggiungere un nuovo addon alla tua lista.",
                            s4: "Questa è la tua lista di addon. Puoi riordinarla, attivarla, o disattivarla.",
                            s5: "Su desktop, puoi trascinare gli addon da quest'area per riordinarli velocemente.",
                            s6: "Usa questo interruttore per attivare o disattivare un addon. Le modifiche non sono finali finché non salvi.",
                            s7: "Questo è il pulsante PIÙ IMPORTANTE. Cliccalo per salvare tutte le tue modifiche (ordine, nomi, stati) su Stremio.",
                            s8: "Se hai modifiche non salvate, apparirà anche questo pulsante. È un comodo promemoria!"
                        }
                    },
                    login: { title: "Accesso Utente", emailPlaceholder: "Stremio E-mail", passwordPlaceholder: "Stremio Password", button: "LOGIN", loading: "Accesso in corso..." }, monitor: { title: "Modalità Monitoraggio", keyPlaceholder: "La tua Chiave di Monitoraggio", emailPlaceholder: "E-mail dell'utente da controllare", button: "MONITORA UTENTE", loading: "Monitoraggio..." }, list: { title: "Lista Addon ({{count}})", saveButton: "Salva Ordine e Modifiche su Stremio", addPlaceholder: "Incolla l'URL del manifesto addon[](https://.../manifest.json)", addButton: "Aggiungi", checkStatusButton: "Verifica Stato Addon", noResults: "Nessun addon corrisponde alla tua ricerca.", noAddons: "Nessun addon trovato per questo account.", logoutButton: "LOGOUT", logoutConfirm: "Hai modifiche non salvate. Sei sicuro di voler uscire?", refreshButton: "Aggiorna Lista", refreshSuccess: "Lista aggiornata dal server!", refreshError: "Errore aggiornamento: {{message}}" }, backup: { title: "Gestione Backup", exportButton: "Esporta Backup (.json)", importButton: "Importa Backup (.json)", shareButton: "Condividi Config (URL)", exportTxtButton: "Esporta Lista TXT", exportTxtSuccess: "Lista esportata come TXT!" }, share: { title: "Link di Condivisione Generato", copyButton: "Copia Link", copySuccess: "Link copiato negli appunti!" }, import: { urlSuccess: "Configurazione importata da URL! {{count}} addon caricati. Clicca SALVA.", urlErrorInvalid: "Dati di configurazione nell'URL non validi o corrotti.", fileSuccess: "Backup importato! {{count}} addon caricati. Clicca SALVA.", error: "Importazione fallita: {{message}}" }, importConfirm: { title: "Conferma Importazione", p1: "Stai per sovrascrivere la tua lista addon attuale. Questa azione non può essere annullata.", p2_file: "Caricando questa configurazione da un file.", p2_url: "Caricando questa configurazione da un URL di condivisione.", confirmButton: "Conferma e Sovrascrivi", cancelButton: "Annulla" }, search: { placeholder: "🔍 Cerca addon per nome...", toggleTitle: "Mostra/Nascondi ricerca", resultsCount: "Mostrando {{shown}}/{{total}} addon" }, actions: { undo: "Annulla ultima azione", undoLabel: "Annulla", redo: "Ripristina ultima azione", redoLabel: "Ripristina" }, filters: { all: "Tutti", enabled: "Attivi", disabled: "Disattivati", errors: "Con Errori" },
                    addon: {
                        statusTitle: "Stato: {{status}}", errorDetailsTitle: "Dettaglio Errore: {{details}}", editTitle: "Modifica Nome", saveButton: "Salva", noDescription: "Nessuna descrizione", toggleTitle: "Abilita/Disabilita Addon", configureTitle: "Configura Addon", copyTitle: "Copia URL Manifesto", moveTopTitle: "Sposta in Cima", moveBottomTitle: "Sposta in Fondo", moveUpTitle: "Sposta Su", moveDownTitle: "Sposta Giù", removeTitle: "Rimuovi", removeConfirm: "Sei sicuro di voler rimuovere \"{{name}}\"?", renameSuccess: "Nome aggiornato. Clicca su SALVA.", addSuccess: "Addon \"{{name}}\" aggiunto! Clicca su SALVA.", removeSuccess: "Addon rimosso. Clicca su SALVA.", copyUrlSuccess: "URL copiato!", copyUrlError: "Impossibile copiare URL.", statusCheck: "📡 Avviata verifica stato.", statusCheckComplete: "📡 Verifica completa. Trovati {{errorCount}} errori.", statusCheckError: "Errore verifica: {{message}}", sessionRestored: "Sessione ripristinata.", loginSuccess: "Login effettuato.", saveSuccess: "🎉 Ordine salvato!", saveError: "Salvataggio fallito: {{message}}", saving: "Salvataggio...", addError: "Errore aggiunta: {{message}}", monitorError: "ERRORE MONITORAGGIO: {{message}}", monitorSuccess: "MONITORAGGIO: Dati per {{email}} caricati.", exportError: "Errore creazione backup: {{message}}", exportSuccess: "Backup esportato!", shareError: "Errore creazione link: {{message}}", shareGenerated: "Link di condivisione generato!", monitorModeActive: "Modalità Monitoraggio Attivata.",
                        speedTestTitle: "Test Velocità Addon", speedTestRunning: "Test velocità in corso per {{name}}...", speedTestResult: "Risultato Test {{name}}: {{time}}ms", speedTestTimeout: "Test Fallito {{name}}: Timeout (8s)",
                        detailsTitle: "Mostra/Nascondi Dettagli",
                        details: { title: "Dettagli Manifesto", version: "Versione", id: "ID", types: "Tipi", resources: "Risorse", url: "URL Manifesto" }
                    },
                    autoUpdate: {
                        title: "Aggiornamento Automatico", description: "Se abilitato, cercherà nuove versioni degli addon ogni notte alle 3:00 e le salverà automaticamente.", toggleTitle: "Abilita/Disabilita aggiornamento automatico", forceButton: "Forza Aggiornamento Ora", running: "Aggiornamento in corso...", enabled: "Aggiornamento automatico Abilitato.", disabled: "Aggiornamento automatico Disabilitato.", foundChanges: "Trovati {{count}} aggiornamenti (falliti: {{failed}}). Salvataggio automatico...", noChanges: "Nessun aggiornamento trovato (falliti: {{failed}}).", lastCheck: "Ultimo controllo"
                    },
                    bulkActions: { selected: "{{count}} Selezionati", enable: "🟢 Attiva", disable: "🔴 Disattiva", remove: "🗑️ Rimuovi", removeConfirm: "Sei sicuro di voler rimuovere {{count}} addon selezionati?", selectAll: "Seleziona Tutti", deselectAll: "Deselecta Tutti", enabledSuccess: "Attivati {{count}} addon selezionati. Clicca Salva.", disabledSuccess: "Disattivati {{count}} addon selezionati. Clicca Salva.", removeSuccess: "Rimossi {{count}} addon selezionati. Clicca Salva.", noneToEnable: "Nessun addon selezionato da attivare.", noneToDisable: "Nessun addon selezionato da disattivar." }, stats: { title: "Statistiche", total: "Totale Addon", enabled: "Abilitati", disabled: "Disabilitati", errors: "Con Errori" }, footer: { copyright: "© Stremio Console", skin: "Cyberpunk skin • by Luca", language: "Lingua" },
                    instructions: {
                        /* ... (istruzioni invariate) ... */
                    }
                },
                en: {
                    meta: { title: "STREMIO | ADDON COMMAND CONSOLE" }, h1: "STREMIO | ADDON COMMAND CONSOLE", subtitle: { login: "Enter your Stremio account credentials to log in", monitoring: "Monitoring Mode active", loggedIn: "Quick console to manage, sort, and save addons" },
                    welcome: { 
                        title: "Welcome to the Addon Console!",
                        p1: "Quickly set up key options or jump straight into managing your list.",
                        autoUpdateTitle: "Nightly Automatic Updates",
                        autoUpdateDesc: "Do you want the console to automatically check for and install addon updates every night at 3:00 AM?",
                        autoUpdateEnabled: "Enabled",
                        autoUpdateDisabled: "Disabled",
                        manageTitle: "Manage Your Addons",
                        manageDesc: "Go to the full list to add, remove, reorder, and configure your addons.",
                        proceedButton: "Manage Addons"
                    },
                    tour: {
                        welcome: {
                            title: "Welcome!",
                            p1: "This is your personal Stremio command console.",
                            p2: "Can we give you a quick tour of the main features?",
                            dontShowAgain: "Don't show this again",
                            skipButton: "Skip",
                            startButton: "Start Tour"
                        },
                        steps: {
                            s1: "This is the title. Click it 5 times (when logged out) for the secret monitoring mode.",
                            s2: "Here you see quick stats about your addons: total, enabled, and with errors.",
                            s3: "Paste a .../manifest.json URL here to add a new addon to your list.",
                            s4: "This is your addon list. You can reorder, enable, or disable them.",
                            s5: "On desktop, you can drag addons from this area to reorder them quickly.",
                            s6: "Use this switch to enable or disable an addon. Changes aren't final until you save.",
                            s7: "This is the MOST IMPORTANT button. Click it to save all your changes (order, names, statuses) to Stremio.",
                            s8: "If you have unsaved changes, this button will also appear. It's a handy reminder!"
                        }
                    },
                    login: { title: "User Login", emailPlaceholder: "Stremio E-mail", passwordPlaceholder: "Stremio Password", button: "LOGIN", loading: "Logging in..." }, monitor: { title: "Monitoring Mode", keyPlaceholder: "Your Monitoring Key", emailPlaceholder: "User E-mail to monitor", button: "MONITOR USER", loading: "Monitoring..." }, list: { title: "Addon List ({{count}})", saveButton: "Save Order and Changes to Stremio", addPlaceholder: "Paste addon manifest URL[](https://.../manifest.json)", addButton: "Add", checkStatusButton: "Check Addon Status", noResults: "No addons match your search.", noAddons: "No addons found for this account.", logoutButton: "LOGOUT", logoutConfirm: "You have unsaved changes. Are you sure you want to log out?", refreshButton: "Refresh List", refreshSuccess: "List refreshed from server!", refreshError: "Refresh error: {{message}}" }, backup: { title: "Backup Management", exportButton: "Export Backup (.json)", importButton: "Import Backup (.json)", shareButton: "Share Config (URL)", exportTxtButton: "Export TXT List", exportTxtSuccess: "List exported as TXT!" }, share: { title: "Generated Share Link", copyButton: "Copy Link", copySuccess: "Link copied to clipboard!" }, import: { urlSuccess: "Config imported from URL! {{count}} addons loaded. Click SAVE.", urlErrorInvalid: "Configuration data in URL is invalid or corrupt.", fileSuccess: "Backup imported! {{count}} addons loaded. Click SAVE.", error: "Import failed: {{message}}" }, importConfirm: { title: "Confirm Import", p1: "You are about to overwrite your current addon list. This action cannot be undone.", p2_file: "Loading this configuration from a file.", p2_url: "Loading this configuration from a share URL.", confirmButton: "Confirm and Overwrite", cancelButton: "Cancel" }, search: { placeholder: "🔍 Search addons by name...", toggleTitle: "Show/Hide search", resultsCount: "Showing {{shown}}/{{total}} addons" }, actions: { undo: "Undo last action", undoLabel: "Undo", redo: "Redo last action", redoLabel: "Redo" }, filters: { all: "All", enabled: "Enabled", disabled: "Disabled", errors: "With Errors" },
                    addon: {
                        /* ... (traduzioni addon invariate) ... */
                    },
                    autoUpdate: {
                        /* ... (traduzioni autoupdate invariate) ... */
                    },
                    bulkActions: { /* ... (traduzioni bulk invariate) ... */ }, 
                    stats: { /* ... (traduzioni stats invariate) ... */ }, 
                    footer: { /* ... (traduzioni footer invariate) ... */ },
                    instructions: {
                        /* ... (traduzioni istruzioni invariate) ... */
                    }
                }
            };
            
            const t = computed(() => (key, interpolations = {}) => {
                const keys = key.split('.'); let res = translations[lang.value]; keys.forEach(k => res = res?.[k]); let translation = res || key; Object.entries(interpolations).forEach(([varName, value]) => { translation = translation.replace(new RegExp(`{{${varName}}}`, 'g'), value); }); return translation;
            });
            
            watch(lang, (newLang) => { document.documentElement.lang = newLang; document.title = t.value('meta.title'); try { localStorage.setItem('stremioConsoleLang', newLang); } catch(e) { console.warn("Cannot save lang to localStorage."); } });
            watch(isAutoUpdateEnabled, (newValue) => {
                try {
                    localStorage.setItem('stremioAutoUpdateEnabled', newValue);
                    if (newValue) {
                        showToast(t.value('autoUpdate.enabled'), 'info');
                    } else {
                        showToast(t.value('autoUpdate.disabled'), 'info');
                    }
                } catch(e) { console.warn("Cannot save auto-update pref to localStorage."); }
            });
            
            // --- Functions ---
            const showToast = (message, type = 'success', duration = 3000) => { const id = toastIdCounter++; toasts.value.push({ id, message, type }); setTimeout(() => { toasts.value = toasts.value.filter(toast => toast.id !== id); }, duration); };
            const updateIsMobile = () => isMobile.value = window.innerWidth <= 960;
             const mapAddon = (addon) => ({ ...addon, isEditing: false, newLocalName: addon.manifest.name, status: 'unchecked', selected: false, errorDetails: null, isEnabled: addon.isEnabled !== undefined ? addon.isEnabled : true, isExpanded: false });
            const deepClone = (obj) => JSON.parse(JSON.stringify(obj));
            const recordHistory = () => { if (isLoading.value || isMonitoring.value) return; history.value.push(deepClone(addons.value)); if (history.value.length > 30) history.value.shift(); redoStack.value = []; hasUnsavedChanges.value = true; };
            const undo = () => { if (history.value.length === 0 || isMonitoring.value) return; redoStack.value.push(deepClone(addons.value)); addons.value = history.value.pop(); if (history.value.length === 0) hasUnsavedChanges.value = false; addons.value.forEach(a => a.selected = false); };
            const redo = () => { if (redoStack.value.length === 0 || isMonitoring.value) return; history.value.push(deepClone(addons.value)); addons.value = redoStack.value.pop(); hasUnsavedChanges.value = true; addons.value.forEach(a => a.selected = false); };
            const closeImportConfirm = () => { showImportConfirm.value = false; pendingImportData.value = null; importSource.value = ''; };
            const confirmImport = () => {
                try {
                    recordHistory(); let importedData = importSource.value === 'file' ? JSON.parse(pendingImportData.value) : pendingImportData.value;
                    if (!Array.isArray(importedData)) throw new Error("Invalid JSON data."); if (importedData.length > 0 && (!importedData[0].manifest || !importedData[0].transportUrl)) throw new Error("Incorrect addon format.");
                    addons.value = importedData.map(mapAddon); showToast(t.value(importSource.value === 'file' ? 'import.fileSuccess' : 'import.urlSuccess', { count: addons.value.length }), 'success'); hasUnsavedChanges.value = true; addons.value.forEach(a => a.selected = false);
                } catch(err) { showToast(t.value('import.error', { message: err.message }), 'error'); } finally { closeImportConfirm(); }
            };
            const monitorLogin = async () => {
                isLoading.value = true; isMonitoring.value = false;
                try {
                    const response = await fetch(`${apiBaseUrl}/api/admin/monitor`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ adminKey: adminKey.value, targetEmail: targetEmail.value }) });
                    if (!response.ok) throw new Error((await response.json()).error.message || 'Access Denied.');
                    const data = await response.json();
                    authKey.value = data.authKey; isLoggedIn.value = true; isMonitoring.value = true; email.value = targetEmail.value;
                    showToast(t.value('addon.monitorSuccess', { email: targetEmail.value }), 'info');
                    sessionStorage.setItem('stremioAuthKey', authKey.value); sessionStorage.setItem('stremioEmail', email.value); sessionStorage.setItem('stremioIsMonitoring', 'true'); sessionStorage.setItem('stremioAddonList', JSON.stringify(data.addons.map(mapAddon)));
                    addons.value = data.addons.map(mapAddon);
                    
                    // --- Logica Benvenuto/Tour (RIPRISTINATA) ---
                    showWelcomeScreen.value = true; // Mostra sempre il pannello setup
                    
                } catch (err) { showToast(t.value('addon.monitorError', { message: err.message }), 'error'); } finally { isLoading.value = false; }
            };
            const exportBackup = () => {
                if (addons.value.length === 0) { showToast("No addons to export.", 'error'); return; }
                try {
                    const addonsToExport = addons.value.map(({ selected, errorDetails, status, isEditing, newLocalName, isExpanded, ...rest }) => rest);
                    const dataStr = JSON.stringify(addonsToExport, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.download = `stremio-addons-backup-${new Date().toISOString().split('T')[0]}.json`; link.href = url; link.click(); URL.revokeObjectURL(url);
                    showToast(t.value('addon.exportSuccess'), 'success');
                } catch(e) { showToast(t.value('addon.exportError', { message: e.message }), 'error'); }
            };
            const exportTxt = () => {
                if (addons.value.length === 0) { showToast("No addons to export.", 'error'); return; }
                const txtContent = addons.value.map(a => `${a.manifest.name}: ${a.transportUrl}`).join('\n');
                const dataBlob = new Blob([txtContent], {type: "text/plain"}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.download = `stremio-addons-list-${new Date().toISOString().split('T')[0]}.txt`; link.href = url; link.click(); URL.revokeObjectURL(url);
                showToast(t.value('backup.exportTxtSuccess'), 'success');
            };
            const triggerFileInput = () => { if (!isMonitoring.value) fileInput.value.click(); };
            const handleFileImport = (event) => {
                const file = event.target.files[0]; if (!file || isMonitoring.value) return; const reader = new FileReader();
                reader.onload = e => { pendingImportData.value = e.target.result; importSource.value = 'file'; showImportConfirm.value = true; };
                reader.readAsText(file); event.target.value = null;
            };
            const generateShareLink = () => {
                try {
                    const addonsToShare = addons.value.map(({ selected, errorDetails, status, isEditing, newLocalName, isExpanded, ...rest }) => rest);
                    const data = JSON.stringify(addonsToShare); const compressed = LZString.compressToEncodedURIComponent(data);
                    shareUrl.value = `${window.location.origin}${window.location.pathname}#config=${compressed}`;
                    showToast(t.value('addon.shareGenerated'), 'info');
                } catch (err) { showToast(t.value('addon.shareError', { message: err.message }), 'error'); }
            };
            const copyShareLink = () => {
                if (!shareInput.value) return; try { shareInput.value.select(); document.execCommand('copy'); showToast(t.value('share.copySuccess'), 'success'); } catch (err) { showToast(t.value('addon.copyUrlError'), 'error'); }
            };
            const checkAllAddonsStatus = async () => {
                isLoading.value = true; showToast(t.value('addon.statusCheck'), 'info'); let errorCountLocal = 0;
                await Promise.allSettled(addons.value.map(async (addon) => {
                    addon.status = 'checking'; addon.errorDetails = null;
                    try { const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 5000); const response = await fetch(addon.transportUrl, { signal: controller.signal, mode: 'cors' }); clearTimeout(timeoutId); if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText || 'Server Error'}`); addon.status = 'ok'; }
                    catch (err) { console.error(`Error ${addon.manifest.name}:`, err); addon.status = 'error'; addon.errorDetails = err.name === 'AbortError' ? 'Timeout (5s)' : err.message; errorCountLocal++; throw err; }
                }));
                showToast(t.value('addon.statusCheckComplete', { errorCount: errorCountLocal }), errorCountLocal > 0 ? 'error' : 'success'); isLoading.value = false;
            };
             const toggleAddonDetails = (addon) => { addon.isExpanded = !addon.isExpanded; };
             const getResourceNames = (resources) => {
                 if (!Array.isArray(resources)) return 'N/A'; if (resources.length === 0) return 'None';
                 return resources.map(res => { if (typeof res === 'string') return res; if (typeof res === 'object' && res.name) return res.name; return 'unknown'; }).join(', ');
             };
            const testAddonSpeed = async (addon) => {
                if (isLoading.value) return; showToast(t.value('addon.speedTestRunning', { name: addon.manifest.name }), 'info', 2000); isLoading.value = true; const startTime = performance.now();
                try {
                    const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 8000);
                    await fetch(addon.transportUrl, { signal: controller.signal, mode: 'cors', cache: 'no-store' }); clearTimeout(timeoutId);
                    const endTime = performance.now(); const duration = Math.round(endTime - startTime);
                    showToast(t.value('addon.speedTestResult', { name: addon.manifest.name, time: duration }), 'success');
                } catch (err) { showToast(t.value(err.name === 'AbortError' ? 'addon.speedTestTimeout' : 'addon.statusCheckError', { name: addon.manifest.name, message: err.message }), 'error'); } finally { isLoading.value = false; }
            };
            const runAutoUpdate = async (isManual = false) => {
                if ((isLoading.value && !isUpdating.value) || isMonitoring.value || !isLoggedIn.value) { if (isManual) showToast(isMonitoring.value ? t.value('addon.monitorModeActive') : "Operazione già in corso o non loggato.", 'error'); return; }
                isLoading.value = true; isUpdating.value = true; showToast(t.value('autoUpdate.running'), 'info');
                let updatedCount = 0; let failedCount = 0; let hasManifestChanges = false;
                const fetchAndUpdateAddon = async (addon) => {
                    try {
                        const response = await fetch(`${apiBaseUrl}/api/fetch-manifest`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ manifestUrl: addon.transportUrl }) });
                        const responseText = await response.text(); let newManifest; try { newManifest = JSON.parse(responseText); } catch (e) { throw new Error(`Invalid JSON response.`); }
                        if (!response.ok || newManifest.error) throw new Error(newManifest.error?.message || "Failed to fetch");
                        const getComparableManifest = (m) => { const { version, description, logo, types, resources, id, behaviorHints, configurable } = m; return JSON.stringify({ version, description, logo, types, resources, id, behaviorHints, configurable }); };
                        const oldManifestComparable = getComparableManifest(addon.manifest); const newManifestComparable = getComparableManifest(newManifest);
                        if (oldManifestComparable !== newManifestComparable) {
                            hasManifestChanges = true; updatedCount++; const currentName = addon.manifest.name;
                            addon.manifest = { ...newManifest, name: currentName }; addon.newLocalName = currentName;
                            return { status: 'fulfilled', id: addon.manifest.id };
                        } return { status: 'fulfilled', id: addon.manifest.id, noChange: true };
                    } catch (error) { console.error(`Failed to update ${addon.manifest.name}:`, error); failedCount++; return { status: 'rejected', id: addon.manifest.id, reason: error.message }; }
                };
                const results = await Promise.allSettled(addons.value.map(fetchAndUpdateAddon));
                if (hasManifestChanges) { showToast(t.value('autoUpdate.foundChanges', { count: updatedCount, failed: failedCount }), 'info'); hasUnsavedChanges.value = true; await saveOrder(); }
                 else { showToast(t.value('autoUpdate.noChanges', { failed: failedCount }), failedCount > 0 ? 'error' : 'success'); isLoading.value = false; }
                try { localStorage.setItem('stremioLastAutoUpdate', new Date().toISOString()); lastUpdateCheck.value = new Date().toISOString(); } catch (e) { console.warn("Cannot save last update time to localStorage."); }
                isUpdating.value = false;
            };
            const scheduleUpdateCheck = () => {
                const now = new Date(); const nextUpdate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 3, 0, 0, 0);
                if (now.getTime() > nextUpdate.getTime()) { nextUpdate.setDate(nextUpdate.getDate() + 1); }
                const timeToNextUpdate = nextUpdate.getTime() - now.getTime(); console.log(`Next auto-update check scheduled for: ${nextUpdate.toLocaleString()}`);
                setTimeout(async () => { console.log("Running scheduled auto-update check..."); if (isLoggedIn.value && isAutoUpdateEnabled.value && !isMonitoring.value) { await runAutoUpdate(false); } scheduleUpdateCheck(); }, timeToNextUpdate);
            };
            const toggleAddonEnabled = (addon) => { if (!isMonitoring.value) recordHistory(); };
            const openConfiguration = (addon) => { const baseUrl = addon.transportUrl.replace(/\/manifest.json$/, ''); window.open(`${baseUrl}/configure`, '_blank'); };
            const copyManifestUrl = async (addon) => { try { await navigator.clipboard.writeText(addon.transportUrl); showToast(t.value('addon.copyUrlSuccess'), 'success'); } catch(e) { showToast(t.value('addon.copyUrlError'), 'error'); } };
            const startEdit = (addon) => { if (!isMonitoring.value) { addon.newLocalName = addon.manifest.name; addon.isEditing = true; } };
            const finishEdit = (addon) => { if (!isMonitoring.value) { const oldName = addon.manifest.name; const newName = addon.newLocalName.trim(); if (newName && newName !== oldName) { recordHistory(); addon.manifest.name = newName; showToast(t.value('addon.renameSuccess'), 'info'); } addon.isEditing = false; } else { addon.isEditing = false; }};
            const addNewAddon = async () => {
                if (isMonitoring.value) return; recordHistory(); const url = newAddonUrl.value.trim(); if (!url.startsWith('http')) { showToast("Invalid URL.", 'error'); return; } isLoading.value = true;
                try {
                    const response = await fetch(`${apiBaseUrl}/api/fetch-manifest`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ manifestUrl: url }) }); const responseText = await response.text(); let manifest; try { manifest = JSON.parse(responseText); } catch (e) { throw new Error(`Invalid JSON response.`); } if (!response.ok || manifest.error) throw new Error(manifest.error?.message || "Invalid manifest.");
                    const cleanManifest = { id: manifest.id || `external-${Date.now()}`, version: manifest.version || '1.0.0', name: manifest.name || `New Addon`, types: manifest.types || ["movie", "series"], resources: manifest.resources || [], idPrefixes: manifest.idPrefixes || [], configurable: manifest.configurable, behaviorHints: manifest.behaviorHints, description: manifest.description || `URL: ${url}`, logo: manifest.logo || '', ...manifest }; const newAddonUrlBase = url.split('?')[0]; if (addons.value.some(a => a.transportUrl.split('?')[0] === newAddonUrlBase)) { showToast("Addon already exists.", 'error'); return; }
                    addons.value.push(mapAddon({ transportUrl: url, manifest: cleanManifest, isEnabled: true })); await nextTick(); const listElement = document.querySelector('.main-content'); if (listElement) listElement.scrollTo({ top: listElement.scrollHeight, behavior: 'smooth' }); newAddonUrl.value = ''; showToast(t.value('addon.addSuccess', { name: cleanManifest.name }), 'success'); hasUnsavedChanges.value = true;
                } catch (err) { showToast(t.value('addon.addError', { message: err.message }), 'error'); } finally { isLoading.value = false; }
            };
            const moveAddon = (addon, logicDirection) => { if (isMonitoring.value) return; recordHistory(); const index = addons.value.indexOf(addon); if (index === -1) return; const item = addons.value[index]; if (logicDirection === 'up' && index > 0) [addons.value[index], addons.value[index - 1]] = [addons.value[index - 1], addons.value[index]]; else if (logicDirection === 'down' && index < addons.value.length - 1) [addons.value[index], addons.value[index + 1]] = [addons.value[index + 1], addons.value[index]]; else if (logicDirection === 'top' && index > 0) { addons.value.splice(index, 1); addons.value.unshift(item); } else if (logicDirection === 'bottom' && index < addons.value.length - 1) { addons.value.splice(index, 1); addons.value.push(item); } hasUnsavedChanges.value = true; };
            const moveUp = (addon) => moveAddon(addon, 'up'); const moveDown = (addon) => moveAddon(addon, 'down'); const moveTop = (addon) => moveAddon(addon, 'top'); const moveBottom = (addon) => moveAddon(addon, 'bottom');
            const removeAddon = (addon) => { if (isMonitoring.value) return; if(confirm(t.value('addon.removeConfirm', { name: addon.manifest.name }))) { const index = addons.value.findIndex(a => a.transportUrl === addon.transportUrl); if (index > -1) { recordHistory(); const removedAddonName = addons.value[index].manifest.name; addons.value.splice(index, 1); showToast(t.value('addon.removeSuccess'), 'info'); hasUnsavedChanges.value = true; }}};
            const enableSelected = () => { if (isMonitoring.value) return; recordHistory(); let count = 0; selectedAddons.value.forEach(addon => { if (!addon.isEnabled) { addon.isEnabled = true; count++; } addon.selected = false; }); if (count > 0) { showToast(t.value('bulkActions.enabledSuccess', { count: count }), 'success'); hasUnsavedChanges.value = true; } else { showToast(t.value('bulkActions.noneToEnable'), 'info'); }};
            const disableSelected = () => { if (isMonitoring.value) return; recordHistory(); let count = 0; selectedAddons.value.forEach(addon => { if (addon.isEnabled) { addon.isEnabled = false; count++; } addon.selected = false; }); if (count > 0) { showToast(t.value('bulkActions.disabledSuccess', { count: count }), 'success'); hasUnsavedChanges.value = true; } else { showToast(t.value('bulkActions.noneToDisable'), 'info'); }};
            const removeSelected = () => { if (isMonitoring.value || selectedAddons.value.length === 0) return; if (confirm(t.value('bulkActions.removeConfirm', { count: selectedAddons.value.length }))) { recordHistory(); const selectedUrls = new Set(selectedAddons.value.map(a => a.transportUrl)); const originalCount = addons.value.length; addons.value = addons.value.filter(addon => !selectedUrls.has(addon.transportUrl)); const removedCount = originalCount - addons.value.length; if (removedCount > 0) { showToast(t.value('bulkActions.removeSuccess', { count: removedCount }), 'success'); hasUnsavedChanges.value = true; }}};
            const toggleSelectAll = () => { const targetState = !allSelected.value; addons.value.forEach(addon => addon.selected = targetState); };
            const toggleSearch = () => { showSearchInput.value = !showSearchInput.value; if (showSearchInput.value) nextTick(() => searchInputRef.value?.focus()); };
            const hideSearchOnBlur = (event) => { const searchContainer = event.currentTarget.closest('.list-controls-header'); if (!searchContainer || (!searchContainer.contains(event.relatedTarget) && event.relatedTarget?.closest('.search-icon-btn') !== event.currentTarget.parentElement.querySelector('.search-icon-btn'))) showSearchInput.value = false; };
            const saveOrder = async () => {
                if (isMonitoring.value) return; const enabledAddons = addons.value.filter(a => a.isEnabled);
                const addonsToSave = enabledAddons.map(({ isEditing, newLocalName, status, isEnabled, selected, errorDetails, isExpanded, ...rest }) => rest);
                if (!isLoading.value) isLoading.value = true;
                showToast(t.value('addon.saving'), 'info', 5000);
                try {
                    const response = await fetch(`${apiBaseUrl}/api/set-addons`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ authKey: authKey.value, addons: addonsToSave, email: email.value }) });
                    const data = await response.json(); if (!response.ok || data.error) throw new Error(data.error || data.message || 'Save error.'); showToast(t.value('addon.saveSuccess'), 'success'); hasUnsavedChanges.value = false; history.value = []; redoStack.value = []; addons.value.forEach(a => a.selected = false); sessionStorage.setItem('stremioAddonList', JSON.stringify(addons.value));
                } catch (err) { showToast(t.value('addon.saveError', { message: err.message }), 'error'); } finally { isLoading.value = false; isUpdating.value = false; }
            };
            const refreshAddonList = async () => {
                if (isLoading.value || isMonitoring.value) return;
                isLoading.value = true;
                try {
                    const response = await fetch(`${apiBaseUrl}/api/get-addons`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ authKey: authKey.value, email: email.value })
                    });
                    const data = await response.json();
                    if (!response.ok || data.error) throw new Error(data.error || 'Refresh failed.');
                    addons.value = data.addons.map(mapAddon);
                    showToast(t.value('list.refreshSuccess'), 'success');
                    hasUnsavedChanges.value = false;
                } catch (err) { showToast(t.value('list.refreshError', { message: err.message }), 'error'); }
                finally { isLoading.value = false; }
            };
            const login = async () => {
                isLoading.value = true;
                try {
                    const response = await fetch(`${apiBaseUrl}/api/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email.value, password: password.value }) }); const data = await response.json(); if (!response.ok) throw new Error(data.message || 'Login failed.');
                    authKey.value = data.authKey; isLoggedIn.value = true;
                    sessionStorage.setItem('stremioAuthKey', authKey.value); sessionStorage.setItem('stremioEmail', email.value); sessionStorage.setItem('stremioIsMonitoring', 'false'); sessionStorage.setItem('stremioAddonList', JSON.stringify(data.addons.map(mapAddon)));
                    addons.value = data.addons.map(mapAddon);
                    showToast(t.value('addon.loginSuccess'), 'success');
                    
                    // --- Logica Benvenuto/Tour (RIPRISTINATA) ---
                    showWelcomeScreen.value = true; // Mostra sempre il pannello setup

                } catch (err) { showToast(err.message, 'error'); } finally { isLoading.value = false; }
            };
            
            // --- Logica Tour spostata qui ---
            const dismissWelcomeScreen = () => {
                showWelcomeScreen.value = false;

                // 1. Gestione prioritaria Import da URL
                if (importedConfigFromUrl.value) {
                    pendingImportData.value = importedConfigFromUrl.value;
                    importSource.value = 'url';
                    showImportConfirm.value = true;
                    importedConfigFromUrl.value = null; 
                    return; // Esce qui, l'import ha la priorità
                }

                // 2. Controllo per il Tour (solo se non c'è un import)
                try {
                    const tourCompleted = localStorage.getItem('stremioConsoleWelcomeCompleted') === 'true';
                    if (!tourCompleted) {
                        showWelcomeTourModal.value = true; // Mostra la modale "Vuoi fare il tour?"
                    }
                    // Se tourCompleted è true, non fa nient'altro,
                    // la schermata di gestione addon apparirà automaticamente.
                } catch(e) {
                    console.warn("Cannot read tour pref from localStorage.");
                    // Fallback: non mostrare il tour se c'è un errore
                }
            };

            // --- Funzioni Tour ---
            const skipTour = () => {
                if (dontShowWelcomeAgain.value) {
                    try { localStorage.setItem('stremioConsoleWelcomeCompleted', 'true'); } catch(e) { console.warn("Cannot save tour pref to localStorage."); }
                }
                showWelcomeTourModal.value = false;
                // Non serve fare altro, showWelcomeScreen è già false
            };

            const beginTour = () => {
                if (dontShowWelcomeAgain.value) {
                    try { localStorage.setItem('stremioConsoleWelcomeCompleted', 'true'); } catch(e) { console.warn("Cannot save tour pref to localStorage."); }
                }
                showWelcomeTourModal.value = false;
                
                nextTick(() => {
                    startTour(); // Avvia il tour dopo che gli elementi sono renderizzati
                });
            };

            const startTour = () => {
                const originalHasUnsaved = hasUnsavedChanges.value;
                 // Mostra temporaneamente il pulsante flottante per includerlo nel tour, se necessario
                if (!isMonitoring.value && hasUnsavedChanges.value) {
                     // Se ci sono già modifiche non salvate, il pulsante è visibile
                } else if (!isMonitoring.value) {
                     hasUnsavedChanges.value = true; // Forza la visualizzazione
                }

                const steps = [
                    { element: document.querySelector('[data-tour="step-1"]'), intro: t.value('tour.steps.s1'), position: 'bottom' },
                    { element: document.querySelector('[data-tour="step-2"]'), intro: t.value('tour.steps.s2'), position: isMobile.value ? 'bottom' : 'left' },
                    { element: document.querySelector('[data-tour="step-3"]'), intro: t.value('tour.steps.s3'), position: 'bottom' },
                    { element: document.querySelector('[data-tour="step-4"]'), intro: t.value('tour.steps.s4'), position: 'top' }
                ];

                const firstAddonItem = document.querySelector('.addon-item');
                if (firstAddonItem && !isMobile.value) { // Mostra drag solo su desktop
                    steps.push({ element: firstAddonItem.querySelector('[data-tour="step-5"]'), intro: t.value('tour.steps.s5'), position: 'right' });
                }
                if (firstAddonItem) {
                     steps.push({ element: firstAddonItem.querySelector('[data-tour="step-6"]'), intro: t.value('tour.steps.s6'), position: 'left' });
                }
                
                steps.push({ element: document.querySelector('[data-tour="step-7"]'), intro: t.value('tour.steps.s7'), position: 'bottom' });
                
                const floatingButton = document.querySelector('[data-tour="step-8"]');
                // Aggiungi step-8 solo se il pulsante esiste ed è visibile
                if (!isMonitoring.value && floatingButton && floatingButton.classList.contains('visible')) {
                    steps.push({ element: floatingButton, intro: t.value('tour.steps.s8'), position: 'left' });
                }

                introJs().setOptions({
                    steps: steps,
                    tooltipClass: 'introjs-tooltip',
                    highlightClass: 'introjs-helperLayer',
                    nextLabel: t.value('tour.welcome.startButton').includes('Start') ? 'Next →' : 'Avanti →',
                    prevLabel: t.value('tour.welcome.startButton').includes('Start') ? '← Back' : '← Indietro',
                    doneLabel: t.value('tour.welcome.startButton').includes('Start') ? 'Done' : 'Fatto',
                    exitOnOverlayClick: false,
                    showBullets: false,
                }).oncomplete(() => {
                    // Ripristina lo stato di hasUnsavedChanges solo se lo avevamo forzato
                    if (!isMonitoring.value && !originalHasUnsaved) hasUnsavedChanges.value = false; 
                }).onexit(() => {
                     // Ripristina lo stato di hasUnsavedChanges solo se lo avevamo forzato
                    if (!isMonitoring.value && !originalHasUnsaved) hasUnsavedChanges.value = false;
                }).start();
            };
            // --- Fine Funzioni Tour ---

            const logout = () => { if (hasUnsavedChanges.value && !confirm(t.value('list.logoutConfirm'))) return; sessionStorage.clear(); email.value = ''; password.value = ''; authKey.value = null; addons.value = []; isLoggedIn.value = false; isMonitoring.value = false; showAdminInput.value = false; hasUnsavedChanges.value = false; history.value = []; redoStack.value = []; searchQuery.value = ''; showSearchInput.value = false; showInstructions.value = false; toasts.value = []; showWelcomeScreen.value = false; showWelcomeTourModal.value = false; };
            const beforeUnloadHandler = (event) => { if (hasUnsavedChanges.value) { event.preventDefault(); event.returnValue = ''; } };
            const incrementAdminClick = () => { if(!isLoggedIn.value) adminClickCount.value++; if (adminClickCount.value >= 5) { showAdminInput.value = true; showToast(t.value('addon.monitorModeActive'), 'info'); adminClickCount.value = 0; }};
              const onDragEnd = (event) => { console.log('Drag ended', event); };
            // --- Computed ---
            const dragOptions = computed(() => ({ animation: 200, ghostClass: "ghost-class", handle: ".drag-handle", forceFallback: true, scrollSensitivity: 100, bubbleScroll: true, delay: 300, delayOnTouchOnly: true, touchStartThreshold: isMobile.value ? 10 : 3 }));
            const filteredAddons = computed(() => { let f = addons.value; if (activeFilter.value === 'enabled') f = addons.value.filter(a => a.isEnabled); if (activeFilter.value === 'disabled') f = addons.value.filter(a => !a.isEnabled); if (activeFilter.value === 'errors') f = addons.value.filter(a => a.status === 'error'); if (!searchQuery.value) return f; const lcq = searchQuery.value.toLowerCase(); return f.filter(a => a.manifest.name.toLowerCase().includes(lcq)); });
            const draggableList = computed({ get: () => filteredAddons.value, set(reorderedFilteredList) { if (isMonitoring.value) return; const filteredUrlsSet = new Set(reorderedFilteredList.map(a => a.transportUrl)); const newFullList = []; addons.value.forEach(originalAddon => { if (!filteredUrlsSet.has(originalAddon.transportUrl)) newFullList.push(originalAddon); }); const originalFilteredIndices = addons.value.map((addon, index) => filteredUrlsSet.has(addon.transportUrl) ? index : -1).filter(index => index !== -1); if (originalFilteredIndices.length === reorderedFilteredList.length) { reorderedFilteredList.forEach((addon, i) => newFullList.splice(originalFilteredIndices[i], 0, addon)); if (JSON.stringify(addons.value) !== JSON.stringify(newFullList)) { addons.value = newFullList; recordHistory(); } } else { console.error("Mismatch during reorder."); } } });
            const enabledCount = computed(() => addons.value.filter(a => a.isEnabled).length);
            const disabledCount = computed(() => addons.value.filter(a => !a.isEnabled).length);
            const errorCount = computed(() => addons.value.filter(a => a.status === 'error').length);
            const selectedAddons = computed(() => addons.value.filter(a => a.selected));
            const allSelected = computed(() => addons.value.length > 0 && selectedAddons.value.length === addons.value.length);
            // --- Lifecycle ---
            onMounted(() => {
                window.addEventListener('beforeunload', beforeUnloadHandler); window.addEventListener('resize', updateIsMobile);
                try { const savedLang = localStorage.getItem('stremioConsoleLang'); if (savedLang && ['it', 'en'].includes(savedLang)) lang.value = savedLang; } catch(e) { console.warn("Error reading lang from localStorage."); }
                document.documentElement.lang = lang.value; document.title = t.value('meta.title');
                if (window.location.hash.startsWith('#config=')) { const compressed = window.location.hash.substring(8); try { const data = LZString.decompressFromEncodedURIComponent(compressed); if (!data) throw new Error(t.value('import.urlErrorInvalid')); const importedData = JSON.parse(data); if (Array.isArray(importedData)) importedConfigFromUrl.value = importedData; window.location.hash = ''; } catch (e) { showToast(t.value('import.error', { message: e.message }), 'error'); window.location.hash = ''; }}
                try {
                    isAutoUpdateEnabled.value = localStorage.getItem('stremioAutoUpdateEnabled') === 'true';
                    lastUpdateCheck.value = localStorage.getItem('stremioLastAutoUpdate');
                } catch (e) { console.warn("Error reading auto-update settings from localStorage."); }
                scheduleUpdateCheck();
                try {
                    const storedKey = sessionStorage.getItem('stremioAuthKey'); const storedList = sessionStorage.getItem('stremioAddonList'); const storedEmail = sessionStorage.getItem('stremioEmail'); const storedMonitoring = sessionStorage.getItem('stremioIsMonitoring') === 'true';
                    if (storedKey && storedList) {
                        authKey.value = storedKey; email.value = storedEmail || ''; isMonitoring.value = storedMonitoring; if(isMonitoring.value) targetEmail.value = storedEmail || '';
                         addons.value = JSON.parse(storedList).map(a => mapAddon(a));
                        isLoggedIn.value = true;
                        showToast(t.value('addon.sessionRestored'), 'info');
                        
                        // --- Logica Benvenuto/Tour (RIPRISTINATA) ---
                        showWelcomeScreen.value = true; // Mostra sempre il pannello setup
                    }
                } catch(e) { console.error("Error restoring session:", e); sessionStorage.clear(); }
            });
            onBeforeUnmount(() => { window.removeEventListener('beforeunload', beforeUnloadHandler); window.removeEventListener('resize', updateIsMobile); });
            // --- Return ---
            return { email, password, authKey, addons, isLoggedIn, isLoading, newAddonUrl, fileInput, adminClickCount, showAdminInput, adminKey, targetEmail, isMonitoring, searchQuery, filteredAddons, login, logout, incrementAdminClick, monitorLogin, exportBackup, triggerFileInput, handleFileImport, checkAllAddonsStatus, addNewAddon, saveOrder, startEdit, finishEdit, moveUp, moveDown, moveTop, moveBottom, removeAddon, toggleAddonEnabled, openConfiguration, copyManifestUrl, hasUnsavedChanges, history, redoStack, undo, redo, activeFilter, draggableList, onDragEnd, lang, t, shareUrl, shareInput, generateShareLink, copyShareLink, importedConfigFromUrl, selectedAddons, allSelected, toggleSelectAll, enableSelected, disableSelected, removeSelected, showSearchInput, searchInputRef, toggleSearch, hideSearchOnBlur, showInstructions, dragOptions, showImportConfirm, confirmImport, closeImportConfirm, importSource, toasts, showToast, enabledCount, disabledCount, errorCount, testAddonSpeed,
                 toggleAddonDetails, getResourceNames, isAutoUpdateEnabled, lastUpdateCheck, isUpdating, runAutoUpdate,
                 showWelcomeScreen, dismissWelcomeScreen, refreshAddonList, exportTxt,
                 // --- Return per Tour ---
                 showWelcomeTourModal, dontShowWelcomeAgain, skipTour, beginTour
            };
        }
    });
    app.component('draggable', window.vuedraggable);
    app.mount('#app');
</script>
</body>
</html>

