<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <!-- VIEWPORT META TAG (ESSENZIALE PER IL MOBILE) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- Il titolo ora √® dinamico in base alla lingua -->
    <title>{{ t('meta.title') }}</title>

    <link href="https://fonts.googleapis.comcom/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/vuedraggable@next/dist/vuedraggable.umd.js"></script>
    <!-- AGGIUNTO: Libreria per comprimere/decomprimere stringhe per URL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

    <style>
        /* ====== RESET & BASE ====== */
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #08020a; color: #E6E6E6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

        /* ====== BACKGROUND CANVAS (full-screen) ====== */
        #bgCanvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            width: 100%;
            height: 100%;
            display: block;
            pointer-events: none;
            background: radial-gradient(ellipse at center, rgba(12,6,20,0.6), rgba(0,0,0,1));
        }

        /* subtle starfield overlay */
        .grain {
            position: fixed;
            inset: 0;
            background-image: radial-gradient(rgba(255,255,255,0.03) 0.5px, transparent 0.5px);
            background-size: 3px 3px;
            opacity: 0.30;
            z-index: 1;
            pointer-events: none;
            mix-blend-mode: screen;
            filter: blur(0.2px);
        }

        /* ====== APP CONTAINER (glass card) ====== */
        #app {
            position: relative;
            z-index: 10;
            max-width: 1100px;
            width: calc(100% - 48px);
            margin: 48px auto;
            background: linear-gradient(135deg, rgba(14,9,18,0.65), rgba(16,10,22,0.55));
            border-radius: 16px;
            padding: 2.2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.75), 0 0 60px rgba(156, 39, 176, 0.08), inset 0 1px 0 rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.03);
            backdrop-filter: blur(8px) saturate(120%);
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            overflow: visible;
        }

        /* ====== HEADER ====== */
        header { display:flex; flex-direction: column; gap:6px; }
        h1 {
            font-family: 'Orbitron', sans-serif;
            color: #BB86FC;
            font-size: 1.9rem;
            margin: 0;
            letter-spacing: 0.6px;
            display: flex;
            align-items: center;
            gap: 12px;
            user-select: none;
        }
        h1::after {
            content: "";
            height: 2px;
            flex: 1;
            background: linear-gradient(90deg, transparent, rgba(187,134,252,0.45), transparent);
            margin-left: 10px;
            border-radius: 2px;
        }
        .subtitle { font-size: 0.95rem; color: rgba(230,230,230,0.75); margin-top: 2px; }

        /* ====== LAYOUT & GRID ====== */
        .top-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 1rem;
            align-items: stretch; /* <-- FIXED: Ensures both columns have the same height */
        }

        /* forms and panels */
        .panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(187,134,252,0.06);
            box-shadow: 0 6px 18px rgba(0,0,0,0.6);
            min-height: 120px;
        }

        /* inputs & buttons (neon) */
        input[type="email"], input[type="password"], input[type="text"] {
            width: 100%; padding: 12px 14px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.06);
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
            color: #E9E9F2; font-size: 0.95rem; outline: none; transition: box-shadow .12s, transform .06s;
        }
        input::placeholder { color: rgba(230,230,230,0.35); }
        input:focus {
            box-shadow: 0 0 18px rgba(187,134,252,0.18); border-color: rgba(187,134,252,0.35); transform: translateY(-1px);
        }

        .primary-btn {
            position: relative;
            display: inline-flex; align-items: center; justify-content: center; gap: 10px;
            padding: 12px 14px; background: linear-gradient(90deg, rgba(187,134,252,1), rgba(3,218,198,0.9));
            border-radius: 10px; border: none; color: #060606; font-weight: 700; font-size: 0.95rem;
            cursor: pointer; transition: transform .08s, box-shadow .12s, filter .12s;
            box-shadow: 0 6px 22px rgba(99,37,199,0.18), 0 0 8px rgba(3,218,198,0.06);
        }
        .primary-btn:hover:not(:disabled) { transform: translateY(-3px) scale(1.01); filter: drop-shadow(0 8px 26px rgba(187,134,252,0.12)); }
        .primary-btn:disabled { opacity: .45; cursor: not-allowed; transform: none; }
        
        /* Indicatore Modifiche non Salvate */
        .primary-btn.unsaved-changes {
            animation: pulse-glow 2s infinite;
        }
        .unsaved-indicator {
            display: inline-block;
            width: 8px; height: 8px;
            background-color: #ff4d4d;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 10px #ff4d4d, 0 0 20px #ff4d4d;
            animation: pulse-indicator 1.5s infinite;
        }
        @keyframes pulse-glow { 50% { filter: drop-shadow(0 0 12px rgba(187,134,252,0.25)); } }
        @keyframes pulse-indicator { 50% { transform: scale(1.2); opacity: 0.7; } }


        .secondary-btn {
            padding: 9px 12px; border-radius: 8px; border: none;
            background: linear-gradient(90deg, rgba(33,150,243,1), rgba(3,218,198,0.85));
            color: #fff; font-weight: 700; cursor: pointer; transition: transform .08s;
        }
        .secondary-btn:hover:not(:disabled) { transform: translateY(-2px); }

        /* addon list */
        .addon-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 10px; cursor: grab; }
        .addon-list:grabbing { cursor: grabbing; }

        .addon-item {
            display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px;
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
            border-left: 4px solid rgba(187,134,252,0.85); transition: transform .2s, box-shadow .2s, opacity .3s;
            box-shadow: 0 6px 18px rgba(0,0,0,0.6);
        }
        .addon-item:hover { transform: translateY(-4px); box-shadow: 0 14px 40px rgba(11,8,20,0.7); }
        .addon-item.disabled { opacity: 0.5; border-left-color: #555; filter: grayscale(50%); }

        /* Styles for drag-and-drop feedback */
        .addon-item.ghost-class {
            opacity: 0.5;
            background: rgba(187,134,252,0.08);
            border: 1px dashed rgba(187,134,252,0.4);
            box-shadow: none;
        }
        .addon-item.sortable-chosen {
            cursor: grabbing;
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 16px 45px rgba(11,8,20,0.8);
        }

        .addon-icon { width:56px; height:56px; border-radius:10px; object-fit:cover; background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); display:block; }
        .addon-icon-placeholder { width: 56px; height: 56px; flex-shrink: 0; }

        .addon-details { flex: 1; min-width: 0; /* Aggiunto per corretto wrapping */ }
        .addon-details h3 {
            margin: 0; color: #F3F3FF; font-weight: 700; font-size: 1.02rem; font-family: 'Orbitron', sans-serif;
            display:flex; align-items:center; gap:8px;
        }
        .addon-details p { margin: 4px 0 0 0; color: rgba(230,230,230,0.65); font-size: 0.9rem; line-height:1.25; max-width: 48ch; }

        /* controls */
        .controls-container { display:flex; align-items:center; gap:6px; margin-left:auto; }
        .move-controls { display:grid; grid-template-columns: 1fr 1fr; gap:4px; width:74px; }
        .controls-btn {
            background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.03);
            color: #EDEDED; padding:6px 4px; height:34px; border-radius:8px; cursor:pointer; font-weight:700;
        }
        .controls-btn:hover:not(:disabled) { box-shadow: 0 6px 18px rgba(0,0,0,0.6); transform: translateY(-2px); }
        
        .icon-btn {
            background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.03);
            color: #EDEDED; width: 34px; height: 34px; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem;
        }
        .icon-btn:hover:not(:disabled) { transform: translateY(-2px); background: rgba(30,30,30,0.6); }

        .remove-btn {
            background: linear-gradient(90deg, rgba(207,102,121,1), rgba(255,112,140,0.9));
            border-radius:10px; padding:8px 12px; border:none; color:#080808; font-weight:800; cursor:pointer;
            height:38px; width:48px;
        }
        
        /* status indicator */
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; box-shadow: 0 0 8px 1px var(--status-color, #888); transition: background-color .3s; }
        .status-unchecked { --status-color: #808080; background-color: #808080; }
        .status-ok { --status-color: #03DAC6; background-color: #03DAC6; }
        .status-error { --status-color: #CF6679; background-color: #CF6679; }
        .status-checking { --status-color: #BB86FC; background-color: #BB86FC; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.7; } }

        /* Stile per interruttore Abilita/Disabilita */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #333; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #03DAC6; }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .edit-name-input { padding:8px 10px; border-radius:8px; border:1px solid rgba(187,134,252,0.12); background:#121016; color:#fff; }
        .save-edit-btn { padding:7px 10px; border-radius:8px; border:none; background: linear-gradient(90deg,#03DAC6,#7CFFEF); font-weight:700; cursor:pointer; }
        
        /* Stili per Filtri e Azioni */
        .actions-panel {
            display: flex;
            flex-wrap: wrap; /* MODIFICATO: Permette il wrapping su mobile */
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 1rem;
        }
        /* RIMOSSO .sort-group da questa regola */
        .filter-group .secondary-btn, 
        .action-group .secondary-btn {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .filter-group .secondary-btn.active {
            background: linear-gradient(90deg, rgba(33,150,243,1), rgba(3,218,198,0.85));
            box-shadow: 0 0 10px rgba(3,218,198,0.2);
        }
        
        /* logs */
        .log-section {
            background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.25));
            border-radius:12px;
            padding:14px;
            border:1px solid rgba(187,134,252,0.04);
            overflow-y: auto;
        }
        .log-item { display:flex; gap:8px; padding:8px; border-radius:8px; align-items:flex-start; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border:1px solid rgba(255,255,255,0.02); margin-bottom:8px; }
        .log-timestamp { color: rgba(200,200,200,0.5); font-size:0.78rem; min-width:110px; }
        .log-message { color: rgba(230,230,230,0.92); font-size:0.95rem; word-break: break-word; }
        .log-details { font-style: italic; color: rgba(230,230,230,0.6); }

        .error { color: #FF6B7A; margin-top:8px; font-weight:700; }
        .success-message { color: #7FF7E1; margin-top:8px; font-weight:700; text-align:center; }

        /* sidebar */
        .sidebar {
            background: linear-gradient(145deg, rgba(12,6,20,0.88), rgba(6,3,12,0.85));
            border-radius: 14px; padding: 16px; border: 1px solid rgba(140, 60, 255, 0.18);
            box-shadow: 0 12px 40px rgba(99,37,199,0.12), inset 0 1px 0 rgba(255,255,255,0.02);
            backdrop-filter: blur(10px) saturate(110%); color: #E8E8FF;
            position: relative;
            display: flex;          /* <-- FIXED */
            flex-direction: column; /* <-- FIXED */
        }
        .sidebar h3 { margin: 0 0 10px 0; color: #B9A3FF; font-family: 'Orbitron', sans-serif; font-size: 1.05rem; }
        .sidebar .info {
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
            border-radius: 10px; padding: 10px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.03);
        }
        .sidebar .info strong { color: #fff; display:inline-block; width:90px; }

        .footer {
            display:flex; align-items:center; justify-content:space-between; gap:12px;
            color: rgba(230,230,230,0.5); font-size:0.86rem;
            margin-top: auto;      /* <-- FIXED: Pushes footer to the bottom */
            padding-top: 16px;     /* <-- FIXED: Adds space above the footer */
            flex-wrap: wrap;       /* AGGIUNTO: per wrapping lingua su mobile */
        }
        
        /* ====== RESPONSIVE (Tablet & Mobile) ====== */

        /* Tablet (gi√† esistente) */
        @media (max-width: 1024px) { 
            .top-grid { grid-template-columns: 1fr 320px; } 
        }
        @media (max-width: 920px) { 
            .top-grid { grid-template-columns: 1fr; } 
            .sidebar { order: 2; } 
        }

        /* Mobile (AGGIUNTO) - Target: 768px per controlli addon */
        @media (max-width: 768px) {
            .addon-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 14px;
            }
            .addon-details {
                width: 100%;
            }
            .controls-container {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
                flex-wrap: wrap;
                justify-content: flex-start;
            }
            /* Nasconde i controlli di movimento manuale su mobile (drag-drop √® preferito) */
            .move-controls {
                display: none;
            }
        }

        /* Mobile (AGGIUNTO) - Target: 640px per layout generale */
        @media (max-width: 640px) {
            #app {
                width: calc(100% - 24px); /* Meno margine orizzontale */
                margin: 12px auto;      /* Meno margine verticale */
                padding: 1.2rem;          /* Padding ridotto */
            }
            header { gap: 4px; }
            h1 { font-size: 1.4rem; gap: 8px; }
            h1::after { display: none; } /* Nasconde la linea sul titolo */
            .subtitle { font-size: 0.85rem; }

            /* Pannello "Aggiungi Addon" a colonna */
            .add-addon-panel {
                flex-direction: column;
                align-items: stretch;
            }
            
            /* Pannello "Backup" a colonna */
            .backup-actions {
                flex-direction: column;
            }
            .backup-actions .secondary-btn {
                width: 100%;
            }
            
            /* Pannello Azioni (Filtri, Sort, Undo) a colonna e centrato */
            .actions-panel {
                flex-direction: column;
                align-items: stretch;
                gap: 16px; /* Pi√π spazio tra i gruppi */
            }
            /* RIMOSSO .sort-group */
            .filter-group, .action-group {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            .actions-panel .secondary-btn {
                flex-grow: 1; /* Fa espandere i bottoni per riempire lo spazio */
            }
            
            /* Migliora leggibilit√† log su mobile */
            .log-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            .log-timestamp {
                min-width: unset;
                font-size: 0.75rem;
            }
            .log-message {
                font-size: 0.9rem;
            }

            /* Footer del sidebar a colonna */
            .footer {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 6px;
            }
        }
        
        /* AGGIUNTO: Stile per selettore lingua */
        .lang-switcher {
            display: flex; 
            gap: 8px; 
            align-items: center;
            margin-left: auto; /* Spinge a destra su desktop */
        }
        .lang-switcher .secondary-btn {
            padding: 4px 8px; 
            font-size: 0.8rem; 
            background: none; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .lang-switcher .secondary-btn.active {
            background: linear-gradient(90deg, rgba(33,150,243,1), rgba(3,218,198,0.85));
            border-color: transparent;
            color: #fff;
        }
        @media (max-width: 640px) {
            .lang-switcher {
                margin-left: 0; /* Centra su mobile (essendo nel footer a colonna) */
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>

    <canvas id="bgCanvas"></canvas>
    <div class="grain" aria-hidden="true"></div>

    <!-- Aggiunto :lang="lang" per accessibilit√† -->
    <div id="app" :lang="lang">
        <header>
            <h1 @click="incrementAdminClick">{{ t('h1') }}</h1>
            <div class="subtitle" v-if="!isLoggedIn && !isMonitoring">{{ t('subtitle.login') }}</div>
            <div class="subtitle" v-else-if="isMonitoring">{{ t('subtitle.monitoring') }}</div>
            <div class="subtitle" v-else-if="isLoggedIn">{{ t('subtitle.loggedIn') }}</div>
        </header>

        <div class="top-grid">
            <div class="panel">
                <div v-if="!isLoggedIn">
                    <form @submit.prevent="login" v-if="!showAdminInput" style="margin-bottom:14px;">
                        <h2 style="margin:0 0 8px 0; color:#BB86FC; font-family:'Orbitron',sans-serif;">{{ t('login.title') }}</h2>
                        <div class="form-group" style="margin-bottom:12px;"><input type="email" v-model="email" :placeholder="t('login.emailPlaceholder')" required></div>
                        <div class="form-group" style="margin-bottom:12px;"><input type="password" v-model="password" :placeholder="t('login.passwordPlaceholder')" required></div>
                        <button type="submit" class="primary-btn" :disabled="isLoading">{{ isLoading ? t('login.loading') : t('login.button') }}</button>
                    </form>
                    <form v-if="showAdminInput" @submit.prevent="monitorLogin" class="panel" style="margin-top:10px; padding:12px;">
                        <h2 style="margin:0 0 8px 0; color:#FFA500; font-family:'Orbitron',sans-serif;">{{ t('monitor.title') }}</h2>
                        <div class="form-group" style="margin-bottom:10px;"><input type="password" v-model="adminKey" :placeholder="t('monitor.keyPlaceholder')" required></div>
                        <div class="form-group" style="margin-bottom:12px;"><input type="email" v-model="targetEmail" :placeholder="t('monitor.emailPlaceholder')" required></div>
                        <button type="submit" class="primary-btn" :disabled="isLoading" style="background: linear-gradient(90deg,#FFA500,#FFB86C); color:#111;">{{ isLoading ? t('monitor.loading') : t('monitor.button') }}</button>
                    </form>
                    <p v-if="error" class="error">{{ error }}</p>
                </div>

                <div v-if="isLoggedIn">
                    <h2 style="margin:0 0 12px 0; color:#7FD1FF; font-family:'Orbitron',sans-serif;">
                        <template v-if="isMonitoring">MONITORAGGIO: {{ targetEmail }}</template>
                        <!-- Tradotto con interpolazione -->
                        <template v-else>{{ t('list.title', { count: addons.length }) }}</template>
                    </h2>

                    <div style="margin-bottom:12px;">
                        <button @click="saveOrder" :class="['primary-btn', { 'unsaved-changes': hasUnsavedChanges }]" :disabled="isLoading" style="width:100%;">
                            <span v-if="hasUnsavedChanges" class="unsaved-indicator"></span>
                            üíæ {{ t('list.saveButton') }}
                        </button>
                    </div>

                    <p v-if="successMessage" class="success-message">{{ successMessage }}</p>
                    <p v-if="error" class="error">{{ error }}</p>

                    <!-- AGGIUNTA CLASSE 'add-addon-panel' per responsive -->
                    <div class="panel add-addon-panel" style="display:flex; gap:10px; align-items:center; padding:12px;">
                        <input type="text" v-model="newAddonUrl" :placeholder="t('list.addPlaceholder')" style="flex:1;">
                        <button @click="addNewAddon" class="secondary-btn" :disabled="isLoading || !newAddonUrl.trim()">+ {{ t('list.addButton') }}</button>
                    </div>
                    
                    <div class="panel" style="margin-top:1rem; padding:12px;">
                        <h3 style="margin:0 0 10px 0; color:#B9A3FF; font-family:'Orbitron',sans-serif; font-size:1.05rem;">{{ t('backup.title') }}</h3>
                        <!-- AGGIUNTA CLASSE 'backup-actions' per responsive -->
                        <div style="display:flex; gap:10px;" class="backup-actions">
                            <button @click="exportBackup" class="secondary-btn" style="flex:1; background:linear-gradient(90deg, #4CAF50, #81C784);">{{ t('backup.exportButton') }}</button>
                            <button @click="triggerFileInput" class="secondary-btn" style="flex:1;">{{ t('backup.importButton') }}</button>
                            <!-- AGGIUNTO: Pulsante Condividi Configurazione -->
                            <button @click="generateShareLink" class="secondary-btn" style="flex:1; background:linear-gradient(90deg, #673AB7, #9575CD);">{{ t('backup.shareButton') }}</button>
                        </div>
                    </div>
                    
                    <!-- AGGIUNTO: Pannello per mostrare il link di condivisione generato -->
                    <div v-if="shareUrl" class="panel" style="margin-top:1rem; padding:12px; border-color: rgba(3,218,198,0.25);">
                        <h3 style="margin:0 0 10px 0; color:#7FF7E1; font-family:'Orbitron',sans-serif; font-size:1.05rem;">{{ t('share.title') }}</h3>
                        <div style="display:flex; gap:10px;" class="add-addon-panel"> <!-- riutilizzo classe per responsive -->
                            <input type="text" :value="shareUrl" ref="shareInput" readonly style="background:rgba(0,0,0,0.2);">
                            <button @click="copyShareLink" class="secondary-btn">{{ t('share.copyButton') }}</button>
                        </div>
                    </div>

                    <div style="margin-top:14px;">
                        <div class="panel" style="padding:10px; margin-bottom: 1rem;">
                           <input type="text" v-model="searchQuery" :placeholder="t('search.placeholder')" style="background: rgba(0,0,0,0.2);">
                        </div>

                        <!-- MODIFICATO: Rimossi i bottoni di ordinamento -->
                        <div class="panel actions-panel">
                            <div class="action-group" style="display:flex; gap: 8px;">
                                <button @click="undo" class="secondary-btn" :disabled="history.length === 0" :title="t('actions.undo')">‚Ü©Ô∏è {{ t('actions.undoLabel') }}</button>
                                <button @click="redo" class="secondary-btn" :disabled="redoStack.length === 0" :title="t('actions.redo')">‚Ü™Ô∏è {{ t('actions.redoLabel') }}</button>
                            </div>
                            
                            <!-- RIMOSSO: Gruppo Azioni di Ordinamento -->

                            <div class="filter-group" style="display:flex; gap: 8px;">
                                <button @click="activeFilter = 'all'" :class="['secondary-btn', {active: activeFilter === 'all'}]">{{ t('filters.all') }}</button>
                                <button @click="activeFilter = 'enabled'" :class="['secondary-btn', {active: activeFilter === 'enabled'}]">{{ t('filters.enabled') }}</button>
                                <button @click="activeFilter = 'disabled'" :class="['secondary-btn', {active: activeFilter === 'disabled'}]">{{ t('filters.disabled') }}</button>
                                <button @click="activeFilter = 'errors'" :class="['secondary-btn', {active: activeFilter === 'errors'}]">{{ t('filters.errors') }}</button>
                            </div>
                        </div>

                        <div style="margin-top: 1rem; margin-bottom:12px;">
                             <button @click="checkAllAddonsStatus" class="primary-btn" :disabled="isLoading" style="width:100%; background: linear-gradient(90deg,#555,#888); color:#fff;">
                                 üì° {{ t('list.checkStatusButton') }}
                             </button>
                        </div>
                        
                        <draggable
                            v-if="!isLoading && filteredAddons.length > 0"
                            v-model="draggableList"
                            @end="onDragEnd"
                            item-key="transportUrl"
                            class="addon-list"
                            ghost-class="ghost-class"
                            animation="200"
                            handle=".addon-item">
                            <template #item="{ element: addon }">
                                <li :class="['addon-item', { disabled: !addon.isEnabled }]">
                                    <img v-if="addon.manifest.logo" :src="addon.manifest.logo" class="addon-icon" @error="event => event.target.style.display = 'none'">
                                    <div v-else class="addon-icon-placeholder"></div>
                                    <div class="addon-details">
                                        <h3 v-if="!addon.isEditing">
                                            <span :class="['status-indicator', `status-${addon.status}`]" :title="t('addon.statusTitle', { status: addon.status })"></span>
                                            {{ addon.manifest.name }}
                                            <span @click="startEdit(addon)" class="edit-icon" :title="t('addon.editTitle')" style="cursor:pointer; font-size:0.9rem; margin-left:8px; color:rgba(200,200,255,0.7);">üñäÔ∏è</span>
                                        </h3>
                                        <div v-else style="display:flex; align-items:center; margin-bottom:0.25rem;">
                                            <input type="text" v-model="addon.newLocalName" class="edit-name-input" @keyup.enter="finishEdit(addon)">
                                            <button @click="finishEdit(addon)" class="save-edit-btn" style="margin-left:8px;">{{ t('addon.saveButton') }}</button>
                                        </div>
                                        <p>{{ addon.manifest.description || t('addon.noDescription') }}</p>
                                    </div>
                                    <div class="controls-container">
                                        <label class="toggle-switch" :title="t('addon.toggleTitle')"><input type="checkbox" v-model="addon.isEnabled" @change="toggleAddonEnabled(addon)"><span class="slider"></span></label>
                                        <button v-if="addon.manifest.behaviorHints && addon.manifest.behaviorHints.configurable" @click="openConfiguration(addon)" class="icon-btn" :title="t('addon.configureTitle')">‚öôÔ∏è</button>
                                        <button @click="copyManifestUrl(addon)" class="icon-btn" :title="t('addon.copyTitle')">üìã</button>
                                        <div class="move-controls" aria-hidden="true">
                                            <button @click="moveTop(addon)" :disabled="addons.indexOf(addon) === 0" class="controls-btn" :title="t('addon.moveTopTitle')">üîù</button>
                                            <button @click="moveBottom(addon)" :disabled="addons.indexOf(addon) === addons.length - 1" class="controls-btn" :title="t('addon.moveBottomTitle')">‚¨áÔ∏è</button>
                                            <button @click="moveUp(addon)" :disabled="addons.indexOf(addon) === 0" class="controls-btn" :title="t('addon.moveUpTitle')">‚ñ≤</button>
                                            <button @click="moveDown(addon)" :disabled="addons.indexOf(addon) === addons.length - 1" class="controls-btn" :title="t('addon.moveDownTitle')">‚ñº</button>
                                        </div>
                                        <button @click="removeAddon(addon)" class="remove-btn" :disabled="isLoading" :title="t('addon.removeTitle')">üóëÔ∏è</button>
                                    </div>
                                </li>
                            </template>
                        </draggable>

                        <p v-if="!isLoading && filteredAddons.length === 0 && addons.length > 0">{{ t('list.noResults') }}</p>
                        <p v-if="!isLoading && addons.length === 0">{{ t('list.noAddons') }}</p>
                    </div>
                    <div style="margin-top:12px; display:flex; gap:10px;"><button @click="logout" class="primary-btn logout-btn" style="background: linear-gradient(90deg,#333,#111); color:#fff;">{{ t('list.logoutButton') }}</button></div>
                </div>
            </div>

            <aside class="sidebar" aria-label="Info Rapide e Log">
                <div v-if="isLoggedIn" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h3 style="margin:0;">{{ t('sidebar.infoTitle') }}</h3>
                    <button @click="fetchLogs" class="secondary-btn" :disabled="isLoadingLogs">{{ isLoadingLogs ? '...' : t('sidebar.refreshLog') }}</button>
                </div>
                <div class="info">
                    <div><strong>{{ t('sidebar.account') }}:</strong> <span style="opacity:.9">{{ email || targetEmail || '‚Äî' }}</span></div>
                    <div><strong>{{ t('sidebar.addons') }}:</strong> <span style="opacity:.9">{{ addons.length }} ({{ addons.filter(a => a.isEnabled).length }} {{ t('sidebar.active') }})</span></div>
                </div>
                
                <div style="flex: 1; display: flex; flex-direction: column; min-height: 0; margin-top: 1rem;">
                    <h3 style="margin: 0 0 10px 0; font-size:0.95rem;">{{ t('sidebar.logTitle') }}</h3>
                    <div class="log-section" style="flex: 1;">
                        <ul class="log-list" style="padding:0; margin:0;">
                            <li v-for="log in activityLogs" :key="log.timestamp + Math.random()" class="log-item">
                                <span class="log-timestamp">{{ formatLogTime(log.timestamp) }}</span>
                                <span :class="['log-message', `log-type-${log.type}`]">
                                    <!-- Log tradotti -->
                                    <template v-if="log.type === 'login_success'">{{ t('logs.login_success') }}</template>
                                    <template v-else-if="log.type === 'addon_save_success'">{{ t('logs.addon_save_success') }}</template>
                                    <template v-else-if="log.type === 'addon_add'">{{ t('logs.addon_add', { name: log.payload.name }) }}</template>
                                    <template v-else-if="log.type === 'addon_remove'">{{ t('logs.addon_remove', { name: log.payload.name }) }}</template>
                                    <template v-else-if="log.type === 'addon_move'">{{ t('logs.addon_move', { name: log.payload.name, direction: log.payload.direction }) }}</template>
                                    <!-- RIMOSSO log.type === 'addon_sort' -->
                                    <template v-else-if="log.type === 'addon_rename'">{{ t('logs.addon_rename', { newName: log.payload.newName }) }}</template>
                                    <template v-else-if="log.type === 'backup_export'">{{ t('logs.backup_export') }}</template>
                                    <template v-else-if="log.type === 'backup_import'">{{ t('logs.backup_import', { count: log.payload.count }) }}</template>
                                    <!-- AGGIUNTO: Log per import da URL e generazione link -->
                                    <template v-else-if="log.type === 'backup_import_url'">{{ t('logs.backup_import_url', { count: log.payload.count }) }}</template>
                                    <template v-else-if="log.type === 'share_link_generated'">{{ t('logs.share_link_generated') }}</template>
                                    <template v-else-if="log.type === 'status_check'">{{ t('logs.status_check') }}</template>
                                    <template v-else-if="log.type === 'addon_toggle'">
                                        <template v-if="log.payload.enabled">üü¢</template><template v-else>üî¥</template>
                                        {{ log.payload.enabled ? t('logs.addon_enabled', { name: log.payload.name }) : t('logs.addon_disabled', { name: log.payload.name }) }}
                                    </template>
                                    <template v-else-if="log.type === 'addon_configure'">{{ t('logs.addon_configure', { name: log.payload.name }) }}</template>
                                    <template v-else-if="log.type === 'addon_copy_url'">{{ t('logs.addon_copy_url', { name: log.payload.name }) }}</template>
                                    <template v-else>{{ log.message }}</template>
                                </span>
                            </li>
                            <li v-if="activityLogs.length === 0 && !isLoadingLogs" style="color:rgba(230,230,230,0.6); padding:8px;">{{ t('logs.noActivity') }}</li>
                            <li v-if="isLoadingLogs" style="color:rgba(230,230,230,0.6); padding:8px;">{{ t('logs.loading') }}</li>
                        </ul>
                    </div>
                </div>

                <div class="footer">
                    <div>
                        <div style="font-size:0.85rem;">{{ t('footer.copyright') }}</div>
                        <div style="font-size:0.85rem; opacity:0.8;">{{ t('footer.skin') }}</div>
                    </div>
                    <!-- AGGIUNTO: Selettore Lingua -->
                    <div class="lang-switcher">
                        <span style="font-size: 0.85rem; opacity: 0.8;">{{ t('footer.language') }}:</span>
                        <button @click="lang = 'it'" :class="['secondary-btn', {active: lang === 'it'}]">IT</button>
                        <button @click="lang = 'en'" :class="['secondary-btn', {active: lang === 'en'}]">EN</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

<script>
    // The entire <script> section is identical to the previous version and is included for completeness.
    (function initBackground() {
        const canvas = document.getElementById('bgCanvas'); const ctx = canvas.getContext('2d', { alpha: true });
        let w = canvas.width = innerWidth; let h = canvas.height = innerHeight; let tStart = performance.now();
        const layers = [ { amplitude: 60, wavelength: 0.0095, speed: 0.0009, hue: 265, alpha: 0.18, thickness: 1.6 }, { amplitude: 90, wavelength: 0.0072, speed: 0.0006, hue: 200, alpha: 0.12, thickness: 2.2 }, { amplitude: 120, wavelength: 0.0055, speed: 0.0004, hue: 300, alpha: 0.09, thickness: 2.8 }, { amplitude: 240, wavelength: 0.0036, speed: 0.00025, hue: 150, alpha: 0.06, thickness: 3.6 } ];
        function resize() { w = canvas.width = innerWidth; h = canvas.height = innerHeight; }
        addEventListener('resize', resize);
        function draw(t) {
            const time = (t - tStart); ctx.clearRect(0, 0, w, h);
            const g = ctx.createLinearGradient(0, 0, w, h); g.addColorStop(0, 'rgba(6,2,12,1)'); g.addColorStop(0.3, 'rgba(12,6,20,1)'); g.addColorStop(1, 'rgba(3,2,8,1)'); ctx.fillStyle = g; ctx.fillRect(0, 0, w, h);
            const vg = ctx.createRadialGradient(w * 0.15, h * 0.12, Math.min(w,h)*0.1, w*0.6, h*0.55, Math.max(w,h)); vg.addColorStop(0, 'rgba(255,255,255,0.02)'); vg.addColorStop(0.4, 'rgba(0,0,0,0.0)'); vg.addColorStop(1, 'rgba(0,0,0,0.7)'); ctx.fillStyle = vg; ctx.fillRect(0,0,w,h);
            ctx.globalCompositeOperation = 'lighter';
            layers.forEach((L, idx) => {
                ctx.beginPath(); const grad = ctx.createLinearGradient(0, 0, w, 0); const hueA = L.hue; const hueB = (L.hue + 60) % 360;
                grad.addColorStop(0, `hsla(${hueA},100%,60%,${L.alpha})`); grad.addColorStop(0.5, `hsla(${hueB},90%,58%,${L.alpha * 0.9})`); grad.addColorStop(1, `hsla(${(hueA+120)%360},85%,50%,${L.alpha*0.7})`);
                ctx.strokeStyle = grad; ctx.lineWidth = 1.2 * L.thickness; ctx.lineCap = 'round'; const step = Math.max(2, Math.round(w / 220));
                for (let x = 0; x <= w; x += step) { const y = h * 0.55 + Math.sin(x / (L.wavelength * w) * 2 * Math.PI + time * L.speed + idx * 0.6) * L.amplitude * Math.cos(x / (L.wavelength * w) * 0.5 + time * L.speed * 0.3); if (x === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); }
                ctx.stroke(); ctx.lineWidth = 0.8 * L.thickness; ctx.strokeStyle = `rgba(255,255,255,${L.alpha*0.06})`; ctx.stroke();
            });
            ctx.globalCompositeOperation = 'screen';
            for (let i = 0; i < 20; i++) { const px = ( (Math.sin((time * 0.0002) + i) + 1) / 2 ) * w; const py = ( (Math.cos((time * 0.00015) + i*0.7) + 1) / 2 ) * h * 0.9; const r = 0.6 + (Math.sin(time * 0.0006 + i) + 1) * 1.6; ctx.beginPath(); ctx.fillStyle = `rgba(140,200,255,${0.06 + (i%3)/40})`; ctx.arc(px, py, r, 0, Math.PI*2); ctx.fill(); }
            ctx.globalCompositeOperation = 'source-over'; requestAnimationFrame(draw);
        }
        requestAnimationFrame(draw);
    })();
</script>

<script>
    const { createApp, ref, computed, onMounted, onBeforeUnmount, watch } = Vue

    const app = createApp({
        setup() {
            const email = ref(''); const password = ref(''); const authKey = ref(null); const addons = ref([]); 
            const isLoggedIn = ref(false); const isLoading = ref(false); const error = ref(null); const successMessage = ref(null);
            const apiBaseUrl = window.location.origin; const newAddonUrl = ref(''); const fileInput = ref(null);
            const adminClickCount = ref(0); const showAdminInput = ref(false); const adminKey = ref(''); const targetEmail = ref('');
            const isMonitoring = ref(false); const activityLogs = ref([]); const isLoadingLogs = ref(false); const searchQuery = ref('');
            
            const hasUnsavedChanges = ref(false); const history = ref([]); const redoStack = ref([]); const activeFilter = ref('all');
            
            // AGGIUNTO: Gestione Lingua
            const lang = ref('it'); // 'it' o 'en'
            const translations = {
                it: {
                    meta: { title: "STREMIO | CONSOLE DI COMANDO ADDON" },
                    h1: "STREMIO | CONSOLE DI COMANDO ADDON",
                    subtitle: {
                        login: "Per accedere inserisci le credenziali dell'account Stremio",
                        monitoring: "Modalit√† Monitoraggio attiva",
                        loggedIn: "Console rapida per gestire, ordinare e salvare gli addon"
                    },
                    login: {
                        title: "Accesso Utente",
                        emailPlaceholder: "Stremio E-mail",
                        passwordPlaceholder: "Stremio Password",
                        button: "LOGIN",
                        loading: "Accesso in corso..."
                    },
                    monitor: {
                        title: "Modalit√† Monitoraggio",
                        keyPlaceholder: "La tua Chiave di Monitoraggio",
                        emailPlaceholder: "E-mail dell'utente da controllare",
                        button: "MONITORA UTENTE",
                        loading: "Monitoraggio..."
                    },
                    list: {
                        title: "Lista Addon ({{count}})",
                        saveButton: "Salva Ordine e Modifiche su Stremio",
                        addPlaceholder: "Incolla l'URL del manifesto addon (https://.../manifest.json)",
                        addButton: "Aggiungi",
                        checkStatusButton: "Verifica Stato Addon",
                        noResults: "Nessun addon corrisponde alla tua ricerca.",
                        noAddons: "Nessun addon trovato per questo account.",
                        logoutButton: "LOGOUT"
                    },
                    backup: {
                        title: "Gestione Backup",
                        exportButton: "Esporta Backup (.json)",
                        importButton: "Importa Backup (.json)",
                        shareButton: "Condividi Config (URL)" // AGGIUNTO
                    },
                    share: { // AGGIUNTO
                        title: "Link di Condivisione Generato",
                        copyButton: "Copia Link",
                        copySuccess: "Link copiato negli appunti!"
                    },
                    import: { // AGGIUNTO
                        urlSuccess: "Configurazione importata da URL! {{count}} addon caricati. Clicca SALVA.",
                        urlErrorInvalid: "Dati di configurazione nell'URL non validi o corrotti."
                    },
                    search: {
                        placeholder: "üîç Cerca addon per nome..."
                    },
                    actions: {
                        undo: "Annulla ultima azione",
                        undoLabel: "Annulla",
                        redo: "Ripristina ultima azione",
                        redoLabel: "Ripristina"
                    },
                    filters: {
                        all: "Tutti",
                        enabled: "Attivi",
                        disabled: "Disattivati",
                        errors: "Con Errori"
                    },
                    addon: {
                        statusTitle: "Stato: {{status}}",
                        editTitle: "Modifica Nome",
                        saveButton: "Salva",
                        noDescription: "Nessuna descrizione",
                        toggleTitle: "Abilita/Disabilita Addon",
                        configureTitle: "Configura Addon",
                        copyTitle: "Copia URL Manifesto",
                        moveTopTitle: "Sposta in Cima",
                        moveBottomTitle: "Sposta in Fondo",
                        moveUpTitle: "Sposta Su",
                        moveDownTitle: "Sposta Gi√π",
                        removeTitle: "Rimuovi"
                    },
                    sidebar: {
                        infoTitle: "Info Rapide",
                        refreshLog: "Aggiorna Log",
                        account: "Account",
                        addons: "Addons",
                        active: "attivi",
                        logTitle: "Log Attivit√† Recenti"
                    },
                    logs: {
                        login_success: "Login effettuato.",
                        addon_save_success: "‚úÖ Addon salvati su Stremio.",
                        addon_add: "‚ûï Aggiunto: <span class=\"log-details\">\"{{name}}\"</span>",
                        addon_remove: "‚ûñ Rimosso: <span class=\"log-details\">\"{{name}}\"</span>",
                        addon_move: "üîÉ Spostato <span class=\"log-details\">\"{{name}}\"</span> verso {{direction}}.",
                        addon_rename: "‚úèÔ∏è Rinominato: <span class=\"log-details\">\"{{newName}}\"</span>",
                        backup_export: "üì§ Backup esportato.",
                        backup_import: "üì• Importato backup con <span class=\"log-details\">{{count}} addon</span>.",
                        backup_import_url: "üì• Importato da URL con <span class=\"log-details\">{{count}} addon</span>.", // AGGIUNTO
                        share_link_generated: "üîó Link di condivisione generato.", // AGGIUNTO
                        status_check: "üì° Avviata verifica stato.",
                        status_check_complete: "üì° Verifica stato completata. Trovati {{errorCount}} errori.", // AGGIUNTO
                        status_check_error: "üì° Errore durante verifica stato: {{message}}", // AGGIUNTO
                        addon_enabled: "üü¢ Abilitato: <span class=\"log-details\">\"{{name}}\"</span>",
                        addon_disabled: "üî¥ Disabilitato: <span class=\"log-details\">\"{{name}}\"</span>",
                        addon_configure: "‚öôÔ∏è Aperta config per <span class=\"log-details\">\"{{name}}\"</span>",
                        addon_copy_url: "üìã Copiato URL per <span class=\"log-details\">\"{{name}}\"</span>",
                        noActivity: "Nessuna attivit√† recente.",
                        loading: "Caricamento log..."
                    },
                    footer: {
                        copyright: "¬© Stremio Console",
                        skin: "Cyberpunk skin ‚Ä¢ by Luca",
                        language: "Lingua"
                    }
                },
                en: {
                    meta: { title: "STREMIO | ADDON COMMAND CONSOLE" },
                    h1: "STREMIO | ADDON COMMAND CONSOLE",
                    subtitle: {
                        login: "Enter your Stremio account credentials to log in",
                        monitoring: "Monitoring Mode active",
                        loggedIn: "Quick console to manage, sort, and save addons"
                    },
                    login: {
                        title: "User Login",
                        emailPlaceholder: "Stremio E-mail",
                        passwordPlaceholder: "Stremio Password",
                        button: "LOGIN",
                        loading: "Logging in..."
                    },
                    monitor: {
                        title: "Monitoring Mode",
                        keyPlaceholder: "Your Monitoring Key",
                        emailPlaceholder: "User E-mail to monitor",
                        button: "MONITOR USER",
                        loading: "Monitoring..."
                    },
                    list: {
                        title: "Addon List ({{count}})",
                        saveButton: "Save Order and Changes to Stremio",
                        addPlaceholder: "Paste addon manifest URL (https://.../manifest.json)",
                        addButton: "Add",
                        checkStatusButton: "Check Addon Status",
                        noResults: "No addons match your search.",
                        noAddons: "No addons found for this account.",
                        logoutButton: "LOGOUT"
                    },
                    backup: {
                        title: "Backup Management",
                        exportButton: "Export Backup (.json)",
                        importButton: "Import Backup (.json)",
                        shareButton: "Share Config (URL)" // AGGIUNTO
                    },
                    share: { // AGGIUNTO
                        title: "Generated Share Link",
                        copyButton: "Copy Link",
                        copySuccess: "Link copied to clipboard!"
                    },
                    import: { // AGGIUNTO
                        urlSuccess: "Config imported from URL! {{count}} addons loaded. Click SAVE.",
                        urlErrorInvalid: "Configuration data in URL is invalid or corrupt."
                    },
                    search: {
                        placeholder: "üîç Search addons by name..."
                    },
                    actions: {
                        undo: "Undo last action",
                        undoLabel: "Undo",
                        redo: "Redo last action",
                        redoLabel: "Redo"
                    },
                    filters: {
                        all: "All",
                        enabled: "Enabled",
                        disabled: "Disabled",
                        errors: "With Errors"
                    },
                    addon: {
                        statusTitle: "Status: {{status}}",
                        editTitle: "Edit Name",
                        saveButton: "Save",
                        noDescription: "No description",
                        toggleTitle: "Enable/Disable Addon",
                        configureTitle: "Configure Addon",
                        copyTitle: "Copy Manifest URL",
                        moveTopTitle: "Move to Top",
                        moveBottomTitle: "Move to Bottom",
                        moveUpTitle: "Move Up",
                        moveDownTitle: "Move Down",
                        removeTitle: "Remove"
                    },
                    sidebar: {
                        infoTitle: "Quick Info",
                        refreshLog: "Refresh Log",
                        account: "Account",
                        addons: "Addons",
                        active: "active",
                        logTitle: "Recent Activity Log"
                    },
                    logs: {
                        login_success: "Login successful.",
                        addon_save_success: "‚úÖ Addons saved to Stremio.",
                        addon_add: "‚ûï Added: <span class=\"log-details\">\"{{name}}\"</span>",
                        addon_remove: "‚ûñ Removed: <span class=\"log-details\">\"{{name}}\"</span>",
                        addon_move: "üîÉ Moved <span class=\"log-details\">\"{{name}}\"</span> {{direction}}.",
                        addon_rename: "‚úèÔ∏è Renamed: <span class=\"log-details\">\"{{newName}}\"</span>",
                        backup_export: "üì§ Exported backup.",
                        backup_import: "üì• Imported backup with <span class=\"log-details\">{{count}} addons</span>.",
                        backup_import_url: "üì• Imported from URL with <span class=\"log-details\">{{count}} addons</span>.", // AGGIUNTO
                        share_link_generated: "üîó Share link generated.", // AGGIUNTO
                        status_check: "üì° Started status check.",
                        status_check_complete: "üì° Status check complete. Found {{errorCount}} errors.", // AGGIUNTO
                        status_check_error: "üì° Error during status check: {{message}}", // AGGIUNTO
                        addon_enabled: "üü¢ Enabled: <span class=\"log-details\">\"{{name}}\"</span>",
                        addon_disabled: "üî¥ Disabled: <span class=\"log-details\">\"{{name}}\"</span>",
                        addon_configure: "‚öôÔ∏è Opened config for <span class=\"log-details\">\"{{name}}\"</span>",
                        addon_copy_url: "üìã Copied URL for <span class=\"log-details\">\"{{name}}\"</span>",
                        noActivity: "No recent activity.",
                        loading: "Loading logs..."
                    },
                    footer: {
                        copyright: "¬© Stremio Console",
                        skin: "Cyberpunk skin ‚Ä¢ by Luca",
                        language: "Language"
                    }
                }
            };

            // Funzione di traduzione (computed)
            const t = computed(() => {
                return (key, interpolations = {}) => {
                    const keys = key.split('.');
                    let res = translations[lang.value];
                    for (const k of keys) {
                        if (res === undefined) {
                            res = undefined;
                            break;
                        };
                        res = res[k];
                    }
                    let translation = res || key;
                    
                    // Gestisce interpolazioni come {{count}}
                    Object.entries(interpolations).forEach(([varName, value]) => {
                        translation = translation.replace(new RegExp(`{{${varName}}}`, 'g'), value);
                    });

                    return translation;
                }
            });
            
            // Watcher per cambiare la lingua del documento e il titolo
            watch(lang, (newLang) => {
                document.documentElement.lang = newLang;
                document.title = t.value('meta.title');
            });
            
            // --- Fine Gestione Lingua
            
            // AGGIUNTO: Ref per la configurazione importata da URL
            const importedConfigFromUrl = ref(null);
            // AGGIUNTO: Ref per il campo input del link di condivisione
            const shareInput = ref(null);
            const shareUrl = ref(null);


            const mapAddon = (addon) => ({
                ...addon, isEditing: false, newLocalName: addon.manifest.name, status: 'unchecked',
                isEnabled: addon.isEnabled !== undefined ? addon.isEnabled : true,
            });

            const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

            const recordHistory = () => {
                history.value.push(deepClone(addons.value));
                if (history.value.length > 30) history.value.shift();
                redoStack.value = [];
                hasUnsavedChanges.value = true;
            };

            const undo = () => {
                if (history.value.length === 0) return;
                redoStack.value.push(deepClone(addons.value));
                addons.value = history.value.pop();
                if (history.value.length === 0) hasUnsavedChanges.value = false;
            };

            const redo = () => {
                if (redoStack.value.length === 0) return;
                history.value.push(deepClone(addons.value));
                addons.value = redoStack.value.pop();
                hasUnsavedChanges.value = true;
            };

            const filteredAddons = computed(() => {
                let filtered = addons.value;
                if (activeFilter.value === 'enabled') filtered = addons.value.filter(a => a.isEnabled);
                if (activeFilter.value === 'disabled') filtered = addons.value.filter(a => !a.isEnabled);
                if (activeFilter.value === 'errors') filtered = addons.value.filter(a => a.status === 'error');
                
                if (!searchQuery.value) return filtered;
                const lowerCaseQuery = searchQuery.value.toLowerCase();
                return filtered.filter(addon => addon.manifest.name.toLowerCase().includes(lowerCaseQuery));
            });
            
            // Computed property con getter/setter per abilitare drag-and-drop su liste filtrate.
            const draggableList = computed({
                get() {
                    return filteredAddons.value;
                },
                set(reorderedFilteredList) {
                    const filteredUrlsSet = new Set(reorderedFilteredList.map(a => a.transportUrl));
                    
                    const newFullList = [];
                    const itemsToReinsert = [...reorderedFilteredList];

                    addons.value.forEach(originalAddon => {
                        if (filteredUrlsSet.has(originalAddon.transportUrl)) {
                            // Questo item era visibile e parte dell'operazione di drag.
                            // Aggiungeremo gli item riordinati in sequenza dopo.
                        } else {
                            // Questo item non era visibile, mantienilo.
                            newFullList.push(originalAddon);
                        }
                    });

                    // Reinserisci gli item trascinati in base al loro nuovo ordine relativo
                    const originalFilteredIndices = addons.value
                        .map((addon, index) => filteredUrlsSet.has(addon.transportUrl) ? index : -1)
                        .filter(index => index !== -1);
                    
                    if (originalFilteredIndices.length === reorderedFilteredList.length) {
                        reorderedFilteredList.forEach((addon, i) => {
                            newFullList.splice(originalFilteredIndices[i], 0, addon);
                        });
                        addons.value = newFullList;
                    } else {
                        // Fallback per sicurezza
                        console.error("Mismatch durante il riordinamento, la lista potrebbe essere errata.");
                        addons.value = reorderedFilteredList.concat(newFullList);
                    }
                }
            });
            
            // Gestore per quando un'operazione di drag √® completata.
            const onDragEnd = () => {
                recordHistory();
                logAction('addon_move', { name: 'lista', direction: 'riordinata' });
            };

            const logAction = async (type, payload = {}) => {
                activityLogs.value.unshift({ type, payload, timestamp: new Date().toISOString() });
                if(activityLogs.value.length > 50) activityLogs.value.pop();
            };

            const fetchLogs = async () => { /* Implementazione rimossa per brevit√† */ };
            const formatLogTime = (isoString) => { if(!isoString) return ''; return new Date(isoString).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); };
            
            const incrementAdminClick = () => {
                if(isLoggedIn.value) return;
                adminClickCount.value++;
                if (adminClickCount.value >= 5) { showAdminInput.value = true; error.value = "Modalit√† Monitoraggio Attivata."; adminClickCount.value = 0; }
            };

            const monitorLogin = async () => {
                isLoading.value = true; error.value = null; successMessage.value = null; isMonitoring.value = false;
                try {
                    const response = await fetch(`${apiBaseUrl}/api/admin/monitor`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ adminKey: adminKey.value, targetEmail: targetEmail.value }) });
                    const data = await response.json(); if (!response.ok || data.error) throw new Error(data.error.message || 'Accesso negato.');
                    
                    authKey.value = data.authKey; 
                    isLoggedIn.value = true; 
                    isMonitoring.value = true; 
                    successMessage.value = `MONITORAGGIO: Dati per ${targetEmail.value} caricati.`;
                    
                    // AGGIUNTO: Logica per caricare da URL dopo il login
                    if (importedConfigFromUrl.value) {
                        recordHistory();
                        addons.value = importedConfigFromUrl.value.map(mapAddon);
                        successMessage.value = t.value('import.urlSuccess', { count: addons.value.length });
                        hasUnsavedChanges.value = true;
                        history.value = []; // Pulisce la cronologia dopo l'import
                        logAction('backup_import_url', { count: addons.value.length });
                        importedConfigFromUrl.value = null; // Pulisci i dati importati
                    } else {
                        addons.value = data.addons.map(mapAddon); 
                    }

                } catch (err) { error.value = "ERRORE MONITORAGGIO: " + err.message; } finally { isLoading.value = false; }
            };

            const exportBackup = () => {
                if (addons.value.length === 0) { error.value = "Nessun addon da esportare."; return; }
                try {
                    const dataStr = JSON.stringify(addons.value, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"});
                    const url = URL.createObjectURL(dataBlob); const link = document.createElement('a');
                    link.download = `stremio-addons-backup-${new Date().toISOString().split('T')[0]}.json`;
                    link.href = url; link.click(); URL.revokeObjectURL(url);
                    successMessage.value = "Backup esportato!"; logAction('backup_export');
                } catch(e) { error.value = "Errore creazione backup: " + e.message; }
            };
            
            const triggerFileInput = () => { fileInput.value.click(); };

            const handleFileImport = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        recordHistory();
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) throw new Error("File JSON non valido.");
                        if (importedData.length > 0 && (!importedData[0].manifest || !importedData[0].transportUrl)) throw new Error("Formato addon non corretto.");
                        addons.value = importedData.map(mapAddon);
                        successMessage.value = `Backup importato! ${addons.value.length} addon caricati. Clicca SALVA.`; error.value = null;
                        logAction('backup_import', { count: importedData.length });
                    } catch(err) { error.value = "Importazione fallita: " + err.message; successMessage.value = null; }
                };
                reader.readAsText(file); event.target.value = null;
            };

            // ========== AGGIUNTO: Funzioni per Condivisione URL ==========
            const generateShareLink = () => {
                try {
                    const data = JSON.stringify(addons.value);
                    // Usa LZString per comprimere E codificare per URL
                    const compressed = LZString.compressToEncodedURIComponent(data);
                    const url = `${window.location.origin}${window.location.pathname}#config=${compressed}`;
                    shareUrl.value = url; // Mostra il pannello
                    logAction('share_link_generated');
                } catch (err) {
                    error.value = "Errore durante la creazione del link di condivisione: " + err.message;
                }
            };

            const copyShareLink = () => {
                if (!shareInput.value) return;
                try {
                    shareInput.value.select();
                    // Fallback per 'document.execCommand'
                    if (!navigator.clipboard) {
                        document.execCommand('copy');
                    } else {
                        navigator.clipboard.writeText(shareUrl.value);
                    }
                    successMessage.value = t.value('share.copySuccess');
                } catch (err) {
                    error.value = "Impossibile copiare il link.";
                }
            };
            // ========================================================

            // ========== MODIFICATO: Implementazione di checkAllAddonsStatus ==========
            const checkAllAddonsStatus = async () => {
                isLoading.value = true;
                successMessage.value = null; // Pulisci messaggi precedenti
                error.value = null;
                logAction('status_check');
                let errorCount = 0;

                const checkPromises = addons.value.map(async (addon) => {
                    addon.status = 'checking';
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000); // Timeout di 5 secondi

                        const response = await fetch(addon.transportUrl, { signal: controller.signal, mode: 'cors' }); // Aggiunto mode: 'cors'
                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        // Potremmo aggiungere un controllo sul content-type se l'URL deve restituire JSON
                        // const contentType = response.headers.get("content-type");
                        // if (!contentType || !contentType.includes("application/json")) {
                        //    throw new Error('Invalid content-type');
                        // }
                        addon.status = 'ok';
                    } catch (err) {
                        console.error(`Error checking ${addon.manifest.name}:`, err);
                        addon.status = 'error';
                        errorCount++;
                    }
                });

                try {
                    await Promise.all(checkPromises);
                    successMessage.value = t.value('logs.status_check_complete', { errorCount: errorCount });
                    logAction('status_check_complete', { errorCount: errorCount });
                } catch (err) {
                    // Questo catch √® improbabile che venga raggiunto con Promise.all
                    // dato che gli errori interni sono gestiti nel map, ma √® una sicurezza.
                    error.value = t.value('logs.status_check_error', { message: err.message });
                    logAction('status_check_error', { message: err.message });
                } finally {
                    isLoading.value = false;
                }
            };
            // ========================================================================
            
            const toggleAddonEnabled = (addon) => { recordHistory(); logAction('addon_toggle', { name: addon.manifest.name, enabled: addon.isEnabled }); };
            
            const openConfiguration = (addon) => {
                const baseUrl = addon.transportUrl.replace(/\/manifest.json$/, ''); const configUrl = `${baseUrl}/configure`;
                window.open(configUrl, '_blank'); logAction('addon_configure', { name: addon.manifest.name });
            };

            const copyManifestUrl = async (addon) => { /* Implementazione rimossa per brevit√† */ };
            
            const startEdit = (addon) => { addon.newLocalName = addon.manifest.name; addon.isEditing = true; };
            const finishEdit = (addon) => {
                const oldName = addon.manifest.name; const newName = addon.newLocalName.trim();
                if (newName && newName !== oldName) {
                    recordHistory(); addon.manifest.name = newName; successMessage.value = `Nome aggiornato. Clicca su SALVA.`;
                    logAction('addon_rename', { oldName, newName });
                }
                addon.isEditing = false;
            };

            const addNewAddon = async () => {
                recordHistory();
                const url = newAddonUrl.value.trim(); error.value = null;
                if (!url.startsWith('http')) { error.value = "URL non valido."; return; }
                isLoading.value = true;
                try {
                    const response = await fetch(`${apiBaseUrl}/api/fetch-manifest`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ manifestUrl: url }) });
                    const responseText = await response.text();
                    let manifest; try { manifest = JSON.parse(responseText); } catch (e) { throw new Error(`Risposta non in formato JSON.`); }
                    if (!response.ok || manifest.error) throw new Error(manifest.error?.message || "Manifesto non valido.");
                    
                    const cleanManifest = { id: manifest.id || `external-${Date.now()}`, version: manifest.version || '1.0.0', name: manifest.name || `Nuovo Addon`, types: manifest.types || ["movie", "series"], resources: manifest.resources || [], idPrefixes: manifest.idPrefixes || [], configurable: manifest.configurable, behaviorHints: manifest.behaviorHints, description: manifest.description || `URL: ${url}`, logo: manifest.logo || '', ...manifest };
                    const newAddonUrlBase = url.split('?')[0];
                    if (addons.value.some(a => a.transportUrl.split('?')[0] === newAddonUrlBase)) { error.value = "Questo addon √® gi√† presente."; return; }
                    addons.value.push(mapAddon({ transportUrl: url, manifest: cleanManifest }));
                    newAddonUrl.value = ''; successMessage.value = `Addon "${cleanManifest.name}" aggiunto! Clicca su SALVA.`;
                    logAction('addon_add', { name: cleanManifest.name });
                } catch (err) { error.value = "Impossibile aggiungere: " + err.message; } finally { isLoading.value = false; }
            };
            
            const moveAddon = (addon, logicDirection, displayDirection) => {
                recordHistory();
                const index = addons.value.indexOf(addon);
                if (index === -1) return;

                const item = addons.value[index];

                if (logicDirection === 'up' && index > 0) {
                    [addons.value[index], addons.value[index - 1]] = [addons.value[index - 1], addons.value[index]];
                } else if (logicDirection === 'down' && index < addons.value.length - 1) {
                    [addons.value[index], addons.value[index + 1]] = [addons.value[index + 1], addons.value[index]];
                } else if (logicDirection === 'top' && index > 0) {
                    addons.value.splice(index, 1);
                    addons.value.unshift(item);
                } else if (logicDirection === 'bottom' && index < addons.value.length - 1) {
                    addons.value.splice(index, 1);
                    addons.value.push(item);
                }
                
                logAction('addon_move', { name: item.manifest.name, direction: displayDirection });
            };

            const moveUp = (addon) => moveAddon(addon, 'up', 'su');
            const moveDown = (addon) => moveAddon(addon, 'down', 'gi√π');
            const moveTop = (addon) => moveAddon(addon, 'top', 'in cima');
            const moveBottom = (addon) => moveAddon(addon, 'bottom', 'in fondo');

            const removeAddon = (addon) => {
                // MODIFICATO: Usa la traduzione per confirm
                if(confirm(t.value('addon.removeConfirm', { name: addon.manifest.name }))) { 
                    recordHistory();
                    const index = addons.value.indexOf(addon);
                    if (index > -1) { addons.value.splice(index, 1); successMessage.value = "Addon rimosso. Clicca su SALVA."; logAction('addon_remove', { name: addon.manifest.name }); }
                }
            };

            const saveOrder = async () => {
                const enabledAddons = addons.value.filter(a => a.isEnabled);
                const addonsToSave = enabledAddons.map(({ isEditing, newLocalName, status, isEnabled, ...rest }) => rest);
                isLoading.value = true; error.value = null; successMessage.value = "Salvataggio in corso...";
                try {
                    const response = await fetch(`${apiBaseUrl}/api/set-addons`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ authKey: authKey.value, addons: addonsToSave, email: isMonitoring.value ? targetEmail.value : email.value }) });
                    const data = await response.json();
                    if (!response.ok || data.error) throw new Error(data.error || data.message || 'Errore salvataggio.');
                    successMessage.value = "üéâ Ordine addon salvato con successo!";
                    hasUnsavedChanges.value = false; history.value = []; redoStack.value = [];
                    logAction('addon_save_success');
                } catch (err) { error.value = "Salvataggio fallito: " + err.message; } finally { isLoading.value = false; }
            };

            const login = async () => {
                isLoading.value = true; error.value = null;
                try {
                    const response = await fetch(`${apiBaseUrl}/api/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email.value, password: password.value }) });
                    const data = await response.json(); if (!response.ok) throw new Error(data.message || 'Login fallito.');
                    
                    authKey.value = data.authKey; 
                    isLoggedIn.value = true;

                    // AGGIUNTO: Logica per caricare da URL dopo il login
                    if (importedConfigFromUrl.value) {
                        recordHistory();
                        addons.value = importedConfigFromUrl.value.map(mapAddon);
                        successMessage.value = t.value('import.urlSuccess', { count: addons.value.length });
                        hasUnsavedChanges.value = true;
                        history.value = []; // Pulisce la cronologia dopo l'import
                        logAction('backup_import_url', { count: addons.value.length });
                        importedConfigFromUrl.value = null; // Pulisci i dati importati
                    } else {
                        // Carica la configurazione normale dall'account
                        addons.value = data.addons.map(mapAddon);
                        hasUnsavedChanges.value = false; 
                        history.value = [];
                        logAction('login_success');
                    }

                } catch (err) { error.value = err.message; } finally { isLoading.value = false; }
            };

            const logout = () => {
                 // MODIFICATO: Usa la traduzione per confirm
                if (hasUnsavedChanges.value && !confirm(t.value('logoutConfirm'))) return;
                email.value = ''; password.value = ''; authKey.value = null; addons.value = [];
                isLoggedIn.value = false; isMonitoring.value = false; error.value = null;
                successMessage.value = null; showAdminInput.value = false; activityLogs.value = [];
                hasUnsavedChanges.value = false; history.value = []; redoStack.value = [];
            };

            const beforeUnloadHandler = (event) => { if (hasUnsavedChanges.value) { event.preventDefault(); event.returnValue = ''; } };
            // Aggiunto 'watch' all'import Vue
            onMounted(() => {
                window.addEventListener('beforeunload', beforeUnloadHandler);
                document.documentElement.lang = lang.value; // Imposta lingua iniziale
                document.title = t.value('meta.title'); // Imposta titolo iniziale

                // AGGIUNTO: Logica per leggere la config dall'URL al caricamento
                if (window.location.hash.startsWith('#config=')) {
                    const compressed = window.location.hash.substring(8); // Rimuove #config=
                    try {
                        // Usa LZString per decomprimere
                        const data = LZString.decompressFromEncodedURIComponent(compressed);
                        if (!data) throw new Error(t.value('import.urlErrorInvalid'));
                        
                        const importedData = JSON.parse(data);
                        if (Array.isArray(importedData)) {
                            importedConfigFromUrl.value = importedData; // Salva per usarlo DOPO il login
                            // Non impostare successMessage qui, ma dopo il login
                        }
                        window.location.hash = ''; // Pulisce l'hash per evitare ricaricamenti
                    } catch (e) {
                        error.value = "Errore importazione da URL: " + e.message;
                        window.location.hash = ''; // Pulisce l'hash
                    }
                }
            });
            onBeforeUnmount(() => window.removeEventListener('beforeunload', beforeUnloadHandler));
            
            return {
                email, password, authKey, addons, isLoggedIn, isLoading, error, successMessage, newAddonUrl, fileInput,
                adminClickCount, showAdminInput, adminKey, targetEmail, isMonitoring, activityLogs, isLoadingLogs,
                searchQuery, filteredAddons, login, logout, fetchLogs, formatLogTime, incrementAdminClick, monitorLogin,
                exportBackup, triggerFileInput, handleFileImport, checkAllAddonsStatus, addNewAddon, saveOrder,
                startEdit, finishEdit, moveUp, moveDown, moveTop, moveBottom, removeAddon,
                toggleAddonEnabled, openConfiguration, copyManifestUrl,
                hasUnsavedChanges, history, redoStack, undo, redo, activeFilter,
                draggableList, onDragEnd,
                // AGGIUNTI: 'lang' e 't' per la traduzione
                lang, t,
                // AGGIUNTI: Ref e funzioni per la condivisione URL
                shareUrl, shareInput, generateShareLink, copyShareLink, importedConfigFromUrl
            };
        }
    });

    app.component('draggable', window.vuedraggable);

    app.mount('#app');
</script>

</body>
</html>

